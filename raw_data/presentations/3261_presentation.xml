<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>In the Compression Hornet's Nest: A Security Study of Data Compression in Network Services</p>
    <p>Giancarlo Pellegrino(1), Davide Balzarotti(2), Stefan Winter(3), and Neeraj Suri(3)</p>
    <p>(1)Saarland University, Germany (2)EURECOM, France</p>
    <p>(3)TU Darmstadt, Germany</p>
  </div>
  <div class="page">
    <p>August 14, 2015 2</p>
    <p>Introduction</p>
    <p>Modern applications rely on (core) network services, e.g., Web, email, and IM services</p>
    <p>HTTP, json, XML, SOAP</p>
    <p>XMPP</p>
    <p>IMAP, POP3, SMTP</p>
  </div>
  <div class="page">
    <p>August 14, 2015 3</p>
    <p>Introduction</p>
    <p>Modern applications rely on (core) network services, e.g., web, email, and IM services  Amount of exchanged data continues to increase steadily</p>
    <p>More data  more transfer time  unresponsiveness  user unhappiness</p>
  </div>
  <div class="page">
    <p>August 14, 2015 4</p>
    <p>Introduction</p>
    <p>Modern applications rely on (core) network services, e.g., web, email, and IM services  Amount of exchanged data continues to increase steadily</p>
    <p>More data  more transfer time  unresponsiveness  user unhappiness</p>
    <p>A way to solve it is to buy more bandwidth</p>
  </div>
  <div class="page">
    <p>August 14, 2015 5</p>
    <p>Introduction</p>
    <p>Modern applications rely on (core) network services, e.g., web, email, and IM services  Amount of exchanged data continues to increase steadily</p>
    <p>More data  more transfer time  unresponsiveness  user unhappiness</p>
    <p>A way to solve it is to buy more bandwidth</p>
    <p>However, bandwidth costs</p>
  </div>
  <div class="page">
    <p>August 14, 2015 6</p>
    <p>Introduction</p>
    <p>Modern applications rely on (core) network services, e.g., web, email, and IM services  Amount of exchanged data continues to increase steadily</p>
    <p>More data  more transfer time  unresponsiveness  user unhappiness</p>
    <p>A way to solve it is to buy more bandwidth</p>
    <p>However, bandwidth costs</p>
    <p>Another solution is ...</p>
  </div>
  <div class="page">
    <p>August 14, 2015 7</p>
    <p>Introduction</p>
    <p>Modern applications rely on (core) network services, e.g., web, email, and IM services  Amount of exchanged data continues to increase steadily</p>
    <p>More data  more transfer time  unresponsiveness  user unhappiness</p>
    <p>A way to solve it is to buy more bandwidth</p>
    <p>However, bandwidth costs</p>
    <p>Another solution is ...</p>
    <p>Data compression!Data compression!</p>
  </div>
  <div class="page">
    <p>August 14, 2015 8</p>
    <p>Data Compression</p>
    <p>Reduces # of bits of a string by removing redundancy  lossless if decompr(compr(d)) = d or lossy if decompr(compr(d)) ~= d</p>
    <p>Lots of algorithms (See [1])</p>
    <p>Among the most popular: Deflate [RFC 1951]  Implemented in libraries, e.g., zlib, or as a tool, e.g., gzip, and zip archive tool</p>
    <p>Available in most of the programming languages</p>
    <p>[1] SALOMON, D. Data Compression: The Complete Reference. Springer-Verlang, 2007.</p>
  </div>
  <div class="page">
    <p>August 14, 2015 9</p>
    <p>Compression in Protocols</p>
    <p>Data compression is used by network protocols to reduce message size  Mandated by protocol specifications</p>
    <p>e.g., HTTP (response) compression, IMAP, XMPP, SSH, PPP, and others</p>
    <p>Or implemented as custom feature  e.g., HTTP request compression</p>
    <p>HTTP Compression [RFC 2616, 7230]</p>
    <p>XMPP Compression [XEP-0138]</p>
    <p>IMAP Compression [RFC 4978]</p>
  </div>
  <div class="page">
    <p>August 14, 2015 10</p>
    <p>The Problem of Data Compression</p>
    <p>If not properly implemented, it can make application vulnerable to DoS</p>
    <p>Risks:</p>
    <p>Popular examples from the past...</p>
  </div>
  <div class="page">
    <p>August 14, 2015 11</p>
    <p>The Past: Zip Bombs (1996)</p>
    <p>42 KB zip file  4.5 PB uncompressed data</p>
    <p>5 layers of nested zip files in blocks of 16, last layer with text files of 4.3 GB each</p>
    <p>Cause Disk/Memory exhaustion</p>
    <p>Sent as attachment to crash anti-virus software 0.dll 1.dll 16.dll...</p>
    <p>page0.zip</p>
    <p>doc0.zip</p>
    <p>chapter0.zip</p>
    <p>book0.zip</p>
    <p>lib0.zip</p>
    <p>page1.zip page16.zip</p>
    <p>lib1.zip lib16.zip...</p>
    <p>doc1.zip doc16.zip...</p>
    <p>...</p>
    <p>chapter2.zip chapter16.zip...</p>
    <p>book2.zip book16.zip...</p>
    <p>AAAAAAAAAA ... A</p>
  </div>
  <div class="page">
    <p>August 14, 2015 12</p>
    <p>The Past: Billion Laughs (2003)</p>
    <p>Resource exhaustion in libxml2 when processing nested XML entity definitions</p>
    <p>810 bytes of XML document expanded to 3GB</p>
    <p>&lt;?xml version=&quot;1.0&quot;?&gt; &lt;!DOCTYPE lolz [ &lt;!ENTITY lol &quot;lol&quot;&gt; &lt;!ELEMENT lolz (#PCDATA)&gt; &lt;!ENTITY lol1 &quot;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&quot;&gt; &lt;!ENTITY lol2 &quot;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&quot;&gt; &lt;!ENTITY lol3 &quot;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&quot;&gt; &lt;!ENTITY lol4 &quot;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&quot;&gt; &lt;!ENTITY lol5 &quot;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&quot;&gt; &lt;!ENTITY lol6 &quot;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&quot;&gt; &lt;!ENTITY lol7 &quot;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&quot;&gt; &lt;!ENTITY lol8 &quot;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&quot;&gt; &lt;!ENTITY lol9 &quot;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&quot;&gt; ]&gt; &lt;lolz&gt;&amp;lol9;&lt;/lolz&gt;</p>
  </div>
  <div class="page">
    <p>August 14, 2015 13</p>
    <p>The Past: Zip Bombs and Billion Laughs</p>
    <p>&lt;?xml version=&quot;1.0&quot;?&gt; &lt;!DOCTYPE lolz [ &lt;!ENTITY lol &quot;lol&quot;&gt; &lt;!ELEMENT lolz (#PCDATA)&gt; &lt;!ENTITY lol1 &quot;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&quot;&gt; &lt;!ENTITY lol2 &quot;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&quot;&gt; &lt;!ENTITY lol3 &quot;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&quot;&gt; &lt;!ENTITY lol4 &quot;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&quot;&gt; &lt;!ENTITY lol5 &quot;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&quot;&gt; &lt;!ENTITY lol6 &quot;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&quot;&gt; &lt;!ENTITY lol7 &quot;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&quot;&gt; &lt;!ENTITY lol8 &quot;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&quot;&gt; &lt;!ENTITY lol9 &quot;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&quot;&gt; ]&gt; &lt;lolz&gt;&amp;lol9;&lt;/lolz&gt;</p>
    <p>page0.zip</p>
    <p>doc0.zip</p>
    <p>chapter0.zip</p>
    <p>book0.zip</p>
    <p>lib0.zip</p>
    <p>page1.zip page16.zip</p>
    <p>lib1.zip lib16.zip...</p>
    <p>doc1.zip doc16.zip...</p>
    <p>...</p>
    <p>chapter2.zip chapter16.zip...</p>
    <p>book2.zip book16.zip...</p>
    <p>AAAAAAAAAA ... A</p>
    <p>This was 1996-2003! Now we know better, right?</p>
    <p>This was 1996-2003! Now we know better, right?</p>
  </div>
  <div class="page">
    <p>August 14, 2015 14</p>
    <p>The Present</p>
    <p>Reviewed protocol specs, design patterns, and coding rules Unawareness of the risks, guidelines on handling data compression are missing or misleading</p>
  </div>
  <div class="page">
    <p>August 14, 2015 15</p>
    <p>The Present</p>
    <p>Reviewed protocol specs, design patterns, and coding rules Unawareness of the risks, guidelines on handling data compression are missing or misleading</p>
    <p>unexplained how they apply to other protocols)</p>
  </div>
  <div class="page">
    <p>August 14, 2015 16</p>
    <p>The Present</p>
    <p>Reviewed protocol specs, design patterns, and coding rules Unawareness of the risks, guidelines on handling data compression are missing or misleading</p>
    <p>unexplained how they apply to other protocols)</p>
    <p>However, lack of the details to address implementation-level concerns</p>
  </div>
  <div class="page">
    <p>August 14, 2015 17</p>
    <p>The Present</p>
    <p>Reviewed protocol specs, design patterns, and coding rules Unawareness of the risks, guidelines on handling data compression are missing or misleading</p>
    <p>unexplained how they apply to other protocols)</p>
    <p>However, lack of the details to address implementation-level concerns</p>
    <p>Sadly, incorrect</p>
  </div>
  <div class="page">
    <p>August 14, 2015 18</p>
    <p>The Present</p>
    <p>Reviewed protocol specs, design patterns, and coding rules Unawareness of the risks, guidelines on handling data compression are missing or misleading</p>
    <p>unexplained how they apply to other protocols)</p>
    <p>However, lack of the details to address implementation-level concerns</p>
    <p>Sadly, incorrect</p>
    <p>How does this lack of common knowledge and</p>
    <p>understanding affect implementations?</p>
    <p>How does this lack of common knowledge and</p>
    <p>understanding affect implementations?</p>
  </div>
  <div class="page">
    <p>August 14, 2015 19</p>
    <p>Our contribution</p>
  </div>
  <div class="page">
    <p>August 14, 2015 20</p>
    <p>Contents</p>
    <p>Mistakes in software</p>
    <p>Testing for resource exhaustion vulnerabilities</p>
  </div>
  <div class="page">
    <p>August 14, 2015 21</p>
    <p>Mistakes in Software</p>
  </div>
  <div class="page">
    <p>August 14, 2015 22</p>
    <p>Case Studies</p>
    <p>11 popular services with 10 extensions  Selected via service detection of top 1000 of AlexaDB and of public IM services</p>
    <p>Analyzed specifications, documentation, and source code  Observed 12 pitfalls...</p>
    <p>Protocol Network Service</p>
    <p>XMPP OpenFire, Prosody. Jabberd2, ejabberd, Tigase</p>
    <p>HTTP Apache HTTPD + mod_deflate + mod-php + CSJRPC + mod-gsoap + mod-dav</p>
    <p>Apache Tomcat + 2Way/Webutilities + Apache CXF + (lib-)json-rpc + jsonrpc4j + Axis2</p>
    <p>Axis 2 standalone</p>
    <p>gSOAP standalone</p>
    <p>IMAP Dovecot, Cyrus</p>
  </div>
  <div class="page">
    <p>August 14, 2015 23</p>
    <p>Pitfalls</p>
  </div>
  <div class="page">
    <p>August 14, 2015 24</p>
    <p>Pitfalls</p>
    <p>Use of Compression before Authentication  Improper Input Validation during Decompression  Logging Decompressed Messages  Improper Inter-Units Communication  Unbounded Resource Usage (CPU and Memory)</p>
    <p>Erroneous Best Practice  Misleading Documentation  API Specs Inconsistency</p>
    <p>Insufficient Configuration Options  Insecure Default Values  Decentralized Configuration Parameters</p>
  </div>
  <div class="page">
    <p>August 14, 2015 25</p>
    <p>Pitfalls</p>
    <p>Use of Compression before Authentication  Improper Input Validation during Decompression  Logging Decompressed Messages  Improper Inter-Units Communication  Unbounded Resource Usage (CPU and Memory)</p>
    <p>Erroneous Best Practice  Misleading Documentation  API Specs Inconsistency</p>
    <p>Insufficient Configuration Options  Insecure Default Values  Decentralized Configuration Parameters</p>
  </div>
  <div class="page">
    <p>August 14, 2015 26</p>
    <p>Pitfalls at Implementation level</p>
    <p>Valid. Decompr. Parser</p>
    <p>Logger</p>
    <p>Appl.M</p>
    <p>evt evt evt</p>
    <p>Authn.</p>
    <p>evt</p>
    <p>Abstract message processing pipeline extracted from our case studies</p>
  </div>
  <div class="page">
    <p>August 14, 2015 27</p>
    <p>Compression before Authentication</p>
    <p>Inconsistent best practice  Mandatory in SSL/TLS, recommended in XMPP, and undefined in IMAP and HTTP</p>
    <p>Implementation may diverge from the specs, i.e., OpenSSH</p>
    <p>Developers may underestimate the risk or overlook recommendations  Prosody accepted compressed messages before user authentication</p>
    <p>DoS by unauthenticated attackers</p>
    <p>Valid. Decompr. Parser</p>
    <p>Logger</p>
    <p>Appl.M</p>
    <p>evt evt evt</p>
    <p>Authn.</p>
    <p>evt</p>
    <p>CVE-2014-2744</p>
  </div>
  <div class="page">
    <p>August 14, 2015 28</p>
    <p>Improper Input Validation during Decompression</p>
    <p>3 ways to validate a message:  Compressed message size</p>
    <p>mod-deflate: If (compr. size &gt; LimitRequestBody)  Reject</p>
    <p>However, hard to assess message size from its compressed form (1 MB compr  1 GB decompr.)</p>
    <p>Valid. Decompr. Parser</p>
    <p>Logger</p>
    <p>Appl.M</p>
    <p>evt evt evt</p>
    <p>Authn.</p>
    <p>evt</p>
    <p>CVE-2014-0118</p>
    <p>mista ke</p>
  </div>
  <div class="page">
    <p>August 14, 2015 29</p>
    <p>Improper Input Validation during Decompression</p>
    <p>3 ways to validate a message:  Compressed message size</p>
    <p>mod-deflate: If (compr. size &gt; LimitRequestBody)  Reject</p>
    <p>However, hard to assess message size from its compressed form (1 MB compr  1 GB decompr.)</p>
    <p>Decompression ratio  Patched mod-deflate: if (decompr ratio &gt; threshold)  Reject</p>
    <p>Problem of ratio selection</p>
    <p>Valid. Decompr. Parser</p>
    <p>Logger</p>
    <p>Appl.M</p>
    <p>evt evt evt</p>
    <p>Authn.</p>
    <p>evt</p>
    <p>CVE-2014-0118</p>
    <p>mista ke</p>
    <p>risky</p>
  </div>
  <div class="page">
    <p>August 14, 2015 30</p>
    <p>Improper Input Validation during Decompression</p>
    <p>3 ways to validate a message:  Compressed message size</p>
    <p>mod-deflate: If (compr. size &gt; LimitRequestBody)  Reject</p>
    <p>However, hard to assess message size from its compressed form (1 MB compr  1 GB decompr.)</p>
    <p>Decompression ratio  Patched mod-deflate: if (decompr ratio &gt; threshold)  Reject</p>
    <p>Problem of ratio selection</p>
    <p>Decompressed message size  mod-deflate + mod-dav: If (decompr. size &gt; LimitXMLRequestBody)  Reject</p>
    <p>Valid. Decompr. Parser</p>
    <p>Logger</p>
    <p>Appl.M</p>
    <p>evt evt evt</p>
    <p>Authn.</p>
    <p>evt</p>
    <p>mista ke</p>
    <p>corre ct</p>
    <p>risky</p>
    <p>CVE-2014-0118</p>
  </div>
  <div class="page">
    <p>August 14, 2015 31</p>
    <p>Improper Inter-Units Communication</p>
    <p>Upon exception, the pipeline halts and rejects message  mod-php and mod-gsoap limit the size of incoming (decompressed) message   but had no means to halt mod-deflate</p>
    <p>mod-deflate keeps on decompressing data</p>
    <p>Problem addressed in</p>
    <p>Valid. Decompr. Parser</p>
    <p>Logger</p>
    <p>Appl.M</p>
    <p>evt evt evt</p>
    <p>Authn.</p>
    <p>evt</p>
    <p>CVE-2014-0118</p>
  </div>
  <div class="page">
    <p>August 14, 2015 32</p>
    <p>Logging Decompressed Messages</p>
    <p>Frequency and verbosity of log events can cause DoS  If exception is caused by compressed data, the needed resources may be</p>
    <p>underestimated  Upon invalid requests, Apache CXF logs first 100KB of incoming message</p>
    <p>However, first it decompresses the entire message on a file, then logs the first 100KB</p>
    <p>DoS due to disk space exhaustion</p>
    <p>Valid. Decompr. Parser</p>
    <p>Logger</p>
    <p>Appl.M</p>
    <p>evt evt evt</p>
    <p>Authn.</p>
    <p>evt</p>
    <p>CVE-2014-0109/ -0110</p>
  </div>
  <div class="page">
    <p>August 14, 2015 33</p>
    <p>Erroneous Best Practices (Spec. level)</p>
    <p>Only one code pattern specific for data compression  Rule: IDS04-J. Safely extract files from ZipInputStream</p>
    <p>.getSize() returns ZIP file header with uncompressed size</p>
    <p>but ZIP headers can be forged  DoS countermeasure bypass</p>
    <p>// Write the files to the disk, but // only if the file is not insanely big if (zipfile.getSize() &gt; TOOBIG ) { throw new IllegalStateException(&quot;File to be unzipped is huge.&quot;); }</p>
    <p>Notif. Authors</p>
  </div>
  <div class="page">
    <p>August 14, 2015 34</p>
    <p>Resource exhaustion vulnerabilities</p>
  </div>
  <div class="page">
    <p>August 14, 2015 35</p>
    <p>Experiments</p>
    <p>Case studies on local servers</p>
    <p>Testbed:</p>
    <p>Internal Monitor</p>
    <p>Implementation</p>
    <p>Linux 3.8 Kernel</p>
    <p>/proc</p>
    <p>External monitor</p>
    <p>Attackers</p>
    <p>Compression bombs</p>
  </div>
  <div class="page">
    <p>August 14, 2015 36</p>
    <p>HTTP Compression Bomb (SOAP)</p>
    <p>Case studies on local servers</p>
    <p>Testbed:</p>
    <p>Internal Monitor</p>
    <p>Implementation</p>
    <p>Linux 3.8 Kernel</p>
    <p>/proc</p>
    <p>External monitor</p>
    <p>Attackers</p>
    <p>Compression bombs ~4 MB, ~1:1000 compr. ratio</p>
    <p>POST /index.html HTTP/1.1 ContentEncoding: gzip \r\n &lt;soapenv:Envelope&gt;</p>
    <p>&lt;soapenv:Body&gt;[...]&lt;/soapenv:Body&gt; &lt;/soapenv:Envelope&gt; \r\n</p>
    <p>compressed</p>
  </div>
  <div class="page">
    <p>August 14, 2015 37</p>
    <p>Zip Bombs Everywhere</p>
    <p>Protocol Network Service</p>
    <p>XMPP OpenFire</p>
    <p>Prosody</p>
    <p>Tigase</p>
    <p>Ejabberd, jabberd2</p>
    <p>HTTP Apache HTTPD + mod_deflate</p>
    <p>+ mod-php, CSJRPC, mod-gsoap, mod-dav</p>
    <p>Apache Tomcat + 2Way/Webutilities filter</p>
    <p>+ Apache CXF</p>
    <p>+ json-rpc, lib-json-rpc</p>
    <p>+ Axis2/ +jsonrpc4j</p>
    <p>Axis 2 standalone</p>
    <p>gSOAP standalone</p>
    <p>IMAP Dovecot, Cyrus</p>
    <p>CVE-2014-2741</p>
    <p>CVE-2014-2746</p>
    <p>CVE-2014-0118</p>
    <p>Notif. devel</p>
    <p>Notif. devels</p>
    <p>CVE-2014-2744/ -2745</p>
    <p>CVE-2014-0109/ -0110</p>
    <p>Notif. devel</p>
  </div>
  <div class="page">
    <p>August 14, 2015 38</p>
    <p>Conclusion</p>
  </div>
  <div class="page">
    <p>August 14, 2015 39</p>
    <p>Conclusion/Takeaway</p>
    <p>~20 years after the zip bombs, developers still unaware of the risks of handling data compression</p>
    <p>Discovered 10 previously-unknown vulns. in popular network services</p>
    <p>Presented 12 pitfalls which can be used by developers to build more secure services</p>
  </div>
</Presentation>
