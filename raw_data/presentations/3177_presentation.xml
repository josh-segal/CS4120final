<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>Never Been KIST: Tors Congestion Management Blossoms with KernelInformed Socket Transport</p>
    <p>Rob Jansen US Naval Research Laboratory John Geddes University of Minnesota Chris Wacek Georgetown University Micah Sherr Georgetown University Paul Syverson US Naval Research Laboratory</p>
  </div>
  <div class="page">
    <p>Anonymous Communication: Tor</p>
  </div>
  <div class="page">
    <p>Tor is Slow!!! Research*  PCTCP: Per-Circuit TCP-over-IPsec Transport for Anonymous Communication</p>
    <p>Overlay Networks (CCS 13)</p>
    <p>Reducing Latency in Tor Circuits with Unordered Delivery (FOCI 13)</p>
    <p>How Low Can You Go: Balancing Performance with Anonymity in Tor (PETS 13)</p>
    <p>The Path Less Travelled: Overcoming Tor's Bottlenecks with Traffic Splitting (PETS 13)</p>
    <p>An Empirical Evaluation of Relay Selection in Tor (NDSS 13)</p>
    <p>LIRA: Lightweight Incentivized Routing for Anonymity (NDSS 13)</p>
    <p>Improving Performance and Anonymity in the Tor Network (IPCCC 12)</p>
    <p>Enhancing Tor's Performance using Real-time Traffic Classification (CCS 12)</p>
    <p>Torchestra: Reducing interactive traffic delays over Tor (WPES 12)</p>
    <p>Throttling Tor Bandwidth Parasites (USENIX Sec 12)</p>
    <p>LASTor: A Low-Latency AS-Aware Tor Client (Oakland 12)</p>
    <p>Congestion-aware Path Selection for Tor (FC 12) *Not a comprehensive list</p>
  </div>
  <div class="page">
    <p>Tor is Slow!!! Research*</p>
    <p>*Not a comprehensive list</p>
    <p>Where?</p>
  </div>
  <div class="page">
    <p>This Talk</p>
    <p>Where is Tor slow?  Measure public Tor and private Shadow-Tor networks  Identify circuit scheduling and socket flushing problems</p>
    <p>Design KIST: Kernel-Informed Socket Transport  Use TCP snd_cwnd to limit socket writes</p>
    <p>Evaluate KIST Performance and Security  Reduces kernel and end-to-end circuit congestion  Throughput attacks unaffected, speeds up latency attacks</p>
  </div>
  <div class="page">
    <p>Outline</p>
    <p>Background</p>
    <p>Instrument Tor, measure congestion</p>
    <p>Analyze causes of congestion</p>
    <p>Design and evaluate KIST  Performance  Security</p>
  </div>
  <div class="page">
    <p>Relay Overview</p>
  </div>
  <div class="page">
    <p>Relay Overview</p>
    <p>TCP</p>
    <p>TCP</p>
    <p>TCP</p>
    <p>TCP</p>
    <p>TCP</p>
    <p>TCP</p>
    <p>TCP</p>
    <p>Tor circuits are multiplexed over a</p>
    <p>TCP transport</p>
  </div>
  <div class="page">
    <p>Relay Overview</p>
    <p>TCP</p>
    <p>TCP</p>
    <p>TCP</p>
    <p>TCP</p>
    <p>TCP</p>
    <p>TCP TCP</p>
  </div>
  <div class="page">
    <p>Relay Internals Kernel Input Kernel Output Tor Input Tor Output</p>
    <p>Tor Circuits</p>
    <p>Opportunities for traffic</p>
    <p>management</p>
  </div>
  <div class="page">
    <p>Outline</p>
    <p>Background</p>
    <p>Instrument Tor, measure congestion</p>
    <p>Analyze causes of congestion</p>
    <p>Design and evaluate KIST  Performance  Security</p>
  </div>
  <div class="page">
    <p>Live Tor Congestion - libkqtime Kernel Input Kernel Output Tor Input Tor Output</p>
    <p>Tor Circuits</p>
  </div>
  <div class="page">
    <p>Live Tor Congestion - libkqtime Kernel Input Kernel Output Tor Input Tor Output</p>
    <p>Tor Circuits</p>
    <p>tag match tag match</p>
  </div>
  <div class="page">
    <p>Live Tor Congestion - libkqtime Kernel Input Kernel Output Tor Input Tor Output</p>
    <p>Tor Circuits</p>
    <p>tag match tag match track cells</p>
  </div>
  <div class="page">
    <p>Shadow Network Simulation</p>
    <p>Enhanced Shadow with several missing TCP algorithms</p>
    <p>CUBIC congestion control  Retransmission timers  Selective acknowledgements (SACK)  Forward acknowledgements (FACK)  Fast retransmit/recovery</p>
    <p>Designed largest known private Tor network  3600 relays and 12000 simultaneously active clients  Internet topology graph: ~700k nodes and 1.3m links</p>
  </div>
  <div class="page">
    <p>Track the UID</p>
    <p>Shadow-Tor Congestion  UIDs UID</p>
    <p>UID Track the UID</p>
  </div>
  <div class="page">
    <p>Track the UID</p>
    <p>Shadow-Tor Congestion  UIDs UID</p>
    <p>UID Track the UID</p>
    <p>Kernel Input Kernel Output Tor Input</p>
    <p>Tor Output</p>
    <p>Tor Circuits</p>
  </div>
  <div class="page">
    <p>Tor and Shadow-Tor Congestion</p>
    <p>Time (ms)</p>
    <p>C um</p>
    <p>ul at</p>
    <p>iv e</p>
    <p>Fr ac</p>
    <p>tio n</p>
    <p>kernel in</p>
    <p>tor</p>
    <p>kernel out</p>
    <p>Time (ms)</p>
    <p>C um</p>
    <p>ul at</p>
    <p>iv e</p>
    <p>Fr ac</p>
    <p>tio n</p>
    <p>kernel in</p>
    <p>tor</p>
    <p>kernel out</p>
    <p>Congestion occurs almost exclusively in outbound kernel buffers</p>
    <p>Shadow-Tor Live-Tor</p>
  </div>
  <div class="page">
    <p>Outline</p>
    <p>Background</p>
    <p>Instrument Tor, measure congestion</p>
    <p>Analyze causes of congestion</p>
    <p>Design and evaluate KIST  Performance  Security</p>
  </div>
  <div class="page">
    <p>Analyzing Causes of Congestion</p>
    <p>Kernel Output Tor Output Tor Circuits</p>
    <p>Queuing delays in kernel output buffer</p>
  </div>
  <div class="page">
    <p>Analyzing Causes of Congestion</p>
    <p>Kernel Output Tor Output Tor Circuits</p>
    <p>Queuing delays in kernel output buffer</p>
    <p>Problem 1: Circuit scheduling</p>
    <p>Problem 2: Flushing to Sockets</p>
  </div>
  <div class="page">
    <p>Problem 1: Circuit Scheduling</p>
    <p>Kernel Output Tor Output Tor Circuits</p>
    <p>Libevent schedules one connection at a time</p>
  </div>
  <div class="page">
    <p>Problem 1: Circuit Scheduling</p>
    <p>Kernel Output Tor Output Tor Circuits</p>
    <p>Libevent schedules one connection at a time</p>
    <p>Tor only considers a subset of writable</p>
    <p>circuits</p>
  </div>
  <div class="page">
    <p>Problem 1: Circuit Scheduling</p>
    <p>Kernel Output Tor Output Tor Circuits</p>
    <p>Libevent schedules one connection at a time</p>
    <p>Tor only considers a subset of writable</p>
    <p>circuits</p>
    <p>Circuits from different connections are not prioritized correctly</p>
  </div>
  <div class="page">
    <p>Problem 1: Circuit Scheduling</p>
  </div>
  <div class="page">
    <p>Problem 1: Circuit Scheduling</p>
    <p>C um</p>
    <p>ul at</p>
    <p>iv e</p>
    <p>Fr ac</p>
    <p>tio n</p>
    <p>D E</p>
    <p>T E</p>
    <p>R</p>
    <p>pri+</p>
    <p>rr</p>
    <p>pri</p>
    <p>S hadow</p>
    <p>C um</p>
    <p>ul at</p>
    <p>iv e</p>
    <p>Fr ac</p>
    <p>tio n</p>
    <p>D E</p>
    <p>T E</p>
    <p>R pri+</p>
    <p>rr</p>
    <p>pri</p>
    <p>S hadow</p>
    <p>Correctly differentiated No differentiation</p>
  </div>
  <div class="page">
    <p>Problem 1: Circuit Scheduling</p>
    <p>C um</p>
    <p>ul at</p>
    <p>iv e</p>
    <p>Fr ac</p>
    <p>tio n</p>
    <p>D E</p>
    <p>T E</p>
    <p>R</p>
    <p>pri+</p>
    <p>rr</p>
    <p>pri</p>
    <p>S hadow</p>
    <p>C um</p>
    <p>ul at</p>
    <p>iv e</p>
    <p>Fr ac</p>
    <p>tio n</p>
    <p>D E</p>
    <p>T E</p>
    <p>R pri+</p>
    <p>rr</p>
    <p>pri</p>
    <p>S hadow</p>
    <p>Correctly differentiated No differentiation</p>
  </div>
  <div class="page">
    <p>Problem 2: Flushing to Sockets</p>
    <p>Kernel Output Tor Output Tor Circuits</p>
    <p>Queuing delays in kernel output buffer</p>
    <p>FIFO</p>
  </div>
  <div class="page">
    <p>Problem 2: Flushing to Sockets</p>
    <p>Kernel Output Tor Output Tor Circuits</p>
    <p>Worse priority traffic (high throughput flows) FIFO</p>
  </div>
  <div class="page">
    <p>Problem 2: Flushing to Sockets</p>
    <p>Kernel Output Tor Output Tor Circuits</p>
    <p>Better priority traffic (low throughput flows)</p>
    <p>Worse priority traffic (high throughput flows) FIFO</p>
  </div>
  <div class="page">
    <p>Problem 2: Flushing to Sockets</p>
    <p>Kernel Output Tor Output Tor Circuits</p>
    <p>Better priority traffic (low throughput flows)</p>
    <p>Must wait for kernel to flush socket to network (blocked</p>
    <p>on TCP cwnd)</p>
    <p>Worse priority traffic (high throughput flows) FIFO</p>
  </div>
  <div class="page">
    <p>Problem 2: Flushing to Sockets</p>
    <p>Kernel Output Tor Output Tor Circuits</p>
    <p>Better priority traffic (low throughput flows)</p>
    <p>Reduces effectiveness of circuit priority</p>
    <p>Worse priority traffic (high throughput flows) FIFO</p>
  </div>
  <div class="page">
    <p>Outline</p>
    <p>Background</p>
    <p>Instrument Tor, measure congestion</p>
    <p>Analyze causes of congestion</p>
    <p>Design and evaluate KIST  Performance  Security</p>
  </div>
  <div class="page">
    <p>Ask the kernel, stupid!</p>
    <p>Utilize getsockopt and ioctl syscalls</p>
    <p>socket_space = sndbufcap  sndbuflen</p>
    <p>tcp_space = (cwnd  unacked) * mss</p>
    <p>sndbuflen</p>
    <p>sndbufcap</p>
    <p>unacked</p>
    <p>cwnd</p>
  </div>
  <div class="page">
    <p>Kernel-Informed Socket Transport</p>
    <p>Dont write it if the kernel cant send it; bound kernel writes by:</p>
    <p>Socket: min(socket_space, tcp_space)  Global: upstream bandwidth capacity</p>
    <p>Solution to Problem 2</p>
  </div>
  <div class="page">
    <p>Kernel-Informed Socket Transport</p>
    <p>Dont write it if the kernel cant send it; bound kernel writes by:</p>
    <p>Socket: min(socket_space, tcp_space)  Global: upstream bandwidth capacity</p>
    <p>Choose globally from all writable circuits</p>
    <p>Solution to Problem 1</p>
  </div>
  <div class="page">
    <p>Kernel-Informed Socket Transport</p>
    <p>Dont write it if the kernel cant send it; bound kernel writes by:</p>
    <p>Socket: min(socket_space, tcp_space)  Global: upstream bandwidth capacity</p>
    <p>Choose globally from all writable circuits</p>
    <p>Try to write again before kernel starvation</p>
  </div>
  <div class="page">
    <p>KIST Reduces Kernel Congestion</p>
    <p>Time (ms)</p>
    <p>um ul</p>
    <p>at iv</p>
    <p>e Fr</p>
    <p>ac tio</p>
    <p>n</p>
    <p>vanilla</p>
    <p>global</p>
    <p>KIST</p>
  </div>
  <div class="page">
    <p>KIST Increases Tor Congestion</p>
    <p>Time (ms)</p>
    <p>um ul</p>
    <p>at iv</p>
    <p>e Fr</p>
    <p>ac tio</p>
    <p>n</p>
    <p>vanilla</p>
    <p>global</p>
    <p>KIST</p>
  </div>
  <div class="page">
    <p>KIST Reduces Circuit Congestion</p>
    <p>um ul</p>
    <p>at iv</p>
    <p>e Fr</p>
    <p>ac tio</p>
    <p>n</p>
    <p>vanilla</p>
    <p>global</p>
    <p>KIST</p>
  </div>
  <div class="page">
    <p>KIST Improves Network Latency</p>
    <p>um ul</p>
    <p>at iv</p>
    <p>e Fr</p>
    <p>ac tio</p>
    <p>n</p>
    <p>vanilla</p>
    <p>global</p>
    <p>KIST</p>
  </div>
  <div class="page">
    <p>Outline</p>
    <p>Background</p>
    <p>Instrument Tor, measure congestion</p>
    <p>Analyze causes of congestion</p>
    <p>Design and evaluate KIST  Performance  Security</p>
  </div>
  <div class="page">
    <p>Traffic Correlation: Latency</p>
    <p>Hopper et.al. CCS07</p>
    <p>Goal: narrow down potential locations of the client on a target circuit</p>
  </div>
  <div class="page">
    <p>Traffic Correlation: Latency</p>
    <p>Hopper et.al. CCS07</p>
    <p>-Inject redirect or javascript -Start timer</p>
  </div>
  <div class="page">
    <p>Traffic Correlation: Latency</p>
    <p>GET</p>
    <p>Hopper et.al. CCS07</p>
    <p>Request redirected page or embedded object</p>
  </div>
  <div class="page">
    <p>Traffic Correlation: Latency</p>
    <p>GET</p>
    <p>Hopper et.al. CCS07</p>
    <p>-Stop timer -Estimate latency</p>
  </div>
  <div class="page">
    <p>Latency Attack | estimate  actual |</p>
    <p>um ul</p>
    <p>at iv</p>
    <p>e Fr</p>
    <p>ac tio</p>
    <p>n</p>
    <p>vanilla</p>
    <p>KIST</p>
  </div>
  <div class="page">
    <p>Latency Attack num pings until best estimate</p>
    <p>um ul</p>
    <p>at iv</p>
    <p>e Fr</p>
    <p>ac tio</p>
    <p>n</p>
    <p>vanilla</p>
    <p>KIST</p>
  </div>
  <div class="page">
    <p>Traffic Correlation: Throughput</p>
    <p>Mittal et.al. CCS11</p>
    <p>Goal: find guard relay of the client on a target circuit</p>
  </div>
  <div class="page">
    <p>Traffic Correlation: Throughput</p>
    <p>Mittal et.al. CCS11</p>
    <p>Probe throughput of all guard relays</p>
  </div>
  <div class="page">
    <p>Traffic Correlation: Throughput</p>
    <p>Mittal et.al. CCS11</p>
    <p>Correlate throughput between</p>
    <p>exit and probes</p>
  </div>
  <div class="page">
    <p>Throughput Attack Results</p>
    <p>0.40.30.20.1 0.0 0.1 0.2 0.3 0.4 0.5 Correlation Score</p>
    <p>um ul</p>
    <p>at iv</p>
    <p>e Fr</p>
    <p>ac tio</p>
    <p>n</p>
    <p>vanilla</p>
    <p>KIST</p>
  </div>
  <div class="page">
    <p>Conclusion</p>
    <p>Where is Tor slow?</p>
    <p>KIST complements other performance enhancements, e.g. circuit priority</p>
    <p>Next steps  Currently exploring various algorithmic optimizations  Test KIST in the wild and deploy in Tor</p>
  </div>
  <div class="page">
    <p>Questions?</p>
    <p>rob.g.jansen@nrl.navy.mil robgjansen.com</p>
    <p>github.com/robgjansen/libkqtime github.com/shadow</p>
    <p>think like an adversary</p>
  </div>
  <div class="page">
    <p>Relay Internals Kernel Input Kernel Output Tor Input Tor Output</p>
    <p>Tor Circuits</p>
    <p>Network Input</p>
  </div>
  <div class="page">
    <p>Relay Internals Kernel Input Kernel Output Tor Input Tor Output</p>
    <p>Tor Circuits</p>
    <p>Split data into socket buffers</p>
  </div>
  <div class="page">
    <p>Relay Internals Kernel Input Kernel Output Tor Input Tor Output</p>
    <p>Tor Circuits</p>
    <p>Read data from sockets into Tor</p>
  </div>
  <div class="page">
    <p>Relay Internals Kernel Input Kernel Output Tor Input Tor Output</p>
    <p>Tor Circuits</p>
    <p>Process data (encrypt/decrypt)</p>
  </div>
  <div class="page">
    <p>Relay Internals Kernel Input Kernel Output Tor Input Tor Output</p>
    <p>Tor Circuits</p>
    <p>Split cells into circuit queues</p>
  </div>
  <div class="page">
    <p>Relay Internals Kernel Input Kernel Output Tor Input Tor Output</p>
    <p>Tor Circuits</p>
    <p>Circuits linked to outgoing connection</p>
  </div>
  <div class="page">
    <p>Relay Internals Kernel Input Kernel Output Tor Input Tor Output</p>
    <p>Tor Circuits</p>
    <p>Schedule cells</p>
  </div>
  <div class="page">
    <p>Relay Internals Kernel Input Kernel Output Tor Input Tor Output</p>
    <p>Tor Circuits</p>
    <p>Write data from Tor into sockets</p>
  </div>
  <div class="page">
    <p>Relay Internals Kernel Input Kernel Output Tor Input Tor Output</p>
    <p>Tor Circuits</p>
    <p>Schedule data for sending</p>
  </div>
  <div class="page">
    <p>Relay Internals Kernel Input Kernel Output Tor Input Tor Output</p>
    <p>Tor Circuits</p>
    <p>Opportunities for traffic</p>
    <p>management</p>
  </div>
  <div class="page">
    <p>KIST Improves Network Throughput</p>
    <p>um ul</p>
    <p>at iv</p>
    <p>e Fr</p>
    <p>ac tio</p>
    <p>n</p>
    <p>vanilla</p>
    <p>global</p>
    <p>KIST</p>
  </div>
</Presentation>
