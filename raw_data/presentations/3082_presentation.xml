<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>Behavioral Clustering of HTTP-based Malware and Signature Generation using</p>
    <p>Malicious Network Traces</p>
    <p>Roberto Perdisci(1,2), Wenke Lee(1,2), Nick Feamster(1)</p>
    <p>USENIX NSDI 2010</p>
    <p>(1) (2)</p>
  </div>
  <div class="page">
    <p>Malware = Malicious Software  Most modern cyber crimes are carried out using</p>
    <p>malicious software</p>
    <p>Spam, Identity Theft, DDoS...</p>
    <p>Many different types of malware  Trojans</p>
    <p>Bots</p>
    <p>Spyware</p>
    <p>Adware</p>
    <p>Scareware ...</p>
  </div>
  <div class="page">
    <p>Traditional AVs are not enough! AV scan Malware</p>
    <p>Benign</p>
    <p>Original Malware</p>
    <p>Hidden Malware</p>
    <p>Executable Packing</p>
    <p>(obfuscation)</p>
    <p>.exe</p>
  </div>
  <div class="page">
    <p>What can we do to detect malware?  Most malware need a network connection to perpetrate</p>
    <p>malicious activities</p>
    <p>Bots need to contact C&amp;C server, send spam, etc...</p>
    <p>Spyware need to exfiltrate private info</p>
    <p>Trojan droppers need to download further malicious software ...</p>
    <p>Variants of the same malware can evade AVs</p>
    <p>When executed they generate similar malicious behavior</p>
    <p>No AV detection</p>
    <p>Honeypot</p>
    <p>GET /in.php?affid=101 POST /jump2/?affiliate=boo1</p>
    <p>obfuscation engine</p>
    <p>GET /in.php?affid=132 POST /jump2/?affiliate=boo3</p>
    <p>GET /in.php?affid=123 POST /jump2/?affiliate=boo2</p>
    <p>Similar network behavior</p>
  </div>
  <div class="page">
    <p>Our Approach  Detect the Network Behavior of Malware</p>
    <p>Complement existing host-based detection systems</p>
    <p>Improve coverage</p>
    <p>IDS</p>
    <p>Alarm</p>
    <p>Admin</p>
  </div>
  <div class="page">
    <p>Web-based Malware (2009  source: Team Cymru)</p>
    <p>HTTP-C&amp;C</p>
    <p>IRC-C&amp;C</p>
    <p>Use HTTP protocol</p>
    <p>Bypass existing network defenses</p>
    <p>Firewalls</p>
    <p>Web kits for malware control available</p>
    <p>Web-ProxyFW</p>
    <p>Enterprise Network</p>
  </div>
  <div class="page">
    <p>Detecting Web-based Malware</p>
    <p>Web-ProxyFW</p>
    <p>Network Admin</p>
    <p>Enterprise Network</p>
    <p>IDS</p>
    <p>Behavioral Analysis</p>
    <p>Malware detection models</p>
    <p>Malware Collection</p>
  </div>
  <div class="page">
    <p>Malware Detection Signature:</p>
    <p>GET /in\.php\?affid=.*&amp;url=5&amp;win=Windows%20XP\+2\.0&amp;sts=.*</p>
    <p>System Overview</p>
    <p>Malware Traffic:</p>
    <p>GET /in.php?affid=94901&amp;url=5&amp;win=Windows%20XP+2.0&amp;sts=|US|1|6|4|1|284|0</p>
    <p>GET /in.php?affid=43403&amp;url=5&amp;win=Windows%20XP+2.0&amp;sts=</p>
    <p>GET /in.php?affid=94924&amp;url=5&amp;win=Windows%20XP+2.0&amp;sts=|US|1|6|8|1|184|0</p>
    <p>Behavioral Clustering</p>
    <p>Malware Families</p>
  </div>
  <div class="page">
    <p>Behavioral Malware Clustering  Related Work (host-level behavior)</p>
    <p>Automated analysis of Internet malware [Bailey et al., RAID 2007]</p>
    <p>Scalable malware clustering [Bayer et al., NDSS 2009]</p>
    <p>Malware indexing using function-call graphs [Hu et al., CCS 2009]</p>
    <p>Our approach</p>
    <p>Focus on network-level behavior</p>
    <p>we want network signatures</p>
    <p>Better malware detection signatures than using host-level behavior</p>
  </div>
  <div class="page">
    <p>Network Behavioral Clustering Malware Traces Coarse-grained Fine-grained Meta-clusters</p>
    <p>Three-steps clustering refinement process</p>
    <p>Good trade-off between efficiency and accuracy</p>
  </div>
  <div class="page">
    <p>Network Behavioral Clustering Malware Traces Coarse-grained Fine-grained Meta-clusters</p>
    <p>Honeypot</p>
    <p>GET /bins/int/9kgen_up.int?fxp=6d HTTP/1.1 User-Agent: Download Host: X1569.nb.host192-168-1-2.com Cache-Control: no-cache</p>
    <p>HTTP/1.1 200 OK Connection: close Server: Yaws/1.68 Yet Another Web Server Date: Mon, 15 Mar 2010 11:47:11 GMT Content-Length: 573444 Content-Type: application/octet-stream</p>
  </div>
  <div class="page">
    <p>Malware Traces Coarse-grained Fine-grained Meta-clusters</p>
    <p>Network-level Clustering</p>
    <p># GET req # POST req avg(len(url)) avg(len(data_sent)) avg(len(response)) ...</p>
    <p>Hierarchical Clustering</p>
    <p>Statistical Features</p>
  </div>
  <div class="page">
    <p>Malware Traces Coarse-grained Fine-grained Meta-clusters</p>
    <p>Network-level Clustering</p>
    <p>GET /in.php?affid=94900 GET /bins/int/9kgen_up.int?fxp=6dc23 POST /jump2/?affiliate=boo1 POST /trf?q=Keyword1&amp;bd=-5%236</p>
    <p>Hierarchical Clustering</p>
    <p>Structural Features</p>
    <p>GET /in.php?affid=94900 GET /bins/int/9kgen_up.int?fxp=6dc23 POST /jump2/?affiliate=boo1 POST /trf?q=Keyword1&amp;bd=-5%236</p>
    <p>GET /index.php?v=1.3&amp;os=WinXP GET /kgen/config.txt POST /bots/command.php?a=6.6.6.6 POST /attack.php?ip=10.0.1.2&amp;c=dos</p>
    <p>d(M1,M2)</p>
    <p>Malware Trace M1 Malware Trace M2</p>
  </div>
  <div class="page">
    <p>Malware Traces Coarse-grained Fine-grained Meta-clusters</p>
    <p>Network-level Clustering</p>
    <p>Meta-clustering recovers from possible mistakes made in previous steps</p>
    <p>Improves overall quality of malware clusters and malware detection models</p>
  </div>
  <div class="page">
    <p>Malware Traces Coarse-grained Fine-grained Meta-clusters</p>
    <p>Network-level Clustering</p>
    <p>Hierarchical Clustering</p>
    <p>Compute Centroids</p>
    <p>Measure Distance</p>
    <p>d(C1,C2)</p>
    <p>GET /in.php?affid=234 GET /bins/in\.int?fxp=02 POST /j?affiliate=boo1 POST /trf?q=bd=-1%236</p>
    <p>GET /in\.php\?affid=.* GET /bins/in\.int\?fxp=.* POST /j\?affiliate=boo.* POST /trf\?q=bd=.*%23.*</p>
    <p>Centroid</p>
    <p>Token Subsequences</p>
    <p>Algorithm</p>
  </div>
  <div class="page">
    <p>Signature Generation</p>
    <p>GET /in\.php\?affid=.* GET /bins/int/9kgen_up\.int\?fxp=.* POST /jump2/\?affiliate=boo.* POST /trf\?q=Keyword.*&amp;bd=.*%23.*</p>
    <p>Signature Set</p>
    <p>Enterprise Network</p>
    <p>Token Subsequences</p>
    <p>Algorithm</p>
    <p>Malware Families</p>
    <p>Polygraph IEEE S&amp;P 2005</p>
  </div>
  <div class="page">
    <p>Experimental Results  Malware Dataset</p>
    <p>6 months of malware collection (Feb-Jul 2009)</p>
    <p>~25k distinct real-world malware samples</p>
    <p>Clustering Results</p>
    <p>Dataset Samples Malware Families</p>
    <p>Modeled Samples</p>
    <p>Signatures Time</p>
    <p>Feb-2009 4,758 234 3,494 446 ~8h</p>
    <p>Compact and well Separated Clusters</p>
    <p>Cluster Validity Analysis</p>
  </div>
  <div class="page">
    <p>Experimental Results</p>
    <p>GET /in\.php\?affid=.* GET /bins/int/9kgen_up\.int\?fxp=.* POST /jump2/\?affiliate=boo.* POST /trf\?q=Keyword.*&amp;bd=.*%23.*</p>
    <p>IDS</p>
    <p>Signature Set</p>
    <p>Malware Set</p>
    <p>Malware Clusters Honeypot</p>
    <p>Detection Results</p>
    <p>Feb09 Mar09 Apr09 May09 Jun09 Jul09</p>
    <p>Sig. Feb09 85.9% 50.4% 47.8% 27.0% 21.7% 23.8%</p>
    <p>Detection Test on All Samples</p>
    <p>Feb09 Mar09 Apr09 May09 Jun09 Jul09</p>
    <p>Sig. Feb09 54.8% 52.8% 29.4% 6.1% 3.6% 4.0%</p>
    <p>Detection Test on Malware undetected by commercial AVs</p>
    <p>Sig. Feb09 No False Alerts  Tested on 12M legitimate HTTP queries</p>
  </div>
  <div class="page">
    <p>Comparison with other approaches</p>
    <p>Malware Set Coarse-grained Fine-grained Meta-clusters</p>
    <p>Feb09 Mar09</p>
    <p>Malware Set Fine-grained</p>
    <p>Feb09 Mar09</p>
    <p>Signature extracted from reduced malware set of ~2k malware samples</p>
    <p>Using only fine-grained clustering</p>
    <p>Using approach proposed in [Bayer et al. NDSS 2009]</p>
    <p>Host-based Behavioral Clustering</p>
    <p>Malware Set</p>
    <p>Feb09 Mar09</p>
  </div>
  <div class="page">
    <p>Conclusion</p>
    <p>Novel behavioral malware clustering system  Focus on network-level behavior  Find malware families  Trade-off between efficiency and accuracy  Better detection models compared to using</p>
    <p>host-level behavioral clustering approaches  Malware signatures complement existing host</p>
    <p>level malware detection approaches</p>
  </div>
  <div class="page">
    <p>&quot;If I haven't said this enough, this tool is so badass Roberto... It does an awesome job correlating and clustering these samples&quot;</p>
    <p>Sean M. Bodmer, CISSP CEH Senior Research Analyst</p>
    <p>Damballa, Inc.</p>
  </div>
  <div class="page">
    <p>Thank You!</p>
    <p>Q&amp;A?</p>
    <p>perdisci@gtisc.gatech.edu</p>
  </div>
  <div class="page">
    <p>Appendix</p>
  </div>
  <div class="page">
    <p>AV malware detection stats Source: Oberheide et al., USENIX Security 2008</p>
  </div>
  <div class="page">
    <p>Real-World Deployment</p>
    <p>Deployed in large enterprise network</p>
    <p>~ 2k-3k active nodes</p>
    <p>4 days of testing  Findings</p>
    <p>25 machines infected by spyware</p>
    <p>19 machines infected by scareware (fake AVs)</p>
    <p>1 bot-compromised machine</p>
    <p>1 machine compromised by banker trojan</p>
  </div>
  <div class="page">
    <p>Cluster Validity Analysis</p>
    <p>M1 : W32/Virut.gen WORM/Rbot.50176.5 PE_VIRUT.D-1 M2 : W32/Virut.gen WORM/Rbot.50176.5 PE_VIRUT.D-2 M3 : W32/Virut.gen W32/Virut.Gen PE_VIRUT.D-4 M4 : W32/Virut.gen W32/Virut.X PE_VIRUT.XO-2 M5 : W32/Virut.gen WORM/Rbot.50176.5 PE_VIRUT.D-2 M6 : W32/Virut.gen W32/Virut.H PE_VIRUT.NS-2 M7 : W32/Virut.gen WORM/Rbot.50176.5 PE_VIRUT.D-2 M8 : W32/Virut.gen WORM/Rbot.50176.5 PE_VIRUT.D-1</p>
    <p>McAfee M1</p>
    <p>M8M5</p>
    <p>M6 M7</p>
    <p>M2M3</p>
    <p>M4</p>
    <p>Malware Cluster Avira Trend Micro</p>
    <p>M_W32/Virut</p>
    <p>A_WORM/RbotA_W32/Virut</p>
    <p>T_PE_VIRUT</p>
    <p>AV-Label Graph</p>
    <p>Cohesion Index</p>
    <p>Separation Index</p>
  </div>
  <div class="page">
    <p>Experimental Results</p>
    <p>Cluster Validity Analysis</p>
    <p>Compact and well Separated Clusters</p>
  </div>
  <div class="page">
    <p>Signature Generation and Pruning</p>
    <p>GET /in\.php\?affid=.* GET /bins/int/9kgen_up\.int\?fxp=.* GET /img/logo.jpg POST /jump2/\?affiliate=boo.* POST /trf\?q=Keyword.*&amp;bd=.*%23.* GET /index\.asp\?version=.*</p>
    <p>GET /in\.php\?affid=.* GET /bins/int/9kgen_up\.int\?fxp=.* POST /jump2/\?affiliate=boo.* POST /trf\?q=Keyword.*&amp;bd=.*%23.*</p>
    <p>IDS</p>
    <p>Original Signature Set Pruned Signature Set</p>
    <p>Final Malware Clusters</p>
    <p>GET /in\.php\?affid=.* GET /bins/int/9kgen_up\.int\?fxp=.* GET /img/logo.jpg POST /jump2/\?affiliate=boo.* POST /trf\?q=Keyword.*&amp;bd=.*%23.* GET /index\.asp\?version=.*</p>
    <p>IDS</p>
    <p>Original Signature Set</p>
    <p>Final Malware Clusters</p>
    <p>Enterprise Network</p>
    <p>Legitimate Traffic</p>
  </div>
  <div class="page">
    <p>Experimental Results</p>
    <p>False Positives as measured on 12M legitimate HTTP requests from 2,010 clients</p>
    <p>Malware Detection rate (all samples)</p>
    <p>Zero-Day Malware Detection rate</p>
    <p>Complements traditional AV detection systems</p>
    <p>Detects significant fraction of current and future malware variants</p>
  </div>
  <div class="page">
    <p>Comparison with other approaches</p>
    <p>Reduced dataset of ~4k malware samples</p>
    <p>net-clusters = our three-step clustering approach net-fg-clusters = only fine-grained clustering sys-clusters = using approach proposed in [Bayer et al. NDSS 2009]</p>
    <p>Malware Traces Coarse-grained Fine-grained Meta-clusters</p>
    <p>Signature Generation</p>
  </div>
  <div class="page">
    <p>Challenges</p>
    <p>Detecting malware traffic is hard  Many different types of malware</p>
    <p>Different communication protocols</p>
    <p>Malware can use legitimate protocols to communicate (e.g., HTTP)</p>
    <p>Find a needle in haystack!</p>
    <p>Identify malware traffic among very large volumes of legitimate traffic</p>
  </div>
</Presentation>
