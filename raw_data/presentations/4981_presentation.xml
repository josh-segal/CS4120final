<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>.</p>
    <p>.</p>
    <p>. ..</p>
    <p>.</p>
    <p>.</p>
    <p>WebPatrol: Automated Collection and Replay of Web-based Malware Scenarios</p>
    <p>Kevin Zhijie Chen1,2 (kevinchn@cs.berkeley.edu) Guofei Gu3 Jianwei Zhuge4 Jose Nazario5 Xinhui Han1</p>
    <p>March 22</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 1 / 35</p>
  </div>
  <div class="page">
    <p>New Era, New Threat</p>
    <p>.</p>
    <p>.</p>
    <p>. ..</p>
    <p>.</p>
    <p>.</p>
    <p>Web-based services</p>
    <p>Browser-centric</p>
    <p>Web-based malware</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 2 / 35</p>
  </div>
  <div class="page">
    <p>Whats web-based malware?</p>
    <p>. A web-based malware is... ..</p>
    <p>.</p>
    <p>. ..</p>
    <p>.</p>
    <p>.</p>
    <p>A program in a browser</p>
    <p>Written in HTML, JavaScript, etc</p>
    <p>An exploit of browser vulnerabilities</p>
    <p>Cause of a drive-by download</p>
    <p>.</p>
    <p>.</p>
    <p>. ..</p>
    <p>.</p>
    <p>.</p>
    <p>NeoTracePro 3.25 ActiveX Control TraceTarget() b0f [NeoTraceExplorer.dll]</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 3 / 35</p>
  </div>
  <div class="page">
    <p>But...</p>
    <p>Exploitation is not all</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 4 / 35</p>
  </div>
  <div class="page">
    <p>Before the exploitation happens</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 5 / 35</p>
  </div>
  <div class="page">
    <p>Before the exploitation happens</p>
    <p>. A: Landing page ..</p>
    <p>.</p>
    <p>. ..</p>
    <p>.</p>
    <p>.</p>
    <p>Websites with large traffic http://www.bbc.co.uk/6music/, http://www.pku.edu.cn</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 6 / 35</p>
  </div>
  <div class="page">
    <p>Before the exploitation happens</p>
    <p>. B: Hop pages ..</p>
    <p>.</p>
    <p>. ..</p>
    <p>.</p>
    <p>.</p>
    <p>Inline linking through widgets,AD networks, etc</p>
    <p>Type Example HTML Tags &lt;iframe src = foo.html&gt;&lt;/iframe&gt;, or script, object, img ... JS/VB API clientXmlHttpRequest.open(GET, test.txt, true); Plugins Com.DloadDS(http://www.***.com/calc.cab,muma.exe,0); Shellcodes URLDownloadToFile(0,http://foo.com/calc.exe,calc.exe,0,0);</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 7 / 35</p>
  </div>
  <div class="page">
    <p>Before the exploitation happens</p>
    <p>. C: Dispatching pages ..</p>
    <p>.</p>
    <p>. ..</p>
    <p>.</p>
    <p>.</p>
    <p>Fingerprinting the browser and its plugins, and exposing exploits accordingly.</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 8 / 35</p>
  </div>
  <div class="page">
    <p>Before the exploitation happens</p>
    <p>. D-F: Exploit pages ..</p>
    <p>.</p>
    <p>. ..</p>
    <p>.</p>
    <p>.</p>
    <p>Heap spraying, Buffer overflow, use-after-free, English shellcode, etc.</p>
    <p>. G,H: Downloads ..</p>
    <p>.</p>
    <p>. ..</p>
    <p>.</p>
    <p>.</p>
    <p>Download&amp;Exec, joining botnets, stealing information etc.</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 9 / 35</p>
  </div>
  <div class="page">
    <p>WebPatrol System Architecture</p>
    <p>Goal: Collect all malicious webpages inline-linked in the landing page at a certain time (called a web-based malware scenario, WMS) and replay them faithfully for different kinds of clients.</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 10 / 35</p>
  </div>
  <div class="page">
    <p>Real World WebPatrol: Data Collection</p>
    <p>Time period: Jan. - May, 2010 Data source:</p>
    <p>a crawler + high-interaction client honeypots  35,000 websites from CERNET (China Education and Research Network, mostly *.edu.cn)</p>
    <p>Client environment: IE(6.0, 7.0), Adobe Reader(8,9), Flash Player, Storm Player etc. on WinXP (SP1, SP2) (List of malicious URLs)  WebPatrol</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 11 / 35</p>
  </div>
  <div class="page">
    <p>Basic Statistics</p>
    <p>Google Safe Browsing only labeled 295 landing sites</p>
    <p>Exploit hosting site changes 4.82 times on average during lifetime</p>
    <p>Hot spot for web-based malware but no enough attention received.</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 12 / 35</p>
  </div>
  <div class="page">
    <p>Replay Analysis: Vulnerability Trend</p>
    <p>Figure: Number of new WMSs with MS10-002 Aurora and MS10-018 Exploits</p>
    <p>Also the exploits evolves: 7 variants of MS10-018 exploits found since March 11, 2010 with increasing levels of obfuscation and optimization (for better successful rate)</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 13 / 35</p>
  </div>
  <div class="page">
    <p>Replay Analysis: Scenario Evolution (cc.njarti.edu.cn)</p>
    <p>Mar.11:</p>
    <p>Apr.25:</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 14 / 35</p>
  </div>
  <div class="page">
    <p>Replay Analysis: Scenario Evolution (cc.njarti.edu.cn)</p>
    <p>Mar.11:</p>
    <p>Apr.25:</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 15 / 35</p>
  </div>
  <div class="page">
    <p>Replay Analysis: Scenario Evolution</p>
    <p>Mar.11:</p>
    <p>Apr.25:</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 16 / 35</p>
  </div>
  <div class="page">
    <p>Replay Analysis: Scenario Evolution</p>
    <p>Mar.11:</p>
    <p>Apr.25:</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 17 / 35</p>
  </div>
  <div class="page">
    <p>Replay Analysis: Scenario Evolution II</p>
    <p>Apr.25:</p>
    <p>May.04:</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 18 / 35</p>
  </div>
  <div class="page">
    <p>Replay Analysis: Scenario Evolution II</p>
    <p>Apr.25:</p>
    <p>May.04:</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 19 / 35</p>
  </div>
  <div class="page">
    <p>Implementation Details .</p>
    <p>.</p>
    <p>. The Analyzer: Improved PHoneyC ..</p>
    <p>.</p>
    <p>. ..</p>
    <p>.</p>
    <p>.</p>
    <p>Low-interaction client honeypot (browser emulation) Key modules: HTML Parser, JS engine and plugin emulation Our improvement:</p>
    <p>True DOM support mock ActiveXObject class for universal ActiveX support Download URL extraction and shellcode detection through bytecode instrumentation</p>
    <p>. The Caching/Replay Service: wmPolipo ..</p>
    <p>.</p>
    <p>. ..</p>
    <p>.</p>
    <p>.</p>
    <p>Proxy-like caching solution (online / Offline) Caches all traffic (ignores the private/no-cache/no-store fields) Once collected, never update URL-similarity-check for generalizing randomized URLs</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 20 / 35</p>
  </div>
  <div class="page">
    <p>Pre-Evaluation: Web-based malware family</p>
    <p>Web-based malware exploit kit: Scenarios sharing similar reference sub-graph and directory/file names.</p>
    <p>(a) www.caifucbd.com (b) www.jeast.net</p>
    <p>Figure: Infection/Reference Graph of Two Different Scenarios</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 21 / 35</p>
  </div>
  <div class="page">
    <p>Pre-Evaluation</p>
    <p>Kit ID Pattern Description Cnt. Pi 1 MS10-018 0 htm 713 35.6%</p>
    <p>total 2000 100%</p>
    <p>Table: Percentage of each family in randomly selected 2000 samples K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 22 / 35</p>
  </div>
  <div class="page">
    <p>Evaluation: Completeness</p>
    <p>Initial Site KID All WP NW PKID PHC N P HC KID HPC N</p>
    <p>HP C KID</p>
    <p>dj.csuft.edu.cn 1 5 4 0.80 3 0.60 3 0.60 ecls.ynu.edu.cn 2 5 4 0.80 2 0.40 4 0.80 student.fzu.edu.cn 5 3 2 0.67 2 0.67 3 1.00 ebm.lzu.edu.cn 4 8 8 1.00 3 0.38 4 0.50 cheds.pku.edu.cn 7 7 6 0.86 7 1.00 6 0.86 xsc.ruc.edu.cn 6 14 13 0.93 3 0.21 13 0.93 btzy.nm.edu.cn 8 23 20 0.87 3 0.13 20 0.87 rwxy.zjut.edu.cn 12 3 2 0.67 2 0.67 3 1.00 psy.ntu.edu.cn 3 16 12 0.75 2 0.13 2 0.13 ecls.ynu.edu.cn 9 6 5 0.83 2 0.33 4 0.67 xlzx.sdu.edu.cn 10 21 17 0.81 3 0.14 2 0.10 art.dufe.edu.cn 11 7 6 0.86 3 0.43 5 0.71 ecls.ynu.edu.cn 13 5 4 0.80 2 0.40 2 0.40 abc.hznu.edu.cn 13 6 5 0.83 4 0.67 5 0.83 jwc.sdjzu.edu.cn 13 3 3 1.00 1 0.33 3 1.00 total - 132 119 42 79 C - 100% 81.9% 47.1% 65.3%</p>
    <p>C = 13 i=1</p>
    <p>(Ni  Pi)</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 23 / 35</p>
  </div>
  <div class="page">
    <p>Cause of missing nodes</p>
    <p>...1 Out-going links in different branches if(navigator.userAgent.toLowerCase().indexOf(&quot;msie&quot;)&gt;0)</p>
    <p>{document.write(&quot;&lt;EMBED src=iie.swf width=0 height=0&gt;&quot;);}</p>
    <p>else</p>
    <p>{document.write(&quot;&lt;EMBED src=fff.swf width=0 height=0&gt;&quot;);}</p>
    <p>...2 Limitation of the shellcode detection &amp; emulation module (libemu)</p>
    <p>...3 Different implementations of the parser and the script engine</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 24 / 35</p>
  </div>
  <div class="page">
    <p>Future Work</p>
    <p>Static analysis</p>
    <p>Run the analyzer multiple times with different configurations</p>
    <p>Improvement on libemu (more system API support)</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 25 / 35</p>
  </div>
  <div class="page">
    <p>.</p>
    <p>.</p>
    <p>. ..</p>
    <p>.</p>
    <p>.</p>
    <p>Thank you! Questions? kevinchn@cs.berkeley.edu</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 26 / 35</p>
  </div>
  <div class="page">
    <p>Attacks on WebPatrol</p>
    <p>. Sandbox Detection ..</p>
    <p>.</p>
    <p>. ..</p>
    <p>.</p>
    <p>.</p>
    <p>All kinds of plugins coexisting</p>
    <p>Incomplete browser emulation</p>
    <p>Different implementations for a specification</p>
    <p>but implementing new browser features is fast and easy (adding some Python module).</p>
    <p>. Other attacks ..</p>
    <p>.</p>
    <p>. ..</p>
    <p>.</p>
    <p>.</p>
    <p>DoS attacks</p>
    <p>Vulnerability attacks (e.g. against spidermonkey or PySGML Parser)</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 27 / 35</p>
  </div>
  <div class="page">
    <p>Our approach</p>
    <p>Automated collection and analysis of web-based malware</p>
    <p>Current practice Our approach</p>
    <p>Collection 1. The downloaded malware binaries, 2. Individual malicious web pages</p>
    <p>The complete set of web pages</p>
    <p>Analysis Exploits, downloads, etc. Complete scenario</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 28 / 35</p>
  </div>
  <div class="page">
    <p>Web-base client software exploiting</p>
    <p>Compared to traditional server-side exploiting malware, web-based malware has the following characteristics. First, it exploits client-side vulnerabilities, mostly in modern complex browsers and their extensions. Thus, it is more stealthy and evasive because it does not need to send aggressive scanning traffic. Second, it is pervasive considering the large base of insecure web sites/pages on the Internet. Finally, it is hard to block because most networks allow web traffic.</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 29 / 35</p>
  </div>
  <div class="page">
    <p>Infection Trails and Scenarios</p>
    <p>. Infection trail ..</p>
    <p>.</p>
    <p>. ..</p>
    <p>. .</p>
    <p>We define a web infection trail as a directed path in the graph, starting from  to some sink node in T .</p>
    <p>. Web-based malware scenario (WMS) ..</p>
    <p>.</p>
    <p>. ..</p>
    <p>.</p>
    <p>.</p>
    <p>A directed graph (, V, E, T), where</p>
    <p>: the initial landing URL,   V</p>
    <p>V : Nodes (pages &amp; other resources)</p>
    <p>E : Edges (outgoing links)</p>
    <p>T : Sink nodes (T  V ) (each indicates a successful web infection/exploitation)</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 30 / 35</p>
  </div>
  <div class="page">
    <p>Malicious pages hosting domains</p>
    <p>Domain Name Registrant No. of Inject Sites</p>
    <p>lookforhosting.com GoDaddy.com 255</p>
    <p>caipiaoyuce.info Yue You 157</p>
    <p>chinawordpress.info Yue You 129</p>
    <p>cptiandi.com Melbourne IT 118</p>
    <p>Table: Top 10 Malicious Hosting Domains Discovered during the Measurement of WMS on CERNET</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 31 / 35</p>
  </div>
  <div class="page">
    <p>Replay Analysis: Scenario Evolution II .</p>
    <p>.</p>
    <p>Date Hop Pages Exploit Pages</p>
    <p>First Hop Pages: 1.hm*.xorg.pl/c.js?google ad=...  2 Following Hop Pages: 2.afb.bij.pl/44/953sd.htm  3,4 3.afb.bij.pl/44/fla.htm  8 Dispatching Page: 4.afb.bij.pl/44/av.htm  5,6,7</p>
    <p>First Hop Pages: 1.hm*.xorg.pl/c.js?google ad=...  2 Following Hop Pages: 2.aaw.8866.org/55/167ay.htm  4 Dispatching Page: 4.aaw.8866.org/55/av.htm  5,6,7</p>
    <p>Table: Scenario Evolution on cc.njarti.edu.cn/</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 32 / 35</p>
  </div>
  <div class="page">
    <p>Replay Analysis: Scenario Evolution III .</p>
    <p>.</p>
    <p>Date Hop Pages Exploit Pages</p>
    <p>First Hop Pages: 1.hm*.xorg.pl/c.js?google ad=...  2 Following Hop Pages: 2.aaw.8866.org/55/167ay.htm  4 Dispatching Page: 4.aaw.8866.org/55/av.htm  5,6,7</p>
    <p>First Hop Pages: 1.hm*.xorg.pl/c.js?google ad=...  2,3 Following Hop Pages: 2.abz.7766.org/11/184ay.htm  4 3.hero2.8800.org:97/xo/dk.html  8 Dispatching Page: 4.abz.7766.org/11/av.htm  5,6,7 8.hero2.8800.org:97/xo/0.htm  9</p>
    <p>Table: Scenario Evolution on cc.njarti.edu.cn</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 33 / 35</p>
  </div>
  <div class="page">
    <p>Table of Contents</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 34 / 35</p>
  </div>
  <div class="page">
    <p>Scenario Replay</p>
    <p>. Replay Service:wmPolipo ..</p>
    <p>.</p>
    <p>. ..</p>
    <p>.</p>
    <p>.</p>
    <p>isolated, works in an offline fashion</p>
    <p>aware of scenarios: URL + scenario ID is the primary key for a resource</p>
    <p>URL-similarity-check for generalizing randomized URLs</p>
    <p>Multi-user, multi-cache-directory support</p>
    <p>. Replay Client: ..</p>
    <p>.</p>
    <p>. ..</p>
    <p>.</p>
    <p>.</p>
    <p>All kind of third party tools &amp; platforms</p>
    <p>Only requirement: proxy support</p>
    <p>K.Z. Chen (Peking Univ.) WebPatrol ASIACCS 11 35 / 35</p>
  </div>
</Presentation>
