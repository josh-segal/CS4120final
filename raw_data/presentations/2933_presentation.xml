<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>X-ray: Automating Root-Cause Diagnosis of Performance</p>
    <p>Anomalies in Production Software</p>
    <p>Mona Attariyan Michael Chow</p>
    <p>Jason Flinn</p>
  </div>
  <div class="page">
    <p>Software is complex  Troubleshooting complex systems is hard  Performance issues are especially difficult</p>
    <p>Michael Chow 2</p>
  </div>
  <div class="page">
    <p>What tools are available?  Developers</p>
    <p>Profilers  Tracing tools  Logging</p>
    <p>Michael Chow 3</p>
    <p>Admins &amp; Users  Look on the Internet  Stare at config file  Ask for support</p>
  </div>
  <div class="page">
    <p>Goal  Help diagnose performance issues without:</p>
    <p>Source code  Error or log messages  Controlled workloads  Developer support</p>
    <p>Michael Chow 4</p>
  </div>
  <div class="page">
    <p>Example  Postfix mail server user spends hours</p>
    <p>troubleshooting performance issue</p>
    <p>Michael Chow 5</p>
    <p>top!</p>
    <p>iotop!</p>
    <p>wireshark!</p>
    <p>/var/log/messages!</p>
    <p>/etc/main.cf!</p>
  </div>
  <div class="page">
    <p>Complex configuration files</p>
    <p>Michael Chow 6</p>
    <p>queue_directory = /var/spool/postfix command_directory = /usr/sbin daemon_directory = /usr/libexec/postfix data_directory = /var/lib/postfix mail_owner = postfix default_privs = nobody myhostname = host.domain.tld mydomain = domain.tld myorigin = $myhostname inet_interfaces = all mydestination = $myhostname, localhost.$mydomain, localhost local_recipient_maps = unix:passwd.byname $alias_maps unknown_local_recipient_reject_code = 550 mynetworks_style = class mynetworks = hash:/etc/postfix/network_table relay_domains = $mydestination relayhost = $mydomain relay_recipient_maps = hash:/etc/postfix/relay_recipients in_flow_delay = 1s alias_maps = dbm:/etc/aliases alias_database = dbm:/etc/aliases mail_spool_directory = /var/mail mailbox_transport = lmtp:unix:/file/name header_checks = regexp:/etc/postfix/header_checks local_destination_concurrency_limit = 2 default_destination_concurrency_limit = 20 debug_peer_level = debug_peer_list = mydomain.com sendmail_path = /usr/sbin/sendmail newaliases_path = /usr/bin/newaliases mailq_path = /usr/bin/mailq setgid_group = postdrop html_directory = no manpage_directory = /usr/local/man sample_directory = /etc/postfix readme_directory = no</p>
  </div>
  <div class="page">
    <p>Complex configuration files</p>
    <p>Michael Chow 7</p>
    <p>queue_directory = /var/spool/postfix command_directory = /usr/sbin daemon_directory = /usr/libexec/postfix data_directory = /var/lib/postfix mail_owner = postfix default_privs = nobody myhostname = host.domain.tld mydomain = domain.tld myorigin = $myhostname inet_interfaces = all mydestination = $myhostname, localhost.$mydomain, localhost local_recipient_maps = unix:passwd.byname $alias_maps unknown_local_recipient_reject_code = 550 mynetworks_style = class mynetworks = hash:/etc/postfix/network_table relay_domains = $mydestination relayhost = $mydomain relay_recipient_maps = hash:/etc/postfix/relay_recipients in_flow_delay = 1s alias_maps = dbm:/etc/aliases alias_database = dbm:/etc/aliases mail_spool_directory = /var/mail mailbox_transport = lmtp:unix:/file/name header_checks = regexp:/etc/postfix/header_checks local_destination_concurrency_limit = 2 default_destination_concurrency_limit = 20 debug_peer_level = debug_peer_list = mydomain.com sendmail_path = /usr/sbin/sendmail newaliases_path = /usr/bin/newaliases mailq_path = /usr/bin/mailq setgid_group = postdrop html_directory = no manpage_directory = /usr/local/man sample_directory = /etc/postfix readme_directory = no</p>
    <p>local_destination_concurrency_limit = 2 default_destination_concurrency_limit = 20 debug_peer_level = 3 debug_peer_list = mydomain.com sendmail_path = /usr/sbin/sendmail newaliases_path = /usr/bin/newaliases</p>
  </div>
  <div class="page">
    <p>Whats missing from current tools?</p>
    <p>Existing tools reveal what happened:  Require knowledge of how applications work</p>
    <p>End users need to infer why manually  Want to know the root cause of the problem</p>
    <p>Configuration settings  Input</p>
    <p>Michael Chow 8</p>
  </div>
  <div class="page">
    <p>Insight  Profilers use brute-force analysis</p>
    <p>Attribute cost of every event to source code</p>
    <p>Performance Summarization  Combine this brute-force analysis with a</p>
    <p>causal analysis of every event  Event is instruction or system call  Attribute costs to root causes</p>
    <p>Michael Chow 9</p>
  </div>
  <div class="page">
    <p>Performance Summarization</p>
    <p>Michael Chow 10</p>
  </div>
  <div class="page">
    <p>Outline  Motivation  How to use X-ray  Building Blocks  Performance Summarization  Evaluation</p>
    <p>Michael Chow 11</p>
  </div>
  <div class="page">
    <p>Latency Metric</p>
    <p>Mail Request</p>
    <p>debug_peer_list mydomain.com queue_directory</p>
    <p>How to use X-ray</p>
    <p>List of root causes: 1)  2)  3)</p>
    <p>Scope</p>
    <p>PLAY RECORD</p>
    <p>Michael Chow 12</p>
    <p>Log</p>
  </div>
  <div class="page">
    <p>Building Blocks  Deterministic Replay  Causality Analysis</p>
    <p>Michael Chow 13</p>
  </div>
  <div class="page">
    <p>Deterministic Replay  X-ray uses deterministic replay</p>
    <p>Enables offline analysis  Minimizes perturbation due to analysis</p>
    <p>Michael Chow 14</p>
    <p>Requirements  Low online overhead  Add binary analysis</p>
    <p>(Pin) during replay</p>
  </div>
  <div class="page">
    <p>Replay with Instrumentation  Challenge: Record &amp; Replay executions differ  Solution: Instrumentation awareness  Compensate for differences caused by Pin:</p>
    <p>System calls  Memory areas  Signals  Locking</p>
    <p>Adds overhead of 15% Michael Chow 15</p>
  </div>
  <div class="page">
    <p>ConfAid  ConfAid reports root causes of a specific event  Uses taint-tracking to determine causality</p>
    <p>error</p>
    <p>config file</p>
    <p>likely root causes</p>
    <p>Application</p>
    <p>Michael Chow 16</p>
  </div>
  <div class="page">
    <p>ConfAid Details  Assign weights to taints to represent strength</p>
    <p>Data flow taint &gt; Control flow taint  Closer branches &gt; Distant branches  Direct control flow &gt; Indirect control flow</p>
    <p>Attributing root causes to all events is marginally more expensive than just one event</p>
    <p>Michael Chow 17</p>
  </div>
  <div class="page">
    <p>Outline  Motivation  How to use X-ray  Building Blocks  Performance Summarization  Evaluation</p>
    <p>Michael Chow 18</p>
  </div>
  <div class="page">
    <p>X-ray scoping  Scope: portion of execution to analyze</p>
    <p>Entire execution  Time period  Request  Multiple requests</p>
    <p>Request extraction  Identifies basic blocks that handle a request</p>
    <p>Michael Chow 19</p>
  </div>
  <div class="page">
    <p>Request Extraction: Method 1  Track requests at process granularity</p>
    <p>request 2</p>
    <p>Dispatcher request 1</p>
    <p>Worker</p>
    <p>Use external communication to understand requests</p>
    <p>Does not work for multi-threaded and event-based programs</p>
  </div>
  <div class="page">
    <p>Request Extraction: Method 2  Use taint-tracking to identify requests</p>
    <p>request 1</p>
    <p>request 2</p>
    <p>request 3</p>
    <p>Michael Chow 21</p>
    <p>Propagate data and control flow taints</p>
    <p>Assign basic block to request with most weight</p>
  </div>
  <div class="page">
    <p>Cost</p>
    <p>Performance Summarization</p>
    <p>Michael Chow 22</p>
    <p>Cost can be:  CPU usage  Latency  File system usage  Network usage</p>
  </div>
  <div class="page">
    <p>Latency Root Causes</p>
    <p>Performance Summarization</p>
    <p>Michael Chow 23</p>
  </div>
  <div class="page">
    <p>Latency Root Causes foo bar</p>
    <p>Performance Summarization</p>
    <p>Michael Chow 24</p>
  </div>
  <div class="page">
    <p>Latency Root Causes foo bar</p>
    <p>Performance Summarization</p>
    <p>Michael Chow 25</p>
    <p>Output:</p>
  </div>
  <div class="page">
    <p>Differential Performance Summarization</p>
    <p>Identify why two requests differed in performance</p>
    <p>Michael Chow 26</p>
    <p>?</p>
  </div>
  <div class="page">
    <p>Differential Performance Summarization</p>
    <p>Identify why two requests differed in performance</p>
    <p>Michael Chow 27</p>
  </div>
  <div class="page">
    <p>Differential Performance Summarization Request 1 Request 2</p>
    <p>Michael Chow 28</p>
    <p>C1</p>
    <p>C2</p>
  </div>
  <div class="page">
    <p>Differential Performance Summarization</p>
    <p>Michael Chow 29</p>
    <p>C1</p>
    <p>C2</p>
    <p>Identify conditionals where paths</p>
    <p>diverge</p>
  </div>
  <div class="page">
    <p>Differential Performance Summarization</p>
    <p>C1</p>
    <p>C2</p>
    <p>Differential Cost of C1: 1</p>
    <p>Differential Cost of C2: 6</p>
    <p>foo: 0.5</p>
    <p>bar: 0.25</p>
    <p>Michael Chow 30</p>
  </div>
  <div class="page">
    <p>Differential Performance Summarization</p>
    <p>C1</p>
    <p>C2</p>
    <p>Differential Cost of C1: 1</p>
    <p>Differential Cost of C2: 6</p>
    <p>foo: 0.5</p>
    <p>bar: 0.25</p>
    <p>Michael Chow 31</p>
    <p>Output:</p>
  </div>
  <div class="page">
    <p>Multi-Input Performance Summarization</p>
    <p>Compare a large number of requests</p>
    <p>Michael Chow 32</p>
    <p>Insight: Help identify similar requests</p>
  </div>
  <div class="page">
    <p>Multi-Input Performance Summarization</p>
    <p>Michael Chow 33</p>
    <p>C1</p>
    <p>C2</p>
    <p>C1</p>
    <p>C2</p>
  </div>
  <div class="page">
    <p>Multi-Input Performance Summarization</p>
    <p>Michael Chow 34</p>
    <p>C1</p>
    <p>C2</p>
  </div>
  <div class="page">
    <p>Multi-Input Performance Summarization</p>
    <p>Michael Chow 35</p>
    <p>C1</p>
    <p>C2</p>
    <p>Cost of Conditional C1: 2</p>
  </div>
  <div class="page">
    <p>Multi-Input Performance Summarization</p>
    <p>Michael Chow 36</p>
    <p>C1</p>
    <p>C2</p>
    <p>Cost of Conditional C1: 2</p>
    <p>Cost of Conditional C2: 3</p>
    <p>foo: 0.2</p>
    <p>bar: 0.5</p>
    <p>foo bar</p>
    <p>Output:</p>
  </div>
  <div class="page">
    <p>Limitations of X-ray  Only considers configuration settings and</p>
    <p>inputs as root causes</p>
    <p>Only track causality at the user-level</p>
    <p>Michael Chow 37</p>
  </div>
  <div class="page">
    <p>Evaluation  Looked at 4 apps, 17 performance bugs</p>
    <p>Apache, Postfix, PostgreSQL, lighttpd</p>
    <p>Found bugs on mailing lists, forums, blogs, documentation, books</p>
    <p>Michael Chow 38</p>
  </div>
  <div class="page">
    <p>X-ray Results</p>
    <p>Michael Chow 39</p>
    <p>Application Test Case</p>
    <p>Rank</p>
    <p>Apache 1 MaxKeepAliveRequests On Directory</p>
    <p>Postfix 1 debug_peer_list domain queue_directory</p>
    <p>PostgreSQL 1 timezone datestyle log_timezone</p>
    <p>lighttpd 1 auth.backend.htpasswd.userfile Input server.use-ipv6</p>
    <p>Input(eTag)</p>
    <p>Input(eTag)</p>
    <p>DocumentRoot</p>
    <p>document_root</p>
  </div>
  <div class="page">
    <p>X-ray Results</p>
    <p>Michael Chow 40</p>
    <p>Application Test Case</p>
    <p>Rank</p>
    <p>Apache 1 MaxKeepAliveRequests On Directory</p>
    <p>Postfix 1 debug_peer_list domain queue_directory</p>
    <p>PostgreSQL 1 timezone datestyle log_timezone</p>
    <p>lighttpd 1 auth.backend.htpasswd.userfile Input server.use-ipv6</p>
    <p>Input(eTag)</p>
    <p>Input(eTag)</p>
    <p>DocumentRoot</p>
    <p>document_root</p>
    <p>Correct root cause(s) ranked or tied for first in 16 out of 17</p>
  </div>
  <div class="page">
    <p>How fast is X-ray?</p>
    <p>lighttpd</p>
    <p>Postgres</p>
    <p>Postfix</p>
    <p>Apache</p>
    <p>Minutes</p>
    <p>X-ray Analysis Time</p>
    <p>Average Analysis Time</p>
    <p>Michael Chow 41</p>
    <p>Online overhead of only 1-5%</p>
  </div>
  <div class="page">
    <p>Conclusion  X-ray helps diagnose performance issues</p>
    <p>using performance summarization</p>
    <p>X-ray requires no source code</p>
    <p>X-ray correctly ranked the true root cause first or tied for first in 16 out of 17 issues</p>
    <p>Michael Chow 42</p>
  </div>
  <div class="page">
    <p>Questions</p>
    <p>Michael Chow 43</p>
  </div>
  <div class="page">
    <p>Michael Chow 44</p>
  </div>
  <div class="page">
    <p>Backup Slides</p>
    <p>Michael Chow 45</p>
  </div>
  <div class="page">
    <p>Fast Forwarding  Problem: What about long runs?  Solution: Fast-forward taints</p>
    <p>Michael Chow 46</p>
    <p>config file</p>
  </div>
  <div class="page">
    <p>Related Work  Detecting the problem</p>
    <p>Profilers, DTrace, Event Tracing for Windows (ETW), VTune</p>
    <p>Identifying the root cause(s)  X-trace, SNAP, Pinpoint, Magpie,</p>
    <p>Spectroscope, Aguilera et. al  Solving the problem</p>
    <p>PeerPressure, Strider, Chronus</p>
    <p>Michael Chow 47</p>
  </div>
  <div class="page">
    <p>Selection of Bugs  Selected performance issues with root</p>
    <p>cause(s) of configuration options or input</p>
    <p>Required full range of X-ray to solve  Scope: Request, Time Interval, Differential  Metric: Latency, CPU, File System, Network</p>
    <p>Bugs had mix of binary and variable options</p>
    <p>Michael Chow 48</p>
  </div>
  <div class="page">
    <p>Attribution Strategies  Strategies to attribute costs to root causes</p>
    <p>Michael Chow 49</p>
    <p>Strategy Number of False Positives ranked higher True root cause unranked 0 1 2 3+</p>
    <p>Absolute 21 2 0 0 0</p>
    <p>Normalized 20 0 3 0 0</p>
    <p>Winnertake-all</p>
    <p>Learning 20 2 1 0 0</p>
  </div>
  <div class="page">
    <p>Sensitivity to ConfAid Heuristics</p>
    <p>Confaid ages control flow taint</p>
    <p>Michael Chow 50</p>
    <p>Age Weight</p>
    <p>Number of False Positives ranked higher True root cause unranked 0 1 2 3+</p>
  </div>
  <div class="page">
    <p>Case Study: Differential Summarization</p>
    <p>How similar do requests have to be?</p>
    <p>In-depth look at a performance issue  Sent a variety of different requests</p>
    <p>Michael Chow 51</p>
  </div>
  <div class="page">
    <p>Case Study: Differential Summarization</p>
    <p>Michael Chow 52</p>
    <p>HTTP Requests</p>
    <p>Ranking</p>
    <p>GET/GET MaxKeepAliveRequests On Directory</p>
    <p>GET/POST MaxKeepAliveRequests On Directory</p>
    <p>POST/GET Input DocumentRoot MaxKeepAliveRequests</p>
    <p>Hundred Input ServerRoot MaxKeepAliveRequests</p>
  </div>
</Presentation>
