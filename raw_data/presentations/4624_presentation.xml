<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>Tradeoffs in Transactional Tradeoffs in Transactional</p>
    <p>Memory VirtualizationMemory Virtualization</p>
    <p>JaeWoong Chung JaeWoong Chung</p>
    <p>Chi Cao Minh, Austen McDonald,Chi Cao Minh, Austen McDonald,</p>
    <p>Travis Skare, Hassan ChaTravis Skare, Hassan Chafifi, Brian D. Carlstrom,, Brian D. Carlstrom,</p>
    <p>Christos Kozyrakis, Kunle OlukotunChristos Kozyrakis, Kunle Olukotun</p>
    <p>Computer Systems LabComputer Systems Lab</p>
    <p>Stanford UniversityStanford University</p>
    <p>http://tcc.stanford.eduhttp://tcc.stanford.edu</p>
    <p>picture</p>
  </div>
  <div class="page">
    <p>TM VirtualizationTM Virtualization</p>
    <p>Transactional Memory (TM)Transactional Memory (TM)</p>
    <p>TM is a promising solution for parallel programmingTM is a promising solution for parallel programming</p>
    <p>Hardware TM delivers best performanceHardware TM delivers best performance</p>
    <p>But, hardware resources are limitedBut, hardware resources are limited</p>
    <p>Virtualization of hardware TM systems Virtualization of hardware TM systems</p>
    <p>What if cache capacity is exhausted?What if cache capacity is exhausted?</p>
    <p>Space virtualization: cache overflow, paging, thread migration, Space virtualization: cache overflow, paging, thread migration,</p>
    <p>What if a transaction is interrupted? What if a transaction is interrupted?</p>
    <p>Time virtualization: interrupts, context switches, Time virtualization: interrupts, context switches,</p>
    <p>What if transactions are deeply nested? What if transactions are deeply nested?</p>
    <p>Depth virtualizationDepth virtualization</p>
    <p>It is crucial to address these issues properly for practical HTMIt is crucial to address these issues properly for practical HTMss</p>
  </div>
  <div class="page">
    <p>Design Options for TM VirtualizationDesign Options for TM Virtualization</p>
    <p>TM is virtualized by overflowing transactions to VMTM is virtualized by overflowing transactions to VM  It is yet another TM system implementationIt is yet another TM system implementation</p>
    <p>Granularity of data managementGranularity of data management  Word Vs. cacheWord Vs. cache--line Vs. page levelline Vs. page level</p>
    <p>Conflict detection strategyConflict detection strategy  Optimistic Vs. pessimisticOptimistic Vs. pessimistic</p>
    <p>Implementation approachImplementation approach  Hardware &amp; firmware Vs. operating system Vs. user software Hardware &amp; firmware Vs. operating system Vs. user software</p>
    <p>See paper for detailed discussion on optionsSee paper for detailed discussion on options</p>
  </div>
  <div class="page">
    <p>Previous WorkPrevious Work</p>
    <p>Hardware solutionsHardware solutions</p>
    <p>UTM [HPCAUTM [HPCA05], VTM [ISCA05], VTM [ISCA05], PTM [ASPLOS05], PTM [ASPLOS06]06]</p>
    <p>Primarily cachePrimarily cache--line granularityline granularity</p>
    <p>Hardware manages overflowed data and metadata in virtual memoryHardware manages overflowed data and metadata in virtual memory</p>
    <p>Good performance for all workload casesGood performance for all workload cases</p>
    <p>Expensive, extra hardware mostly idleExpensive, extra hardware mostly idle</p>
    <p>User software solutionsUser software solutions</p>
    <p>Hybrid TM [PPoPPHybrid TM [PPoPP06 &amp; ASPLOS06 &amp; ASPLOS 06]06]</p>
    <p>Primarily object level granularityPrimarily object level granularity</p>
    <p>Software TM for virtualization, hardware TM for accelerationSoftware TM for virtualization, hardware TM for acceleration</p>
    <p>No additional hardwareNo additional hardware</p>
    <p>Two versions of code, lower performance in some casesTwo versions of code, lower performance in some cases</p>
  </div>
  <div class="page">
    <p>Virtualization Design SpaceVirtualization Design Space</p>
    <p>TradeoffTradeoff: common: common--case performance Vs. HW/SW costcase performance Vs. HW/SW cost</p>
    <p>Overflows, interrupts, and deep nesting are rare [HPCAOverflows, interrupts, and deep nesting are rare [HPCA06]06]</p>
    <p>Cost</p>
    <p>Performance</p>
    <p>VTM PTM</p>
    <p>UTM</p>
    <p>Hybrid</p>
    <p>TM</p>
    <p>?</p>
    <p>?</p>
    <p>?</p>
  </div>
  <div class="page">
    <p>XTM: eXtended TMXTM: eXtended TM</p>
    <p>GoalsGoals</p>
    <p>Virtualize all 3 dimensions of TM (space, time, depth)Virtualize all 3 dimensions of TM (space, time, depth)</p>
    <p>Low HW cost and completely transparent to user SW Low HW cost and completely transparent to user SW</p>
    <p>Does not slow down coexisting HW transactionsDoes not slow down coexisting HW transactions</p>
    <p>AssumptionAssumption</p>
    <p>Overflows, interrupts, and deep nesting are rare [HPCAOverflows, interrupts, and deep nesting are rare [HPCA06]06]</p>
    <p>Key idea: virtualization through the operating system Key idea: virtualization through the operating system</p>
    <p>Builds upon existing VM supportBuilds upon existing VM support</p>
    <p>Data versioning &amp; conflict detection at page granularityData versioning &amp; conflict detection at page granularity</p>
    <p>Similar to pageSimilar to page--based software DSM systemsbased software DSM systems</p>
    <p>3 designs at different performance/cost points3 designs at different performance/cost points</p>
    <p>XTMXTM--base, XTMbase, XTM--g, XTMg, XTM--ee</p>
  </div>
  <div class="page">
    <p>XTMXTM--base Overviewbase Overview</p>
    <p>Basic operationBasic operation</p>
    <p>On HTM overflow, rollback and restart in SW modeOn HTM overflow, rollback and restart in SW mode</p>
    <p>At the first access, create a copy of original (master) pageAt the first access, create a copy of original (master) page</p>
    <p>Change the address mapping to the copy (private page)Change the address mapping to the copy (private page)</p>
    <p>Transactional data in private page, committed data in master pagTransactional data in private page, committed data in master pagee</p>
    <p>At commit, make the private page the new master pageAt commit, make the private page the new master page</p>
    <p>All orchestrated by the operating system (no HW)All orchestrated by the operating system (no HW)</p>
    <p>Conflict detection: pessimistic Vs. Conflict detection: pessimistic Vs. optimisticoptimistic</p>
    <p>Pessimistic: use TLB shootPessimistic: use TLB shoot--downs to gain exclusive page accessdowns to gain exclusive page access</p>
    <p>Optimistic: use snapshots &amp; diffs before XTM commitOptimistic: use snapshots &amp; diffs before XTM commit</p>
    <p>No overhead for HW transactionsNo overhead for HW transactions</p>
    <p>See paper for forward progress guarantees for XTMSee paper for forward progress guarantees for XTM</p>
  </div>
  <div class="page">
    <p>XTMXTM--base Requirementsbase Requirements</p>
    <p>HardwareHardware</p>
    <p>Required: overflow exceptionRequired: overflow exception</p>
    <p>Optional: fast page copy mechanism (DMA, SIMD, Optional: fast page copy mechanism (DMA, SIMD, ))</p>
    <p>DataData--structures (software)structures (software)</p>
    <p>PerPer--transaction page tabletransaction page table</p>
    <p>Contains only mappings to private pages, not master pagesContains only mappings to private pages, not master pages</p>
    <p>Populated dynamicallyPopulated dynamically</p>
    <p>PerPer--core virtualization information table (VIT)core virtualization information table (VIT)</p>
    <p>Maintains metadata and the pointers to extra pagesMaintains metadata and the pointers to extra pages</p>
    <p>DataData--structures are prestructures are pre--allocated to reduce overheadallocated to reduce overhead</p>
  </div>
  <div class="page">
    <p>Virtualization Information TableVirtualization Information Table</p>
    <p>Virtual</p>
    <p>address</p>
    <p>Nesting</p>
    <p>depth</p>
    <p>VPN key 0</p>
    <p>VPN key 1</p>
    <p>VPN key 2</p>
    <p>VPN key N</p>
    <p>Level 1Level 0</p>
    <p>Private page</p>
    <p>Snapshot</p>
    <p>W R</p>
  </div>
  <div class="page">
    <p>XTMXTM--base Examplebase Example</p>
    <p>Timeline</p>
    <p>Level 0</p>
    <p>Per-txn page table</p>
    <p>Private</p>
    <p>page</p>
    <p>Snapshot 0</p>
    <p>Private page</p>
    <p>W R</p>
    <p>VIT entry</p>
    <p>Snapshot 0</p>
    <p>Snapshot 1</p>
    <p>Private page</p>
    <p>W R</p>
    <p>Snapshot 1</p>
    <p>Level 1</p>
    <p>Master</p>
    <p>page table</p>
    <p>Master</p>
    <p>page Page table pointer</p>
    <p>HTM Overflow</p>
    <p>Xtn Read</p>
    <p>Xtn Write</p>
    <p>Nested Txn Begin</p>
    <p>Xtn Read</p>
    <p>Xtn Write</p>
    <p>Nested Commit</p>
    <p>Validate</p>
    <p>Commit</p>
  </div>
  <div class="page">
    <p>XTMXTM--g: Gradual Overflowg: Gradual Overflow</p>
    <p>XTMXTM--base bottleneck: rollbase bottleneck: roll--back overhead on overflowback overhead on overflow</p>
    <p>Gradual overflowGradual overflow  On overflow, just flush one or a few pages to XTMOn overflow, just flush one or a few pages to XTM</p>
    <p>A portion of transactional data in private pages, the rest in thA portion of transactional data in private pages, the rest in the e cachecache</p>
    <p>XTM commit XTM commit  First validate both XTM and hardware TM dataFirst validate both XTM and hardware TM data</p>
    <p>Then commit the XTM and hardware TM data Then commit the XTM and hardware TM data</p>
    <p>Requires twoRequires two--phase commit support [ISCAphase commit support [ISCA06]06]</p>
    <p>Hardware requirementsHardware requirements  Overflow bit to remember the pages that have overflowedOverflow bit to remember the pages that have overflowed</p>
    <p>Per pagePer page--table entry, TLB entries, and cache linestable entry, TLB entries, and cache lines</p>
  </div>
  <div class="page">
    <p>XTMXTM--e: Finee: Fine--grain Conflict Detectiongrain Conflict Detection</p>
    <p>XTMXTM--g bottleneck: false sharing overhead at page levelg bottleneck: false sharing overhead at page level</p>
    <p>FineFine--grain conflict detection grain conflict detection  When flushing a cache line, record fineWhen flushing a cache line, record fine--grain metadata bits in VITgrain metadata bits in VIT</p>
    <p>Per cache line or per even per wordPer cache line or per even per word</p>
    <p>Use fineUse fine--grain information on validation grain information on validation</p>
    <p>Validate only portions of each XTM pageValidate only portions of each XTM page</p>
    <p>RequirementsRequirements  SW: extra space in VIT entries for fineSW: extra space in VIT entries for fine--grain metadatagrain metadata</p>
    <p>HW: eviction buffer for metadata bits (performance enhancement)HW: eviction buffer for metadata bits (performance enhancement)</p>
    <p>Needed for cache lines that are reloaded and then evictedNeeded for cache lines that are reloaded and then evicted</p>
    <p>Avoids SW handler invocation on each subsequent evictionAvoids SW handler invocation on each subsequent eviction</p>
    <p>Buffer is flushed periodically Buffer is flushed periodically</p>
  </div>
  <div class="page">
    <p>Switch xaction to</p>
    <p>XTM mode</p>
    <p>Time virtualizationTime virtualization</p>
    <p>Interrupt</p>
    <p>Can wait? No</p>
    <p>Yes</p>
    <p>Wait for a short</p>
    <p>xaction to finish</p>
    <p>Young xaction? No</p>
    <p>Abort a young</p>
    <p>xaction</p>
    <p>Yes</p>
    <p>Interrupt and contextInterrupt and context--switch procedureswitch procedure OtherOther</p>
    <p>proposalsproposals</p>
    <p>Rare case</p>
  </div>
  <div class="page">
    <p>EvaluationEvaluation  ExecutionExecution--driven hardware TM simulator (TCC) driven hardware TM simulator (TCC)</p>
    <p>XTM series and VTM are comparedXTM series and VTM are compared</p>
    <p>32KB cache for transactional buffering32KB cache for transactional buffering</p>
    <p>ApplicationsApplications  SPLASHSPLASH--2, SPEC, and micro2, SPEC, and micro--benchmarksbenchmarks</p>
    <p>ImportantImportant: many applications did not invoke XTM at all: many applications did not invoke XTM at all</p>
    <p>XTM introduces no HW cost or overhead for themXTM introduces no HW cost or overhead for them</p>
    <p>ExperimentsExperiments  Overall performance analysisOverall performance analysis</p>
    <p>XTMXTM--only transactional memoryonly transactional memory</p>
    <p>More results in the paperMore results in the paper</p>
    <p>Memory pressure, sensitivity to cache size, time virtualization Memory pressure, sensitivity to cache size, time virtualization evaluation, evaluation,</p>
  </div>
  <div class="page">
    <p>Performance AnalysisPerformance Analysis</p>
    <p>XTMXTM--base showed 3x to 8x slowdown for applications with frequent ovebase showed 3x to 8x slowdown for applications with frequent overflowrflow</p>
    <p>It causes no overhead for most applications that donIt causes no overhead for most applications that dont overflowt overflow</p>
    <p>XTMXTM--g presents a good cost/performance tradeoff pointg presents a good cost/performance tradeoff point</p>
    <p>20% faster to 50% slower than VTM 20% faster to 50% slower than VTM</p>
    <p>X T M</p>
    <p>X T M g</p>
    <p>X T M e</p>
    <p>V T M</p>
    <p>X T M</p>
    <p>X T M g</p>
    <p>X T M e</p>
    <p>V T M</p>
    <p>X T M</p>
    <p>X T M g</p>
    <p>X T M e</p>
    <p>V T M</p>
    <p>X T M</p>
    <p>X T M g</p>
    <p>X T M e</p>
    <p>V T M</p>
    <p>X T M</p>
    <p>X T M g</p>
    <p>X T M e</p>
    <p>V T M</p>
    <p>X T M</p>
    <p>X T M g</p>
    <p>X T M e</p>
    <p>V T M</p>
    <p>tomcatv</p>
    <p>[37.7%]</p>
    <p>volrend</p>
    <p>[0.01%]</p>
    <p>radix</p>
    <p>[0.26%]</p>
    <p>micro-P10</p>
    <p>[39.2%]</p>
    <p>micro-P20</p>
    <p>[60.3%]</p>
    <p>micro-P30</p>
    <p>[60.8%]</p>
    <p>N o r m a li z e d E x e c u ti o n T im e</p>
    <p>Versioning</p>
    <p>Validation</p>
    <p>Commit</p>
    <p>Violations</p>
    <p>Idle</p>
    <p>Useful</p>
  </div>
  <div class="page">
    <p>XTMXTM--only Transactional Memory?only Transactional Memory?</p>
    <p>There is a clear performance gap between HTM + XTM and XTMThere is a clear performance gap between HTM + XTM and XTM--onlyonly</p>
    <p>It is 3x to 8x slower than hardware TM It is 3x to 8x slower than hardware TM</p>
    <p>Hardware support is important for transactional memoryHardware support is important for transactional memory</p>
    <p>HTM+XTM XTM-only HTM+XTM XTM-only HTM+XTM XTM-only</p>
    <p>tomcatv micro-P7 micro-P5</p>
    <p>N o r m a li z e d E x e c u ti o n T im</p>
    <p>e</p>
    <p>Versioning</p>
    <p>Validation</p>
    <p>Commit</p>
    <p>Violations</p>
    <p>Idle</p>
    <p>Useful</p>
  </div>
  <div class="page">
    <p>ConclusionsConclusions</p>
    <p>TM is a promising solution for parallel programmingTM is a promising solution for parallel programming</p>
    <p>Hardware TM delivers a good performanceHardware TM delivers a good performance</p>
    <p>Challenges for HTM : overflows, interrupts, deep nesting, Challenges for HTM : overflows, interrupts, deep nesting,</p>
    <p>TM virtualization is a crucial component for practical HTMsTM virtualization is a crucial component for practical HTMs</p>
    <p>XTM: virtualization through the operating system XTM: virtualization through the operating system</p>
    <p>Virtualizes TM space, time, and depthVirtualizes TM space, time, and depth</p>
    <p>Low HW cost and completely transparent to user SW Low HW cost and completely transparent to user SW</p>
    <p>proposes 3 designs of different tradeoff pointsproposes 3 designs of different tradeoff points</p>
    <p>XTMXTM--base: SW only solutionbase: SW only solution</p>
    <p>XTMXTM--g: eliminates rollback overhead with Overflow bitg: eliminates rollback overhead with Overflow bit</p>
    <p>XTMXTM--e: eliminates false sharing with more HW supporte: eliminates false sharing with more HW support</p>
    <p>We hope that this work helps build practical HTM systemsWe hope that this work helps build practical HTM systems</p>
  </div>
  <div class="page">
    <p>Questions?Questions?</p>
    <p>Whew~!</p>
    <p>Jae Woong ChungJae Woong Chung jwchung@stanford.edujwchung@stanford.edu</p>
    <p>Computer Systems Lab.Computer Systems Lab.</p>
    <p>Stanford UniversityStanford University</p>
    <p>http://tcc.stanford.eduhttp://tcc.stanford.edu</p>
  </div>
</Presentation>
