<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>How to Copy Files</p>
    <p>Yang Zhan1,2, Alex Conway3,4, Ian Groombridge5, Yizheng Jiao1, Nirjhar Mukherjee1, Michael A. Bender6, Martn Farach-Colton3,</p>
    <p>William Jannen7, Rob Johnson4, Donald E. Porter1, Jun Yuan5</p>
  </div>
  <div class="page">
    <p>Copying is Ubiquitous and Important</p>
    <p>cp -r</p>
    <p>container instantiation vmrun start</p>
    <p>backup</p>
  </div>
  <div class="page">
    <p>Copying</p>
    <p>Physical Copy</p>
  </div>
  <div class="page">
    <p>Copying</p>
    <p>High Latency</p>
    <p>Physical Copy</p>
    <p>High Space Use</p>
  </div>
  <div class="page">
    <p>Existing Logical Copy Implementations</p>
    <p>BTRFS</p>
    <p>XFS</p>
    <p>ZFS</p>
    <p>Leverages the underlying copy-on-write B-tree to implement cp --reflink</p>
    <p>Uses an update-in-place B-tree but supports sharing data blocks with copy-on-write via cp --reflink</p>
    <p>Implements a limited version of copy-on-write copying via zfs clone</p>
  </div>
  <div class="page">
    <p>Copying</p>
    <p>High Latency</p>
    <p>Copy on Write</p>
    <p>High Space Use</p>
    <p>Physical Copy</p>
  </div>
  <div class="page">
    <p>Copying</p>
    <p>High Latency Low Latency</p>
    <p>Copy on Write</p>
    <p>High Space Use Better Space Use</p>
    <p>High Fragmentation</p>
    <p>Physical Copy</p>
  </div>
  <div class="page">
    <p>Copying</p>
    <p>High Latency Low Latency</p>
    <p>Copy on Write</p>
    <p>High Space Use Better Space Use</p>
    <p>High Fragmentation</p>
    <p>Physical Copy</p>
  </div>
  <div class="page">
    <p>Space Amplification and Fragmention</p>
    <p>Init: 64 4MiB files with random data. Each round: logically copy all files, then change 16B in each file (1KiB total)</p>
    <p>Dell Optiplex 790 4-core 3.40 GHz Intel Core i7 CPU</p>
  </div>
  <div class="page">
    <p>Space Amplification and Fragmention</p>
    <p>S pa</p>
    <p>ce A</p>
    <p>m pl</p>
    <p>ifi ca</p>
    <p>tio n</p>
    <p>BTRFS XFS ZFS</p>
    <p>Init: 64 4MiB files with random data. Each round: logically copy all files, then change 16B in each file (1KiB total)</p>
    <p>Space Amplification additional file system size / added data (1KiB)</p>
    <p>Lo w</p>
    <p>er is</p>
    <p>B et</p>
    <p>te r</p>
    <p>Dell Optiplex 790 4-core 3.40 GHz Intel Core i7 CPU</p>
  </div>
  <div class="page">
    <p>Space Amplification and Fragmention</p>
    <p>Init: 64 4MiB files with random data. Each round: logically copy all files, then change 16B in each file (1KiB total)</p>
    <p>Fragmentation measured by timing a grep over the latest copy</p>
    <p>Space Amplification additional file system size / added data (1KiB)</p>
    <p>Lo w</p>
    <p>er is</p>
    <p>B et</p>
    <p>te r</p>
    <p>S pa</p>
    <p>ce A</p>
    <p>m pl</p>
    <p>ifi ca</p>
    <p>tio n</p>
    <p>BTRFS XFS ZFS</p>
    <p>gr ep</p>
    <p>ti m</p>
    <p>e (s</p>
    <p>ec on</p>
    <p>ds )</p>
    <p>Logical copy number 0 1 2 3 4 5 6 7 8</p>
    <p>BTRFS XFS ZFS</p>
    <p>Dell Optiplex 790 4-core 3.40 GHz Intel Core i7 CPU</p>
  </div>
  <div class="page">
    <p>gr ep</p>
    <p>ti m</p>
    <p>e (s</p>
    <p>ec on</p>
    <p>ds )</p>
    <p>Logical copy number 0 1 2 3 4 5 6 7 8</p>
    <p>BTRFS XFS ZFS</p>
    <p>Space Amplification and Fragmention</p>
    <p>Init: 64 4MiB files with random data. Each round: logically copy all files, then change 16B in each file (1KiB total)</p>
    <p>Fragmentation measured by timing a grep over the latest copy</p>
    <p>Space Amplification additional file system size / added data (1KiB)</p>
    <p>Lo w</p>
    <p>er is</p>
    <p>B et</p>
    <p>te r</p>
    <p>S pa</p>
    <p>ce A</p>
    <p>m pl</p>
    <p>ifi ca</p>
    <p>tio n</p>
    <p>BTRFS XFS ZFS</p>
    <p>Dell Optiplex 790 4-core 3.40 GHz Intel Core i7 CPU</p>
    <p>Have large space amplification</p>
  </div>
  <div class="page">
    <p>S pa</p>
    <p>ce A</p>
    <p>m pl</p>
    <p>ifi ca</p>
    <p>tio n</p>
    <p>BTRFS XFS ZFS</p>
    <p>Space Amplification and Fragmention</p>
    <p>ep ti</p>
    <p>m e</p>
    <p>(s ec</p>
    <p>on ds</p>
    <p>)</p>
    <p>Logical copy number 0 1 2 3 4 5 6 7 8</p>
    <p>BTRFS XFS ZFS</p>
    <p>Init: 64 4MiB files with random data. Each round: logically copy all files, then change 16B in each file (1KiB total)</p>
    <p>Fragmentation measured by timing a grep over the latest copy</p>
    <p>Space Amplification additional file system size / added data (1KiB)</p>
    <p>Lo w</p>
    <p>er is</p>
    <p>B et</p>
    <p>te r</p>
    <p>Have large space amplification</p>
    <p>Or high fragmentation</p>
    <p>Dell Optiplex 790 4-core 3.40 GHz Intel Core i7 CPU</p>
  </div>
  <div class="page">
    <p>Copy Performance Goals</p>
  </div>
  <div class="page">
    <p>Copy Performance Goals</p>
    <p>Space efficient</p>
    <p>Low latency</p>
    <p>Specific to Copying</p>
  </div>
  <div class="page">
    <p>Copy Performance Goals</p>
    <p>Space efficient</p>
    <p>Low latency</p>
    <p>Fast writes</p>
    <p>Fast reads</p>
    <p>General file systemSpecific to Copying</p>
  </div>
  <div class="page">
    <p>Copy Performance Goals</p>
    <p>Space efficient</p>
    <p>Low latency</p>
    <p>Fast writes</p>
    <p>Fast reads</p>
    <p>General file systemSpecific to Copying</p>
    <p>Locality</p>
  </div>
  <div class="page">
    <p>Contributions of this Paper</p>
    <p>A high performance logical copy implementation</p>
  </div>
  <div class="page">
    <p>Contributions of this Paper</p>
    <p>A high performance logical copy implementation</p>
    <p>In BtrFS, which leverages the properties of Copy-on-Write B-trees</p>
  </div>
  <div class="page">
    <p>Contributions of this Paper</p>
    <p>Space efficient</p>
    <p>Low latency</p>
    <p>Fast writes</p>
    <p>Fast reads</p>
    <p>Copy-specific General file system</p>
    <p>A high performance logical copy implementation</p>
    <p>In BtrFS, which leverages the properties of Copy-on-Write B-trees</p>
  </div>
  <div class="page">
    <p>Contributions of this Paper</p>
    <p>Space efficient</p>
    <p>Low latency</p>
    <p>Fast writes</p>
    <p>Fast reads</p>
    <p>Copy-specific General file system</p>
    <p>A high performance logical copy implementation</p>
    <p>In BtrFS, which leverages the properties of Copy-on-Write B-trees</p>
  </div>
  <div class="page">
    <p>What is the Challenge of Logical Copy?</p>
  </div>
  <div class="page">
    <p>Example: Logical copy in an inode file system</p>
  </div>
  <div class="page">
    <p>Logical Copy in an Inode File System</p>
    <p>fo o</p>
    <p>/</p>
    <p>fr ed</p>
    <p>Copy /foo to /bar</p>
  </div>
  <div class="page">
    <p>Logical Copy in an Inode File System</p>
    <p>fo o</p>
    <p>/</p>
    <p>directory inode</p>
    <p>file inode</p>
    <p>data block</p>
    <p>Copy /foo to /bar</p>
    <p>fr ed</p>
  </div>
  <div class="page">
    <p>Logical Copy in an Inode File System</p>
    <p>fo o</p>
    <p>/</p>
    <p>Copy /foo to /bar</p>
    <p>fr ed</p>
  </div>
  <div class="page">
    <p>Logical Copy in an Inode File System</p>
    <p>fo o</p>
    <p>/</p>
    <p>copy baroriginal</p>
    <p>Copy /foo to /bar</p>
    <p>fr ed</p>
  </div>
  <div class="page">
    <p>Logical Copy in an Inode File System</p>
    <p>fo o</p>
    <p>/</p>
    <p>baroriginal</p>
    <p>Low latency</p>
    <p>Space efficient</p>
    <p>Fast Reads</p>
    <p>Fast Writes ? ?</p>
    <p>? ?Copy /foo to /bar</p>
    <p>fr ed copy</p>
  </div>
  <div class="page">
    <p>Logical Copy in an Inode File System</p>
    <p>fo o</p>
    <p>/</p>
    <p>baroriginal</p>
    <p>Low latency</p>
    <p>Space efficient</p>
    <p>Fast Reads Fast Writes ?</p>
    <p>? ?</p>
    <p>Copy /foo to /bar</p>
    <p>fr ed copy</p>
  </div>
  <div class="page">
    <p>Logical Copy in an Inode File System</p>
    <p>fo o</p>
    <p>/</p>
    <p>baroriginal</p>
    <p>Low latency</p>
    <p>Space efficient</p>
    <p>Fast Reads Fast Writes ?</p>
    <p>? ?</p>
    <p>change 1 bit here</p>
    <p>Copy /foo to /bar</p>
    <p>fr ed copy</p>
  </div>
  <div class="page">
    <p>Logical Copy in an Inode File System</p>
    <p>fo o</p>
    <p>/</p>
    <p>baroriginal</p>
    <p>Low latency</p>
    <p>Space efficient</p>
    <p>change 1 bit here</p>
    <p>copy with new bit</p>
    <p>Fast Reads</p>
    <p>Fast Writes ? ?</p>
    <p>? Copy /foo to /bar</p>
    <p>fr ed copy</p>
  </div>
  <div class="page">
    <p>Logical Copy in an Inode File System</p>
    <p>fo o</p>
    <p>/</p>
    <p>baroriginal</p>
    <p>Low latency</p>
    <p>Space efficient</p>
    <p>change 1 bit here</p>
    <p>copy with new bit</p>
    <p>Added a whole data block to change 1 bit</p>
    <p>Fast Reads</p>
    <p>Fast Writes ? ?</p>
    <p>? Copy /foo to /bar</p>
    <p>fr ed copy</p>
  </div>
  <div class="page">
    <p>Logical Copy in an Inode File System</p>
    <p>fo o</p>
    <p>/</p>
    <p>baroriginal</p>
    <p>Low latency</p>
    <p>Space efficient</p>
    <p>change 1 bit here</p>
    <p>copy with new bit</p>
    <p>Added a whole data block to change 1 bit</p>
    <p>This is at least 4KiB and can be more</p>
    <p>Fast Reads</p>
    <p>Fast Writes ? ?</p>
    <p>? Copy /foo to /bar</p>
    <p>fr ed copy</p>
  </div>
  <div class="page">
    <p>Logical Copy in an Inode File System</p>
    <p>fo o</p>
    <p>/</p>
    <p>baroriginal</p>
    <p>Low latency</p>
    <p>Space efficient</p>
    <p>change 1 bit here</p>
    <p>copy with new bit</p>
    <p>Added a whole data block to change 1 bit</p>
    <p>This is at least 4KiB and can be more</p>
    <p>Fast Reads</p>
    <p>Fast Writes ? ?Copy /foo to /bar</p>
    <p>fr ed copy</p>
  </div>
  <div class="page">
    <p>Logical Copy in an Inode File System</p>
    <p>fo o</p>
    <p>/</p>
    <p>baroriginal</p>
    <p>Low latency</p>
    <p>Space efficient</p>
    <p>Fast Reads</p>
    <p>Fast Writes ? ?Copy /foo to /bar</p>
    <p>fr ed copy</p>
  </div>
  <div class="page">
    <p>Logical Copy in an Inode File System</p>
    <p>fo o</p>
    <p>/</p>
    <p>baroriginal</p>
    <p>Low latency</p>
    <p>Space efficient</p>
    <p>Fast Reads</p>
    <p>Fast Writes ? ?Copy /foo to /bar</p>
    <p>no locality guarantees between data blocks</p>
    <p>fr ed copy</p>
  </div>
  <div class="page">
    <p>Logical Copy in an Inode File System</p>
    <p>fo o</p>
    <p>/</p>
    <p>baroriginal</p>
    <p>Low latency</p>
    <p>Space efficient</p>
    <p>Fast Reads</p>
    <p>Fast Writes ? ?Copy /foo to /bar</p>
    <p>no locality guarantees between data blocks</p>
    <p>only have locality if the blocks are large</p>
    <p>fr ed copy</p>
  </div>
  <div class="page">
    <p>Logical Copy in an Inode File System</p>
    <p>fo o</p>
    <p>/</p>
    <p>baroriginal</p>
    <p>Low latency</p>
    <p>Space efficient</p>
    <p>Fast Reads</p>
    <p>Fast Writes ? ?Copy /foo to /bar</p>
    <p>no locality guarantees between data blocks</p>
    <p>only have locality if the blocks are large</p>
    <p>usually 4KiB too small for localityfr ed copy</p>
  </div>
  <div class="page">
    <p>Logical Copy in an Inode File System</p>
    <p>fo o</p>
    <p>/</p>
    <p>baroriginal</p>
    <p>Low latency</p>
    <p>Space efficient</p>
    <p>Fast Reads</p>
    <p>Fast Writes</p>
    <p>Copy /foo to /bar</p>
    <p>no locality guarantees between data blocks</p>
    <p>only have locality if the blocks are large</p>
    <p>usually 4KiB too small for locality</p>
    <p>fr ed copy</p>
  </div>
  <div class="page">
    <p>Space-Locality Tradeoff</p>
    <p>Larger blocks</p>
    <p>Better locality</p>
    <p>Worse space efficiency</p>
  </div>
  <div class="page">
    <p>Space-Locality Tradeoff</p>
    <p>Larger blocks</p>
    <p>Better locality</p>
    <p>Worse space efficiency</p>
    <p>Smaller blocks</p>
    <p>Worse locality</p>
    <p>Better space efficiency</p>
  </div>
  <div class="page">
    <p>Space-Locality Tradeoff</p>
    <p>Larger blocks</p>
    <p>Better locality</p>
    <p>Worse space efficiency</p>
    <p>Smaller blocks</p>
    <p>Worse locality</p>
    <p>Better space efficiency</p>
    <p>Too large for space</p>
    <p>Too small for locality</p>
  </div>
  <div class="page">
    <p>Inode Logical Copy Takeaway</p>
    <p>Using a DAG to share data is great for latency</p>
  </div>
  <div class="page">
    <p>Inode Logical Copy Takeaway</p>
    <p>Challenge: Small writes break sharing</p>
    <p>Using a DAG to share data is great for latency</p>
  </div>
  <div class="page">
    <p>Our Solution: B-DAGs</p>
    <p>B-Trees</p>
    <p>BtrFS B-DAGs</p>
  </div>
  <div class="page">
    <p>Our Solution: B-DAGs</p>
    <p>B-trees have good locality and batch together small writes</p>
  </div>
  <div class="page">
    <p>Our Solution: B-DAGs</p>
    <p>B-trees have good locality and batch together small writes</p>
    <p>In this paper, we turn B-trees into B-DAGs to share data between files</p>
  </div>
  <div class="page">
    <p>B-Trees</p>
  </div>
  <div class="page">
    <p>B-Trees</p>
    <p>B A B B B</p>
    <p>A RG A C F</p>
    <p>B D H A B R</p>
    <p>pivots the rest buffer</p>
    <p>A B-tree is a search tree (like a B-tree)</p>
  </div>
  <div class="page">
    <p>B-Trees</p>
    <p>B A B B B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>B D H A B R</p>
    <p>the rest buffer</p>
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree pivots</p>
  </div>
  <div class="page">
    <p>B-Trees</p>
    <p>B A B B B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>B D H A B R</p>
    <p>the rest buffer</p>
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree</p>
    <p>/orange/A /orange/A</p>
    <p>pivots</p>
  </div>
  <div class="page">
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree</p>
    <p>B-Trees</p>
    <p>B A B B B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>D</p>
    <p>B D H A B R</p>
    <p>Inserts get put in the root bufferNew file:</p>
    <p>/orange/D</p>
  </div>
  <div class="page">
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree</p>
    <p>B-Trees</p>
    <p>B A B B B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>D</p>
    <p>B D H A B RD</p>
    <p>/orange/D</p>
    <p>Inserts get put in the root buffer</p>
  </div>
  <div class="page">
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree</p>
    <p>B-Trees</p>
    <p>B A</p>
    <p>Z</p>
    <p>B B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>D</p>
    <p>B D H A B RD</p>
    <p>/orange/D</p>
    <p>Inserts get put in the root buffer</p>
  </div>
  <div class="page">
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree</p>
    <p>B-Trees</p>
    <p>B A Z B B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>D</p>
    <p>B D H A B RDZ</p>
    <p>/blue/Z</p>
    <p>Inserts get put in the root buffer</p>
  </div>
  <div class="page">
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree</p>
    <p>B-Trees</p>
    <p>B A Z</p>
    <p>F</p>
    <p>B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>D</p>
    <p>B D H A B RDZ</p>
    <p>/blue/Z</p>
    <p>Inserts get put in the root buffer</p>
  </div>
  <div class="page">
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree</p>
    <p>B-Trees</p>
    <p>B A Z F B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>D</p>
    <p>FB D H A B RDZ</p>
    <p>/orange/F</p>
    <p>Inserts get put in the root buffer</p>
  </div>
  <div class="page">
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree</p>
    <p>B-Trees</p>
    <p>B A Z F</p>
    <p>B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>D</p>
    <p>FB D H A B RDZ</p>
    <p>/orange/F</p>
    <p>Inserts get put in the root buffer</p>
  </div>
  <div class="page">
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree</p>
    <p>B-Trees</p>
    <p>B A Z F B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>D</p>
    <p>FB D H A B RDZ B</p>
    <p>/violet/B</p>
    <p>When a buffer is full: 1. Pick child receiving</p>
    <p>most messages 2. Move them to the</p>
    <p>childs buffer</p>
    <p>Inserts get put in the root buffer</p>
  </div>
  <div class="page">
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree When a buffer is full: 1. Pick child receiving</p>
    <p>most messages 2. Move them to the</p>
    <p>childs buffer</p>
    <p>Inserts get put in the root buffer</p>
    <p>B-Trees</p>
    <p>B A Z F</p>
    <p>B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>D</p>
    <p>FB D H A B RDZ</p>
    <p>/violet/B</p>
    <p>B</p>
  </div>
  <div class="page">
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree When a buffer is full: 1. Pick child receiving</p>
    <p>most messages 2. Move them to the</p>
    <p>childs buffer</p>
    <p>Inserts get put in the root buffer</p>
    <p>B-Trees</p>
    <p>B A Z B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>D F</p>
    <p>FB D H A B RDZ</p>
    <p>/violet/B</p>
    <p>B</p>
  </div>
  <div class="page">
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree When a buffer is full: 1. Pick child receiving</p>
    <p>most messages 2. Move them to the</p>
    <p>childs buffer</p>
    <p>Inserts get put in the root buffer</p>
    <p>B-Trees</p>
    <p>B A Z B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>D F</p>
    <p>FB D H A B RDZ</p>
    <p>/violet/B</p>
    <p>B</p>
    <p>L</p>
  </div>
  <div class="page">
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree When a buffer is full: 1. Pick child receiving</p>
    <p>most messages 2. Move them to the</p>
    <p>childs buffer</p>
    <p>Inserts get put in the root buffer</p>
    <p>B-Trees</p>
    <p>B A Z B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>D F</p>
    <p>FB D H A B RDZ</p>
    <p>/green/L</p>
    <p>B</p>
    <p>L</p>
    <p>L</p>
  </div>
  <div class="page">
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree When a buffer is full: 1. Pick child receiving</p>
    <p>most messages 2. Move them to the</p>
    <p>childs buffer</p>
    <p>Inserts get put in the root buffer</p>
    <p>B-Trees</p>
    <p>B A Z B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>D F</p>
    <p>FB D H A B RDZ</p>
    <p>/green/L</p>
    <p>B</p>
    <p>L</p>
    <p>L</p>
    <p>T</p>
  </div>
  <div class="page">
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree When a buffer is full: 1. Pick child receiving</p>
    <p>most messages 2. Move them to the</p>
    <p>childs buffer</p>
    <p>Inserts get put in the root buffer</p>
    <p>B-Trees</p>
    <p>B A Z B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>D F</p>
    <p>FB D H A B RDZ</p>
    <p>/orange/T</p>
    <p>B</p>
    <p>L</p>
    <p>L</p>
    <p>T</p>
    <p>T</p>
  </div>
  <div class="page">
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree When a buffer is full: 1. Pick child receiving</p>
    <p>most messages 2. Move them to the</p>
    <p>childs buffer</p>
    <p>Inserts get put in the root buffer</p>
    <p>B-Trees</p>
    <p>B A Z B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>D F</p>
    <p>FB D H A B RDZ B</p>
    <p>L</p>
    <p>L</p>
    <p>T</p>
    <p>T</p>
    <p>/orange/T</p>
  </div>
  <div class="page">
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree When a buffer is full: 1. Pick child receiving</p>
    <p>most messages 2. Move them to the</p>
    <p>childs buffer</p>
    <p>Inserts get put in the root buffer</p>
    <p>B-Trees</p>
    <p>B A Z B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>D F</p>
    <p>FB D H A B RDZ B</p>
    <p>L</p>
    <p>L</p>
    <p>T</p>
    <p>T</p>
    <p>/orange/T</p>
  </div>
  <div class="page">
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>directory tree When a buffer is full: 1. Pick child receiving</p>
    <p>most messages 2. Move them to the</p>
    <p>childs buffer</p>
    <p>Inserts get put in the root buffer</p>
    <p>B-Trees</p>
    <p>B A Z B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B R</p>
    <p>D F</p>
    <p>FB D H A B RDZ B</p>
    <p>L</p>
    <p>L</p>
    <p>T</p>
    <p>T</p>
    <p>/orange/T</p>
  </div>
  <div class="page">
    <p>B-Trees</p>
    <p>B A Z B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B RD F</p>
    <p>FB D H A B RDZ B</p>
    <p>Inserts get put in the root buffer</p>
    <p>When a buffer is full: 1. Pick child receiving</p>
    <p>most messages 2. Move them to the</p>
    <p>childs buffer</p>
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>L</p>
    <p>L</p>
    <p>T</p>
    <p>T</p>
    <p>directory tree</p>
    <p>/orange/T</p>
  </div>
  <div class="page">
    <p>B-Trees</p>
    <p>B A Z B</p>
    <p>A R</p>
    <p>/</p>
    <p>G A C F</p>
    <p>B D H A B RD F</p>
    <p>FB D H A B RDZ B</p>
    <p>Inserts get put in the root buffer</p>
    <p>When a buffer is full: 1. Pick child receiving</p>
    <p>most messages 2. Move them to the</p>
    <p>childs buffer</p>
    <p>A B-tree is a search tree (like a B-tree)</p>
    <p>L</p>
    <p>L</p>
    <p>T</p>
    <p>T</p>
    <p>directory tree</p>
    <p>/orange/T Key Insight: Each flush applies many small changes</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>B S Z</p>
    <p>A R LL M</p>
    <p>A AJ H</p>
    <p>Copy /green to /red</p>
    <p>B</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>B S Z</p>
    <p>A AJ H</p>
    <p>Node covering /green/ subtree</p>
    <p>B</p>
    <p>A R LL M</p>
    <p>Copy /green to /red</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>B S Z</p>
    <p>A AJ H B</p>
    <p>A R LL M</p>
    <p>Every /green/* file is in this subtree</p>
    <p>Node covering /green/ subtree</p>
    <p>Copy /green to /red</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>B S Z</p>
    <p>A AJ H B</p>
    <p>A R L</p>
    <p>M</p>
    <p>Every /green/* file is in this subtree</p>
    <p>Node covering /green/ subtree</p>
    <p>Copy /green to /red</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>B S Z</p>
    <p>A AJ H</p>
    <p>Would like to logically copy by adding this edge</p>
    <p>B</p>
    <p>A R LL MNode covering /green/ subtree</p>
    <p>Copy /green to /red</p>
    <p>Every /green/* file is in this subtree</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>B S Z</p>
    <p>A AJ H</p>
    <p>Would like to logically copy by adding this edge</p>
    <p>B</p>
    <p>A R LL MNode covering /green/ subtree</p>
    <p>Copy /green to /red</p>
    <p>Every /green/* file is in this subtree</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>B S Z</p>
    <p>A AJ H</p>
    <p>Would like to logically copy by adding this edge</p>
    <p>PROBLEM: A lookup for /red/M is going to</p>
    <p>see /green/M in the subtree</p>
    <p>B</p>
    <p>A R LL MNode covering /green/ subtree</p>
    <p>Copy /green to /red</p>
    <p>Every /green/* file is in this subtree</p>
  </div>
  <div class="page">
    <p>A R LL M</p>
    <p>Logical Copy with B-DAGs</p>
    <p>B S Z</p>
    <p>A AJ H B</p>
    <p>Solution: Pivots can include a prefix translation</p>
    <p>Would like to logically copy by adding this edge</p>
    <p>Node covering /green/ subtree</p>
    <p>Copy /green to /red</p>
    <p>Every /green/* file is in this subtree</p>
    <p>PROBLEM: A lookup for /red/M is going to</p>
    <p>see /green/M in the subtree</p>
  </div>
  <div class="page">
    <p>A R LL M</p>
    <p>Logical Copy with B-DAGs</p>
    <p>B S Z</p>
    <p>A AJ H B</p>
    <p>Solution: Pivots can include a prefix translation</p>
    <p>Would like to logically copy by adding this edge</p>
    <p>Node covering /green/ subtree</p>
    <p>Copy /green to /red</p>
    <p>/red/ /green/</p>
    <p>Every /green/* file is in this subtree</p>
    <p>PROBLEM: A lookup for /red/M is going to</p>
    <p>see /green/M in the subtree</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>B S Z</p>
    <p>A AJ H</p>
    <p>Read(/red/M)</p>
    <p>B</p>
    <p>A R LL MNode covering /green/ subtree</p>
    <p>Copy /green to /red</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>B S Z</p>
    <p>A AJ H B</p>
    <p>A R LL M</p>
    <p>Read(/red/M)</p>
    <p>Node covering /green/ subtree</p>
    <p>Copy /green to /red</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>B S Z</p>
    <p>A AJ H B</p>
    <p>A R LL M</p>
    <p>Read(/red/M)</p>
    <p>Node covering /green/ subtree</p>
    <p>Copy /green to /red</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>B S Z</p>
    <p>A AJ H Read(/red/M)B</p>
    <p>A R LL M</p>
    <p>Read(/red/M)</p>
    <p>Node covering /green/ subtree</p>
    <p>Copy /green to /red</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>B S Z</p>
    <p>A AJ H Read(/red/M)B</p>
    <p>A R LL M</p>
    <p>Read(/red/M)</p>
    <p>Node covering /green/ subtree</p>
    <p>Copy /green to /red</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>B S Z</p>
    <p>A AJ H</p>
    <p>Read(/green/M)</p>
    <p>B</p>
    <p>A R LL M</p>
    <p>Read(/red/M)</p>
    <p>Read(/red/M)</p>
    <p>Node covering /green/ subtree</p>
    <p>Copy /green to /red</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>B S Z</p>
    <p>A AJ H B</p>
    <p>A R LL M</p>
    <p>Read(/green/M)</p>
    <p>Read(/red/M)</p>
    <p>Read(/red/M)</p>
    <p>Node covering /green/ subtree</p>
    <p>Copy /green to /red</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A AJ H</p>
    <p>Make some small writes to /red/</p>
    <p>B</p>
    <p>A R LL M</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A AJ H</p>
    <p>B</p>
    <p>B</p>
    <p>A R LL M</p>
    <p>Make some small writes to /red/</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A AJ H</p>
    <p>B Q</p>
    <p>B</p>
    <p>A R LL M</p>
    <p>Make some small writes to /red/</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A AJ H</p>
    <p>B Q Z</p>
    <p>B</p>
    <p>A R LL M</p>
    <p>Make some small writes to /red/</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A AJ H</p>
    <p>B Q Z</p>
    <p>B</p>
    <p>A R LL M</p>
    <p>Make some small writes to /red/</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A AJ H B Q ZB</p>
    <p>A R LL M</p>
    <p>Make some small writes to /red/</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A AJ H B Q Z</p>
    <p>B</p>
    <p>A R LL M</p>
    <p>Make some small writes to /red/</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A AJ H B Q Z</p>
    <p>B</p>
    <p>Now flush with copy-on-write</p>
    <p>A R LL M</p>
    <p>Make some small writes to /red/</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A R LL M</p>
    <p>A AJ H B Q Z</p>
    <p>B</p>
    <p>A R LL M</p>
    <p>Now flush with copy-on-write</p>
    <p>Make some small writes to /red/</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A R LL M</p>
    <p>A AJ H B Q Z</p>
    <p>B</p>
    <p>A R LL M</p>
    <p>Now flush with copy-on-write</p>
    <p>Make some small writes to /red/</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A R LL M</p>
    <p>A AJ H B Q Z</p>
    <p>B</p>
    <p>A R L M</p>
    <p>Now flush with copy-on-write</p>
    <p>Make some small writes to /red/</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A R LL M</p>
    <p>A AJ H B Q Z</p>
    <p>B</p>
    <p>A R L M</p>
    <p>Now flush with copy-on-write</p>
    <p>unreachable data</p>
    <p>Make some small writes to /red/</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A R LL M</p>
    <p>A AJ H B Q Z</p>
    <p>B</p>
    <p>A R M</p>
    <p>Now flush with copy-on-write</p>
    <p>Make some small writes to /red/</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A R LL M</p>
    <p>A AJ H B Q Z</p>
    <p>B</p>
    <p>A R M</p>
    <p>Now flush with copy-on-write</p>
    <p>Make some small writes to /red/</p>
    <p>translation</p>
    <p>/red/ /green/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A R LL M</p>
    <p>A AJ H B Q Z</p>
    <p>B</p>
    <p>A R M</p>
    <p>Now flush with copy-on-write</p>
    <p>/re d/</p>
    <p>/g re</p>
    <p>en /</p>
    <p>Make some small writes to /red/</p>
    <p>/re d/</p>
    <p>/gr ee</p>
    <p>n/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A R LL M</p>
    <p>A AJ H B Q Z</p>
    <p>B</p>
    <p>A R M</p>
    <p>Now flush with copy-on-write</p>
    <p>Make some small writes to /red/</p>
    <p>/re d/</p>
    <p>/g re</p>
    <p>en /</p>
    <p>/re d/</p>
    <p>/gr ee</p>
    <p>n/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A R LL M</p>
    <p>A AJ H B</p>
    <p>A R M</p>
    <p>Now flush with copy-on-write</p>
    <p>Make some small writes to /red/</p>
    <p>/re d/</p>
    <p>/g re</p>
    <p>en /</p>
    <p>/re d/</p>
    <p>/gr ee</p>
    <p>n/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A R LL M</p>
    <p>A AJ H B</p>
    <p>A R M</p>
    <p>Now flush with copy-on-write</p>
    <p>Applied multiple small changes</p>
    <p>Make some small writes to /red/</p>
    <p>/re d/</p>
    <p>/g re</p>
    <p>en /</p>
    <p>/re d/</p>
    <p>/gr ee</p>
    <p>n/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A R LL M</p>
    <p>A AJ H B</p>
    <p>A R M</p>
    <p>Now flush with copy-on-write</p>
    <p>Applied multiple small changes</p>
    <p>Broke sharing of one node</p>
    <p>Make some small writes to /red/</p>
    <p>/re d/</p>
    <p>/g re</p>
    <p>en /</p>
    <p>/re d/</p>
    <p>/gr ee</p>
    <p>n/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A R LL M</p>
    <p>A AJ H B</p>
    <p>A R M</p>
    <p>Now flush with copy-on-write</p>
    <p>Applied multiple small changes</p>
    <p>Broke sharing of one node</p>
    <p>Still sharing rest of subtree</p>
    <p>Make some small writes to /red/</p>
    <p>/re d/</p>
    <p>/g re</p>
    <p>en /</p>
    <p>/re d/</p>
    <p>/gr ee</p>
    <p>n/</p>
  </div>
  <div class="page">
    <p>B-DAGs and Small Writes</p>
    <p>B S Z</p>
    <p>A R LL M</p>
    <p>A AJ H B</p>
    <p>A R M</p>
    <p>Make some small writes to /red/</p>
    <p>Now flush with copy-on-write</p>
    <p>Applied multiple small changes</p>
    <p>Broke sharing of one node</p>
    <p>Still sharing rest of subtree</p>
    <p>Copy-on-Abundant-Write</p>
    <p>/re d/</p>
    <p>/g re</p>
    <p>en /</p>
    <p>/re d/</p>
    <p>/gr ee</p>
    <p>n/</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>Space efficient</p>
    <p>Low latency</p>
    <p>Fast writes</p>
    <p>Fast reads</p>
    <p>Copy-specific General file system</p>
    <p>Performance Goals</p>
    <p>?</p>
    <p>?</p>
    <p>?</p>
    <p>?</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>Space efficient</p>
    <p>Low latency</p>
    <p>Fast writes</p>
    <p>Fast reads</p>
    <p>Performance Goals</p>
    <p>?</p>
    <p>?</p>
    <p>B -t rees</p>
    <p>hav e la</p>
    <p>rge nod</p>
    <p>es</p>
    <p>Loc ality</p>
    <p>*</p>
    <p>Copy-specific General file system</p>
    <p>*File Systems Fated for Senescence? Nonsense, Says Science!, Conway et al, FAST 2017</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>Space efficient</p>
    <p>Low latency</p>
    <p>Fast writes</p>
    <p>Fast reads</p>
    <p>Performance Goals</p>
    <p>?</p>
    <p>B -trees hav</p>
    <p>e la rge</p>
    <p>nod es</p>
    <p>Cop y-on</p>
    <p>-Abu ndan</p>
    <p>t-Wr ite</p>
    <p>Copy-specific General file system</p>
    <p>Loc ality</p>
    <p>*</p>
    <p>*File Systems Fated for Senescence? Nonsense, Says Science!, Conway et al, FAST 2017</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>A A</p>
    <p>LG L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>Copy /green to /violet</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>A A</p>
    <p>LG L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>Copy /green to /violet</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>A A</p>
    <p>LG</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C RL</p>
    <p>Copy /green to /violet</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>A A</p>
    <p>LG</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>L</p>
    <p>Copy /green to /violet</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>Copy /green to /violet</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>G O</p>
    <p>TO</p>
    <p>Copy /green to /violet</p>
    <p>/v io</p>
    <p>le t/</p>
    <p>/g re</p>
    <p>en /</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO</p>
    <p>Copy /green to /violet</p>
    <p>/v io</p>
    <p>le t/</p>
    <p>/g re</p>
    <p>en /</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>Copy /green to /violet</p>
    <p>/v io</p>
    <p>le t/</p>
    <p>/g re</p>
    <p>en /</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO</p>
    <p>When a lookup finds a GOTO message, it skips to the target</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>Copy /green to /violet</p>
    <p>/v io</p>
    <p>le t/</p>
    <p>/g re</p>
    <p>en /</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO</p>
    <p>When a lookup finds a GOTO message, it skips to the target</p>
    <p>Read(/violet/H)</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>Copy /green to /violet</p>
    <p>/v io</p>
    <p>le t/</p>
    <p>/g re</p>
    <p>en /</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO</p>
    <p>When a lookup finds a GOTO message, it skips to the target</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>Copy /green to /violet</p>
    <p>Read(/violet/H)</p>
    <p>/v io</p>
    <p>le t/</p>
    <p>/g re</p>
    <p>en /</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO</p>
    <p>When a lookup finds a GOTO message, it skips to the target</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>Copy /green to /violet</p>
    <p>Read(/violet/H)</p>
    <p>/v io</p>
    <p>le t/</p>
    <p>/g re</p>
    <p>en /</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO</p>
    <p>When a lookup finds a GOTO message, it skips to the target</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>Copy /green to /violet</p>
    <p>Read(/violet/H)</p>
    <p>/v io</p>
    <p>le t/</p>
    <p>/g re</p>
    <p>en /</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO</p>
    <p>When a lookup finds a GOTO message, it skips to the target</p>
    <p>The GOTO translates into Read(/green/H)</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>Copy /green to /violet</p>
    <p>Read(/violet/H)</p>
    <p>/v io</p>
    <p>le t/</p>
    <p>/g re</p>
    <p>en /</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>B D H</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO</p>
    <p>When a lookup finds a GOTO message, it skips to the target</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>The GOTO translates into Read(/green/H)</p>
    <p>/v io</p>
    <p>le t/</p>
    <p>/g re</p>
    <p>en /</p>
    <p>Copy /green to /violet</p>
    <p>Read(/violet/H)</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>B D H</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO</p>
    <p>When a lookup finds a GOTO message, it skips to the target</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>The GOTO translates into Read(/green/H)</p>
    <p>/v io</p>
    <p>le t/</p>
    <p>/g re</p>
    <p>en /</p>
    <p>Copy /green to /violet</p>
    <p>Read(/violet/H)</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>B D H</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO</p>
    <p>Copy /green to /violet</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>/v io</p>
    <p>le t/</p>
    <p>/g re</p>
    <p>en /</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>B D H</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO</p>
    <p>D</p>
    <p>Copy /green to /violet</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>/v io</p>
    <p>le t/</p>
    <p>/g re</p>
    <p>en /</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>B D H</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO</p>
    <p>D Z</p>
    <p>Copy /green to /violet</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>/v io</p>
    <p>le t/</p>
    <p>/g re</p>
    <p>en /</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>B D H</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO</p>
    <p>D Z</p>
    <p>Copy /green to /violet</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>/v io</p>
    <p>le t/</p>
    <p>/g re</p>
    <p>en /</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>B D H</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO D Z</p>
    <p>Copy /green to /violet</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>/vi ole</p>
    <p>t/ /gr</p>
    <p>ee n/</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>B D H</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO D Z</p>
    <p>E</p>
    <p>Copy /green to /violet</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>/vi ole</p>
    <p>t/ /gr</p>
    <p>ee n/</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>B D H</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO D Z</p>
    <p>E N</p>
    <p>Copy /green to /violet</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>/vi ole</p>
    <p>t/ /gr</p>
    <p>ee n/</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>B D H</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO D Z</p>
    <p>E N E</p>
    <p>Copy /green to /violet</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>/vi ole</p>
    <p>t/ /gr</p>
    <p>ee n/</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>B D H</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO D Z</p>
    <p>E N E</p>
    <p>Copy /green to /violet</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>/vi ole</p>
    <p>t/ /gr</p>
    <p>ee n/</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>B D H</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO D Z E N E</p>
    <p>Copy /green to /violet</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>/vi ole</p>
    <p>t/ /gr</p>
    <p>ee n/</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>B D H</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO D Z E N</p>
    <p>E</p>
    <p>Copy /green to /violet</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>/vi ole</p>
    <p>t/ /gr</p>
    <p>ee n/</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>B D H</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO</p>
    <p>D</p>
    <p>Z E N</p>
    <p>E</p>
    <p>Copy /green to /violet</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>/violet/ /green/</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>B D H</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO</p>
    <p>D</p>
    <p>Z E N</p>
    <p>E</p>
    <p>When the GOTO reaches the height of its target + 1, it becomes a real pivot</p>
    <p>Copy /green to /violet</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>/violet/ /green/</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>B D H</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>G O</p>
    <p>TO</p>
    <p>D</p>
    <p>Z E N</p>
    <p>E</p>
    <p>When the GOTO reaches the height of its target + 1, it becomes a real pivot</p>
    <p>Copy /green to /violet</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>/violet/ /green/</p>
  </div>
  <div class="page">
    <p>Reducing Copy Latency in B-DAGs</p>
    <p>V</p>
    <p>B D H</p>
    <p>A A</p>
    <p>LG</p>
    <p>L</p>
    <p>ZAU</p>
    <p>S J</p>
    <p>C R</p>
    <p>GOTO A GOTO message changes</p>
    <p>the structure of the tree</p>
    <p>D</p>
    <p>Z E N</p>
    <p>E</p>
    <p>When the GOTO reaches the height of its target + 1, it becomes a real pivot</p>
    <p>A</p>
    <p>Copy /green to /violet</p>
    <p>It functions as a pivot including prefix translation</p>
    <p>/violet/ /green/</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>Space efficient</p>
    <p>Low latency</p>
    <p>Fast writes</p>
    <p>Fast reads</p>
    <p>Performance Goals</p>
    <p>?</p>
    <p>B -trees hav</p>
    <p>e la rge</p>
    <p>nod es</p>
    <p>Cop y-on</p>
    <p>-Abu ndan</p>
    <p>t-Wr ite</p>
    <p>Copy-specific General file system</p>
    <p>Loc ality</p>
    <p>*</p>
    <p>*File Systems Fated for Senescence? Nonsense, Says Science!, Conway et al, FAST 2017</p>
  </div>
  <div class="page">
    <p>Logical Copy with B-DAGs</p>
    <p>Space efficient</p>
    <p>Low latency</p>
    <p>Fast writes</p>
    <p>Fast reads</p>
    <p>Performance Goals</p>
    <p>B -trees hav</p>
    <p>e la rge</p>
    <p>nod es</p>
    <p>Cop y-on</p>
    <p>-Abu ndan</p>
    <p>t-Wr ite</p>
    <p>Copy-specific General file system</p>
    <p>Loc ality</p>
    <p>*</p>
    <p>*File Systems Fated for Senescence? Nonsense, Says Science!, Conway et al, FAST 2017</p>
    <p>GOT O m</p>
    <p>essa ges</p>
  </div>
  <div class="page">
    <p>Evaluation</p>
  </div>
  <div class="page">
    <p>Space Amplification and Fragmention</p>
    <p>ep ti</p>
    <p>m e</p>
    <p>(s ec</p>
    <p>on ds</p>
    <p>)</p>
    <p>Logical copy number 0 1 2 3 4 5 6 7 8</p>
    <p>BTRFS XFS ZFS BetrFS</p>
    <p>S pa</p>
    <p>ce A</p>
    <p>m pl</p>
    <p>ifi ca</p>
    <p>tio n</p>
    <p>BTRFS XFS ZFS BetrFS</p>
    <p>Init: 64 4MiB files with random data. Each round: logically copy all files, then change 16B in each file (1KiB total)</p>
    <p>Fragmentation measured by timing a grep over the file system</p>
    <p>Space Amplification additional file system size / added data (1KiB)</p>
    <p>Lo w</p>
    <p>er is</p>
    <p>B et</p>
    <p>te r</p>
    <p>Dell Optiplex 790 4-core 3.40 GHz Intel Core i7 CPU</p>
  </div>
  <div class="page">
    <p>Space Amplification and Fragmention</p>
    <p>ep ti</p>
    <p>m e</p>
    <p>(s ec</p>
    <p>on ds</p>
    <p>)</p>
    <p>Logical copy number 0 1 2 3 4 5 6 7 8</p>
    <p>BTRFS XFS ZFS BetrFS</p>
    <p>S pa</p>
    <p>ce A</p>
    <p>m pl</p>
    <p>ifi ca</p>
    <p>tio n</p>
    <p>BTRFS XFS ZFS BetrFS</p>
    <p>Init: 64 4MiB files with random data. Each round: logically copy all files, then change 16B in each file (1KiB total)</p>
    <p>Fragmentation measured by timing a grep over the file system</p>
    <p>Space Amplification additional file system size / added data (1KiB)</p>
    <p>Lo w</p>
    <p>er is</p>
    <p>B et</p>
    <p>te r</p>
    <p>Low space amplification and low fragmentation</p>
    <p>Dell Optiplex 790 4-core 3.40 GHz Intel Core i7 CPU</p>
  </div>
  <div class="page">
    <p>Copy Latency</p>
    <p>tim e</p>
    <p>(s ec</p>
    <p>on ds</p>
    <p>)</p>
    <p>Logical copy number 0 1 2 3 4 5 6 7 8</p>
    <p>BTRFS XFS ZFS BetrFS</p>
    <p>Init: 64 4MiB files with random data. Each round: logically copy all files, then change 16B in each file (1KiB total)</p>
    <p>Copy Latency time to perform the copy</p>
    <p>Lo w</p>
    <p>er is</p>
    <p>B et</p>
    <p>te r</p>
    <p>Dell Optiplex 790 4-core 3.40 GHz Intel Core i7 CPU</p>
  </div>
  <div class="page">
    <p>Copy Latency</p>
    <p>tim e</p>
    <p>(s ec</p>
    <p>on ds</p>
    <p>)</p>
    <p>Logical copy number 0 1 2 3 4 5 6 7 8</p>
    <p>BTRFS XFS ZFS BetrFS</p>
    <p>Init: 64 4MiB files with random data. Each round: logically copy all files, then change 16B in each file (1KiB total)</p>
    <p>Copy Latency time to perform the copy</p>
    <p>Low latency</p>
    <p>Lo w</p>
    <p>er is</p>
    <p>B et</p>
    <p>te r</p>
    <p>Dell Optiplex 790 4-core 3.40 GHz Intel Core i7 CPU</p>
  </div>
  <div class="page">
    <p>General File System Microbenchmarks</p>
    <p>Th ro</p>
    <p>ug hp</p>
    <p>ut (M</p>
    <p>iB /s</p>
    <p>ec )</p>
    <p>Sequential Read Sequential Write</p>
    <p>ext4 BTRFS XFS ZFS BtrFS 0.4 BtrFS 0.5</p>
    <p>Ti m</p>
    <p>e (s</p>
    <p>ec on</p>
    <p>ds )</p>
    <p>Random Read Random Write</p>
    <p>Lo w</p>
    <p>er is</p>
    <p>B et</p>
    <p>te r</p>
    <p>H ig</p>
    <p>he r i</p>
    <p>s B</p>
    <p>et te</p>
    <p>r</p>
    <p>BtrFS 0.5 5.5 seconds</p>
  </div>
  <div class="page">
    <p>Application Benchmarks</p>
    <p>Ti m</p>
    <p>e (s</p>
    <p>ec on</p>
    <p>ds )</p>
    <p>git clone git diff tar untar</p>
    <p>ext4 BTRFS XFS ZFS BtrFS 0.4 BtrFS 0.5 BtrFS 0.5 (copy)</p>
    <p>B an</p>
    <p>dw id</p>
    <p>th (M</p>
    <p>iB /s</p>
    <p>ec )</p>
    <p>rsync -in-place rsync rename</p>
    <p>Th ro</p>
    <p>ug hp</p>
    <p>ut (o</p>
    <p>ps /s</p>
    <p>ec )</p>
    <p>IMAP</p>
    <p>H ig</p>
    <p>he r i</p>
    <p>s B</p>
    <p>et te</p>
    <p>r</p>
    <p>H ig</p>
    <p>he r i</p>
    <p>s B</p>
    <p>et te</p>
    <p>r</p>
    <p>Lo w</p>
    <p>er is</p>
    <p>B et</p>
    <p>te r</p>
  </div>
  <div class="page">
    <p>Technical Conclusions</p>
    <p>B-DAGs transform copy-on-write into copy-on-abundant-write</p>
    <p>Gives strong bounds on space amplification  Preserves locality, even with small writes  Exploits B-trees batching and flushing</p>
    <p>B-DAGs preserve the fast reads and writes of B-trees</p>
    <p>Preserve logarithmic tree height and query cost  Preserve asymptotic costs of inserts and updates</p>
    <p>Copies are fast and cheap</p>
    <p>GOTO messages enable low-latency DAG mutations  Total work of copies is O(tree height)</p>
  </div>
  <div class="page">
    <p>Evaluation Conclusions</p>
    <p>BetrFS with B-DAGs has strong copy performance in practice</p>
    <p>Low space amplification  Low latency copying  Good locality</p>
    <p>B-DAGs preserve BetrFSs performance gains on other operations</p>
    <p>Fast random writes  Good sequential I/O throughput  No aging  Strong across-the-board application benchmark performance</p>
  </div>
  <div class="page">
    <p>Thank you!</p>
  </div>
</Presentation>
