<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>A Bad Dream: Subverting Trusted</p>
    <p>Platform Module While You Are Sleeping</p>
    <p>Seunghun Han</p>
    <p>National Security Research Institute</p>
  </div>
  <div class="page">
    <p>Outline</p>
    <p>Background</p>
    <p>Assumptions and Threat Model</p>
    <p>Vulnerabilities and Exploits  CVE-2018-6622</p>
    <p>CVE-2017-16837</p>
    <p>Evaluation</p>
    <p>Countermeasures</p>
    <p>Conclusion</p>
  </div>
  <div class="page">
    <p>Trusted Computing Group (TCG)</p>
    <p>Defines global industry specifications and standards</p>
    <p>Is supportive of a hardware root of trust</p>
    <p>Trusted Platform Module (TPM) is the core</p>
    <p>technology</p>
    <p>TCG technology has been applied to Unified</p>
    <p>Extensible Firmware Interface (UEFI)</p>
  </div>
  <div class="page">
    <p>Trusted Platform Module (TPM) (1)</p>
    <p>Is a tamper-resistant device</p>
    <p>Has own processor, RAM, ROM, and non-volatile</p>
    <p>RAM</p>
    <p>It has own state separated from the system</p>
    <p>Provides cryptographic and accumulating</p>
    <p>measurements functions</p>
    <p>Measurement values are accumulated to Platform</p>
    <p>Configuration Registers (PCR #0~#23)</p>
  </div>
  <div class="page">
    <p>Trusted Platform Module (TPM) (2)</p>
    <p>Is used to determine the trustworthiness of a system by investigating the values stored in PCRs</p>
    <p>A local verification or remote attestation can be used</p>
    <p>Is used to limit access to secret data based on specific PCR values</p>
    <p>Seal operation encrypts secret data with the PCRs of the TPM</p>
    <p>Unseal operation can decrypt the sealed data only if the PCR values match the specific values</p>
  </div>
  <div class="page">
    <p>Root of Trust for Measurement (RTM)</p>
    <p>Sends integrity-relevant information (measurements)</p>
    <p>to the TPM</p>
    <p>TPM accumulates the measurements to a PCR with</p>
    <p>the previously stored value in the PCR</p>
    <p>Is the CPU controlled by Core RTM (CRTM)</p>
    <p>The CRTM is the first set of instructions when a new</p>
    <p>chain of trust is established</p>
    <p>Extend: PCRnew = Hash(PCRold || Measurementnew)</p>
  </div>
  <div class="page">
    <p>Static and Dynamic RTM (SRTM and DRTM)</p>
    <p>SRTM is started by static CRTM (S-CRTM) when the</p>
    <p>host platform starts at POWER-ON or RESTART</p>
    <p>DRTM is started by dynamic CRTM (D-CRTM) at</p>
    <p>runtime WITHOUT platform RESET</p>
    <p>They extend measurements (hashes) of components</p>
    <p>to PCRs BEFORE passing control to them</p>
  </div>
  <div class="page">
    <p>: Extend a hash of next code to TPM</p>
    <p>: Execute next code</p>
    <p>BIOS/UEFI firmware</p>
    <p>BIOS/UEFI</p>
    <p>Code</p>
    <p>TPM</p>
    <p>Bootloader Kernel User</p>
    <p>Applications</p>
    <p>Static Root of Trust for Measurement</p>
    <p>S-CRTM</p>
    <p>Power On/</p>
    <p>Restart</p>
    <p>D-CRTM (DCE)</p>
    <p>TPM</p>
    <p>tboot (DLME)</p>
    <p>Bootloader User</p>
    <p>Applications</p>
    <p>Dynamic Root of Trust for Measurement (Intel Trusted Execution Technology)</p>
    <p>Untrusted</p>
    <p>Code</p>
    <p>DL Event</p>
    <p>Kernel</p>
    <p>DL Event : Dynamic Launch Event</p>
    <p>DCE: DRTM Configuration Environment</p>
    <p>DLME: Dynamically Launched Measured Environment</p>
  </div>
  <div class="page">
    <p>PCR Protection</p>
    <p>PCRs contains measurement results of a system</p>
    <p>They MUST NOT be reset by disallowed operations</p>
    <p>Static PCRs (PCR #0~#15) can be reset only if the host resets</p>
    <p>Dynamic PCRs (PCR #17~#19) can be reset only if the host</p>
    <p>initializes the DRTM</p>
    <p>If PCRs are reset by attackers, they can reproduce</p>
    <p>specific PCR values by replaying hashes</p>
    <p>They can steal the secret and deceive the local and remote</p>
    <p>verification 9/26</p>
  </div>
  <div class="page">
    <p>PCR protection mechanisms</p>
    <p>work properly</p>
    <p>UNTIL YESTERDAY</p>
  </div>
  <div class="page">
    <p>Assumptions and Threat Model</p>
    <p>The system measures boot components using the SRTM</p>
    <p>and DRTM</p>
    <p>The measurement results stored in PCRs are verified by a remote</p>
    <p>verifier</p>
    <p>The modifications of boot components are detected</p>
    <p>The attackers already gain a root privilege and try to</p>
    <p>compromise the whole system</p>
    <p>They try to hide the breach and retain the root privilege</p>
    <p>They cannot access the system circuit physically</p>
    <p>They cannot flash the firmware with arbitrary code 11/26</p>
  </div>
  <div class="page">
    <p>Advanced Configuration and Power Interface (ACPI)</p>
    <p>Defines power states and hardware register sets</p>
    <p>Global states</p>
    <p>G0 (Working), G1 (Sleeping), G2 (Soft-off), G3</p>
    <p>(Mechanical-off)</p>
    <p>Sleeping states</p>
    <p>S0 and S1: Working and Power on Suspend</p>
    <p>S2: Same as S1, CPU is powered off</p>
    <p>S3: Sleep, All devices are powered off except RAM</p>
    <p>S4: Hibernation, All devices are powered off</p>
  </div>
  <div class="page">
    <p>OS</p>
    <p>ACPI (BIOS/UEFI)</p>
    <p>TPM</p>
    <p>(1) Request</p>
    <p>to save a state</p>
    <p>Sleep (S3, S4)</p>
    <p>(5) Request</p>
    <p>to restore a state</p>
    <p>(2) Request to</p>
    <p>enter sleep</p>
    <p>(4) Wake up(3) Sleep</p>
    <p>(6) Resume OS</p>
    <p>ACPI Sleep Process with TPM</p>
  </div>
  <div class="page">
    <p>OS</p>
    <p>ACPI (BIOS/UEFI)</p>
    <p>TPM</p>
    <p>(1) Request</p>
    <p>to save a state</p>
    <p>Sleep (S3, S4)</p>
    <p>(5) Request</p>
    <p>to restore a state</p>
    <p>(2) Request to</p>
    <p>enter sleep</p>
    <p>(4) Wake up(3) Sleep</p>
    <p>(6) Resume OS</p>
    <p>ACPI Sleep Process with TPM</p>
    <p>The Grey Area vulnerability</p>
    <p>(CVE-2018-6622)</p>
  </div>
  <div class="page">
    <p>The Grey Area Vulnerability (CVE-2018-6622)</p>
    <p>Trusted Platform Module Library Part1: Architecture</p>
    <p>What is the corrective action?</p>
    <p>This means reset the TPM</p>
  </div>
  <div class="page">
    <p>OS</p>
    <p>ACPI (BIOS/UEFI)</p>
    <p>TPM</p>
    <p>(1) Request</p>
    <p>to save a state</p>
    <p>Sleep (S3, S4)</p>
    <p>(5) Request</p>
    <p>to restore a state</p>
    <p>(2) Request to</p>
    <p>enter sleep</p>
    <p>(4) Wake up(3) Sleep</p>
    <p>(6) Resume OS</p>
    <p>ACPI Sleep Process with TPM</p>
    <p>Malware</p>
    <p>The Lost Pointer vulnerability</p>
    <p>(CVE-2017-16837)</p>
  </div>
  <div class="page">
    <p>The Lost Pointer Vulnerability (CVE-2017-16837)</p>
    <p>Measured</p>
    <p>Range</p>
    <p>Unmeasured</p>
    <p>Function</p>
    <p>Pointers</p>
  </div>
  <div class="page">
    <p>Compromised</p>
    <p>Software Stack</p>
    <p>Leaves normal hashes</p>
    <p>in event logs</p>
    <p>Compromised State</p>
    <p>BIOS/UEFI</p>
    <p>Sleep</p>
    <p>Sleep without saving</p>
    <p>the TPM state</p>
    <p>Compromised</p>
    <p>Software Stack</p>
    <p>Wake up</p>
    <p>Faked State</p>
    <p>Extract and calculate</p>
    <p>the normal hashes</p>
    <p>Reset the TPM and replay</p>
    <p>the normal hashes</p>
    <p>Store the normal hashes</p>
    <p>in RAM Hash</p>
    <p>values</p>
    <p>Compromised</p>
    <p>Software Stack</p>
    <p>Leaves normal hashes</p>
    <p>in event logs</p>
    <p>BIOS/UEFI</p>
    <p>Sleep</p>
    <p>Sleep</p>
    <p>Compromised</p>
    <p>Software Stack</p>
    <p>Wake up</p>
    <p>Extract and calculate</p>
    <p>the normal hashes</p>
    <p>Hash</p>
    <p>values</p>
    <p>Store the normal hashes</p>
    <p>in RAM</p>
    <p>DCE and DLME</p>
    <p>Reset the TPM and replay</p>
    <p>the normal hashes with</p>
    <p>the hooked functions</p>
    <p>Hook function pointers in</p>
    <p>the DCE and the DLME</p>
    <p>Hooked</p>
    <p>functions DCE and DLME</p>
    <p>Faked State</p>
    <p>Compromised State</p>
    <p>Exploit of the Grey Area Vulnerability Exploit of the Lost Pointer Vulnerability</p>
  </div>
  <div class="page">
    <p>Evaluation  The Grey Area Vulnerability</p>
  </div>
  <div class="page">
    <p>Evaluation  The Lost Pointer Vulnerability</p>
  </div>
  <div class="page">
    <p>Forged PCR values after SRTM attack</p>
    <p>Forged PCR values after DRTM attack</p>
    <p>Examples of PCR values-Intel NUC5i5MYHE</p>
  </div>
  <div class="page">
    <p>Forged PCR values after SRTM attack</p>
    <p>Forged PCR values after DRTM attack</p>
  </div>
  <div class="page">
    <p>Countermeasures  The Grey Area Vulnerability</p>
    <p>Brutal, but simple and effective</p>
    <p>if there is no state to restore</p>
    <p>action in detail</p>
    <p>A long time to revise and apply to the TPM or</p>
    <p>BIOS/UEFI firmware, but fundamental solutions</p>
  </div>
  <div class="page">
    <p>Countermeasures  The Lost Pointer Vulnerability</p>
    <p>Apply our patch to tboot</p>
    <p>https://sourceforge.net/p/tboot/code/ci/521c58e51eb5be1</p>
    <p>Update tboot to the latest version</p>
  </div>
  <div class="page">
    <p>Conclusion</p>
    <p>Two vulnerabilities that can subvert the TPM using S3</p>
    <p>sleeping state were found  The Grey Area Vulnerability: CVE-2018-6622</p>
    <p>The Lost Pointer Vulnerability: CVE-2017-16837</p>
    <p>Attackers can deceive the local and remote verification</p>
    <p>with the vulnerabilities</p>
    <p>They also can unseal the seal secret and steal it</p>
    <p>We have contacted manufacturers and contributed a</p>
    <p>patch to tboot project to solve the vulnerabilities 25/26</p>
  </div>
  <div class="page">
    <p>Questions?</p>
    <p>Seunghun Han</p>
    <p>hanseunghun@nsr.re.kr</p>
  </div>
</Presentation>
