<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>An Empirical Guide to the Behavior and Use of Scalable Persistent Memory</p>
    <p>Jian Yang, Juno Kim, Morteza Hoseinzadeh, Joseph Izraelevitz, Steven Swanson</p>
    <p>Non-Volatile Systems Laboratory Department of Computer Science &amp; Engineering</p>
    <p>University of California, San Diego</p>
    <p>Department of Electrical, Computer &amp; Energy Engineering University of Colorado, Boulder</p>
  </div>
  <div class="page">
    <p>Optane DIMMs are Here!</p>
  </div>
  <div class="page">
    <p>Optane DIMMs are Here!</p>
    <p>Cool.</p>
  </div>
  <div class="page">
    <p>Optane DIMMs are Here!</p>
    <p>Not Just Slow Dense DRAMTM</p>
  </div>
  <div class="page">
    <p>Optane DIMMs are Here!</p>
    <p>Not Just Slow Dense DRAMTM</p>
    <p>Slower media</p>
    <p>-&gt; More complex architecture</p>
    <p>-&gt; Second-order performance anomalies</p>
    <p>-&gt; Fundamentally different</p>
  </div>
  <div class="page">
    <p>Outline</p>
    <p>Background</p>
    <p>Basics: Optane DIMM Performance</p>
    <p>Lessons: Optane DIMM Best Practices  *not included: Emulation Study, Best Practices in Macrobenchmarks (see the paper)</p>
    <p>Conclusion</p>
  </div>
  <div class="page">
    <p>Background</p>
  </div>
  <div class="page">
    <p>Background: Optane in the Machine</p>
    <p>Core CoreCore</p>
  </div>
  <div class="page">
    <p>Background: Optane in the Machine</p>
    <p>Core Core</p>
    <p>L1/2 L1/2</p>
    <p>L3</p>
    <p>Core</p>
    <p>L1/2</p>
  </div>
  <div class="page">
    <p>Background: Optane in the Machine</p>
    <p>Core Core</p>
    <p>L1/2 L1/2</p>
    <p>L3</p>
    <p>iMC iMC</p>
    <p>Core</p>
    <p>L1/2</p>
  </div>
  <div class="page">
    <p>Background: Optane in the Machine</p>
    <p>Core Core</p>
    <p>L1/2 L1/2</p>
    <p>L3</p>
    <p>iMC iMC</p>
    <p>Core</p>
    <p>L1/2</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>DRAM</p>
  </div>
  <div class="page">
    <p>Background: Optane in the Machine</p>
    <p>Core Core</p>
    <p>L1/2 L1/2</p>
    <p>L3</p>
    <p>iMC iMC</p>
    <p>Core</p>
    <p>L1/2</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>Optane DIMM</p>
    <p>Optane DIMM</p>
    <p>Optane DIMM</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>DRAM</p>
  </div>
  <div class="page">
    <p>Background: Optane in the Machine</p>
    <p>Core Core</p>
    <p>L1/2 L1/2</p>
    <p>L3</p>
    <p>iMC iMC</p>
    <p>AppDirect Mode</p>
    <p>Core</p>
    <p>L1/2</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>Optane DIMM</p>
    <p>Optane DIMM</p>
    <p>Optane DIMM</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>DRAM</p>
  </div>
  <div class="page">
    <p>Background: Optane in the Machine</p>
    <p>Core Core</p>
    <p>L1/2 L1/2</p>
    <p>L3</p>
    <p>iMC iMC</p>
    <p>Core</p>
    <p>L1/2</p>
    <p>AppDirect Mode</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>Optane DIMM</p>
    <p>Optane DIMM</p>
    <p>Optane DIMM</p>
    <p>Optane DIMM</p>
    <p>Optane DIMM</p>
    <p>Optane DIMM</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>Far Memory Near Memory</p>
    <p>(Direct Mapped Cache)</p>
    <p>Memory Mode</p>
  </div>
  <div class="page">
    <p>Background: Optane in the Machine</p>
    <p>Core Core</p>
    <p>L1/2 L1/2</p>
    <p>L3</p>
    <p>iMC iMC</p>
    <p>Optane DIMM</p>
    <p>Optane DIMM</p>
    <p>Optane DIMM</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>Far Memory Near Memory</p>
    <p>(Direct Mapped Cache)</p>
    <p>Memory Mode Core</p>
    <p>L1/2</p>
    <p>AppDirect Mode</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>DRAM</p>
    <p>Optane DIMM</p>
    <p>Optane DIMM</p>
    <p>Optane DIMM</p>
  </div>
  <div class="page">
    <p>Background: Optane Internals</p>
    <p>$</p>
    <p>MC</p>
    <p>Optane</p>
    <p>DRAM</p>
    <p>Optane DIMM</p>
  </div>
  <div class="page">
    <p>Background: Optane Internals</p>
    <p>$</p>
    <p>MC</p>
    <p>Optane</p>
    <p>DRAM</p>
    <p>WPQ</p>
    <p>iMC</p>
    <p>Optane DIMM</p>
    <p>From CPU</p>
  </div>
  <div class="page">
    <p>Background: Optane Internals</p>
    <p>$</p>
    <p>MC DRAM</p>
    <p>Optane Controller</p>
    <p>WPQ</p>
    <p>iMC</p>
    <p>Optane DIMM</p>
    <p>From CPU</p>
    <p>Optane</p>
  </div>
  <div class="page">
    <p>Background: Optane Internals</p>
    <p>$</p>
    <p>MC DRAM</p>
    <p>Optane Media</p>
    <p>Optane Controller</p>
    <p>WPQ</p>
    <p>iMC</p>
    <p>Optane DIMM</p>
    <p>From CPU</p>
    <p>Optane</p>
  </div>
  <div class="page">
    <p>Background: Optane Internals</p>
    <p>$</p>
    <p>MC DRAM</p>
    <p>Optane Media</p>
    <p>Optane Controller Optane Buffer</p>
    <p>WPQ</p>
    <p>iMC</p>
    <p>Optane DIMM</p>
    <p>From CPU</p>
    <p>Optane</p>
  </div>
  <div class="page">
    <p>Background: Optane Internals</p>
    <p>$</p>
    <p>MC DRAM</p>
    <p>Optane Media</p>
    <p>Optane Controller Optane Buffer</p>
    <p>AIT Cache</p>
    <p>AIT</p>
    <p>WPQ</p>
    <p>iMC</p>
    <p>Optane DIMM</p>
    <p>From CPU</p>
    <p>Optane</p>
  </div>
  <div class="page">
    <p>Background: Optane Internals</p>
    <p>$</p>
    <p>MC DRAM</p>
    <p>Optane Media</p>
    <p>Optane Controller Optane Buffer</p>
    <p>AIT Cache</p>
    <p>AIT</p>
    <p>WPQ</p>
    <p>iMC</p>
    <p>Optane DIMM</p>
    <p>From CPU</p>
    <p>ADR (Asynchronous DRAM Refresh)</p>
    <p>Optane</p>
  </div>
  <div class="page">
    <p>Background: Optane Interleaving</p>
    <p>Optane is interleaved across NVDIMMs at 4KB granularity.</p>
    <p>Optane 4</p>
    <p>Optane 5</p>
    <p>Optane 6</p>
    <p>Optane 1</p>
    <p>Optane 2</p>
    <p>Optane 3</p>
  </div>
  <div class="page">
    <p>Background: Optane Interleaving</p>
    <p>Optane is interleaved across NVDIMMs at 4KB granularity.</p>
    <p>Optane 4</p>
    <p>Optane 5</p>
    <p>Optane 6</p>
    <p>Optane 1</p>
    <p>Optane 2</p>
    <p>Optane 3</p>
    <p>Phys. Addr: 4KB 12KB 20KB0 8KB 16KB</p>
  </div>
  <div class="page">
    <p>Basics: How does Optane DC perform?</p>
  </div>
  <div class="page">
    <p>Basics: Our Approach</p>
    <p>Microbenchmark sweeps across state space  Access Patterns (random, sequential)</p>
    <p>Operations (read, ntstore, clflush, etc.)</p>
    <p>Access/Stride Size</p>
    <p>Power Budget</p>
    <p>NUMA Configuration</p>
    <p>Address Space Interleaving</p>
    <p>Targeted experiments</p>
    <p>Total: 10,000 experiments  https://github.com/NVSL/OptaneStudy</p>
  </div>
  <div class="page">
    <p>Test Platform</p>
    <p>CPU  Intel Cascade Lake, 24 cores at 2.2 GHz in 2 sockets</p>
    <p>Hyperthreading off</p>
    <p>DRAM  32 GB Micron DDR4 2666 MHz</p>
    <p>384 GB across 2 sockets w/ 6 channels</p>
    <p>Optane  256 GB Intel Optane 2666 MHz QS</p>
    <p>3 TB across 2 sockets w/ 6 channels</p>
    <p>OS  Fedora 27, 4.13.0</p>
  </div>
  <div class="page">
    <p>Basics: Latency</p>
    <p>2x -3x as slow as DRAM</p>
    <p>Write latency masked by ADR</p>
  </div>
  <div class="page">
    <p>Basics: Bandwidth</p>
    <p>~Scalable reads, Non-scalable writes</p>
  </div>
  <div class="page">
    <p>Basics: Bandwidth</p>
    <p>Access size matters</p>
  </div>
  <div class="page">
    <p>Basics: Bandwidth</p>
    <p>A mystery!</p>
    <p>*answer in ~10 minutes</p>
  </div>
  <div class="page">
    <p>Lessons: What are Optane Best Practices?</p>
  </div>
  <div class="page">
    <p>Lessons: What are Optane Best Practices?</p>
    <p>Avoid small random accesses</p>
    <p>Use ntstores for large writes</p>
    <p>Limit threads accessing one NVDIMM</p>
    <p>Avoid mixed and multi-threaded NUMA accesses</p>
  </div>
  <div class="page">
    <p>Lesson #1: Avoid small random accesses</p>
  </div>
  <div class="page">
    <p>Lesson #1: Avoid small random accesses</p>
    <p>Optane Media</p>
    <p>Optane Controller Optane Buffer</p>
    <p>AIT Cache</p>
    <p>AIT</p>
    <p>WPQ</p>
    <p>iMC</p>
    <p>Optane DIMM</p>
    <p>From CPU</p>
    <p>$</p>
    <p>MC</p>
    <p>Optane</p>
    <p>DRAM</p>
  </div>
  <div class="page">
    <p>Lesson #1: Avoid small random accesses</p>
    <p>Optane Media</p>
    <p>Optane Controller Optane Buffer</p>
    <p>AIT Cache</p>
    <p>AIT</p>
    <p>WPQ</p>
    <p>iMC</p>
    <p>Optane DIMM</p>
    <p>From CPU</p>
    <p>$</p>
    <p>MC</p>
    <p>Optane</p>
    <p>DRAM</p>
  </div>
  <div class="page">
    <p>Lesson #1: Avoid small random accesses</p>
    <p>Optane Media</p>
    <p>Optane Controller Optane Buffer</p>
    <p>AIT Cache</p>
    <p>AIT</p>
    <p>WPQ</p>
    <p>iMC</p>
    <p>Optane DIMM</p>
    <p>From CPU</p>
    <p>$</p>
    <p>MC</p>
    <p>Optane</p>
    <p>DRAM</p>
  </div>
  <div class="page">
    <p>Lessons: Optane Buffer Size</p>
    <p>Write amplification if working set is larger than Optane Buffer</p>
  </div>
  <div class="page">
    <p>Lesson #1: Avoid small random accesses</p>
    <p>Bad bandwidth with:</p>
    <p>Small random writes (&lt;256B)</p>
    <p>Not tiny working set / NVDIMM (&gt;16KB)</p>
    <p>Good bandwidth with</p>
    <p>Sequential accesses</p>
  </div>
  <div class="page">
    <p>Lesson #2: Use ntstores for large writes</p>
  </div>
  <div class="page">
    <p>Lessons: Store instructions</p>
    <p>ntstore store + clwb store</p>
    <p>$</p>
    <p>MC</p>
    <p>Optane</p>
    <p>DRAM</p>
  </div>
  <div class="page">
    <p>Lessons: Store instructions</p>
    <p>ntstore store + clwb store</p>
    <p>$</p>
    <p>MC</p>
    <p>Optane</p>
    <p>DRAM</p>
    <p>*lost bandwidth *lost locality</p>
  </div>
  <div class="page">
    <p>Lesson #2: Use ntstores for large writes</p>
  </div>
  <div class="page">
    <p>Lesson #2: Use ntstores for large writes</p>
    <p>Non-temporal stores bypass the cache</p>
    <p>Avoid cache-line read</p>
    <p>Maintain locality</p>
  </div>
  <div class="page">
    <p>Lesson #3: Limit threads accessing one NVDIMM</p>
  </div>
  <div class="page">
    <p>Lesson #3: Limit threads accessing one NVDIMM</p>
    <p>Contention at Optane Buffer</p>
    <p>Contention at iMC</p>
  </div>
  <div class="page">
    <p>Lessons: Contention at Optane Buffer</p>
    <p>More threads = access amplification = lower bandwidth</p>
  </div>
  <div class="page">
    <p>Lessons: Contention at iMC</p>
    <p>iMCs arent designed for slow, variable latency accesses</p>
    <p>Short queues end up clogged</p>
  </div>
  <div class="page">
    <p>Lessons: Contention at iMC</p>
    <p>Vary #threads/NVDIMM (total threads = 6)</p>
  </div>
  <div class="page">
    <p>Lesson: Contention at iMC</p>
    <p>iMC contention is largest when random access size = interleave size (4KB)</p>
  </div>
  <div class="page">
    <p>Lesson: Contention at iMC</p>
    <p>iMC contention is largest when random access size = interleave size (4KB)</p>
    <p>iMC load is fairest when access size = #DIMMs x interleave size (24KB)</p>
  </div>
  <div class="page">
    <p>Lesson #3: Limit threads accessing one NVDIMM</p>
    <p>Contention at Optane Buffer</p>
    <p>Increase access amplification</p>
    <p>Contention at iMC</p>
    <p>Lose bandwidth through uneven NVDIMM load</p>
    <p>Avoid interleave aligned random accesses</p>
  </div>
  <div class="page">
    <p>Lesson #4: Avoid mixed and multi-threaded NUMA accesses</p>
  </div>
  <div class="page">
    <p>Lesson #4: Avoid mixed and multi-threaded NUMA accesses</p>
    <p>NUMA effects impact Optane more than DRAM</p>
  </div>
  <div class="page">
    <p>Lesson #4: Avoid mixed and multi-threaded NUMA accesses</p>
    <p>NUMA effects impact Optane more than DRAM</p>
    <p>R/W ratio is more important</p>
  </div>
  <div class="page">
    <p>Lesson #4: Avoid mixed and multi-threaded NUMA accesses</p>
  </div>
  <div class="page">
    <p>Conclusion</p>
  </div>
  <div class="page">
    <p>Conclusion</p>
    <p>Not Just Slow Dense DRAM</p>
    <p>Slower media</p>
    <p>-&gt; More complex architecture</p>
    <p>-&gt; Second-order performance anomalies</p>
    <p>-&gt; Fundamentally different</p>
    <p>Max performance is tricky  Avoid small random accesses</p>
    <p>Use ntstores for large writes</p>
    <p>Limit threads accessing one NVDIMM</p>
    <p>Avoid mixed and multi-threaded NUMA accesses</p>
  </div>
</Presentation>
