<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>Kaushik Veeraraghavan, Justin Meza, David Chou, Wonho Kim, Sonia Margulis, Scott Michelson, Rajesh Nishtala, Daniel Obenshain, Dmitri</p>
    <p>Perelman, and Yee Jiun Song Facebook Inc.</p>
  </div>
  <div class="page">
    <p>Web server</p>
    <p>Each user request touches hundreds of systems</p>
    <p>Newsfeed Newsfeed</p>
    <p>DBDB</p>
    <p>CacheCache</p>
    <p>PYMLPYML</p>
    <p>AdsAds</p>
    <p>SearchSearch</p>
    <p>EverstoreEverstore</p>
    <p>ScribePtail</p>
    <p>CoefficientCoefficient</p>
    <p>LaserLaser</p>
    <p>ScribeScribe</p>
  </div>
  <div class="page">
    <p>The workload is constantly evolving</p>
    <p>Many products Growing user base</p>
    <p>Facebook: 3 daily releases</p>
    <p>Instagram: cont. release</p>
    <p>Rapid software change</p>
  </div>
  <div class="page">
    <p>Goals</p>
    <p>How many machines does each software system need?</p>
    <p>Can we serve peak load?</p>
    <p>Are we operating efficiently?</p>
  </div>
  <div class="page">
    <p>Common approaches to capacity management</p>
    <p>Load modeling: simulate how system behaves at high load  Load testing: benchmark using synthetic workloads</p>
    <p>Web server</p>
    <p>Newsfeed Newsfeed</p>
    <p>DBDB</p>
    <p>CacheCache</p>
    <p>PYMLPYML</p>
    <p>AdsAds</p>
    <p>SearchSearch</p>
    <p>EverstoreEverstore</p>
    <p>ScribePtail</p>
    <p>CoefficientCoefficient</p>
    <p>LaserLaser</p>
    <p>ScribeScribe</p>
  </div>
  <div class="page">
    <p>Live user traffic is the most representative workload</p>
    <p>Accurate distribution of reads &amp; writes</p>
    <p>Do not need a custom test setup</p>
  </div>
  <div class="page">
    <p>Direct live user traffic at target</p>
    <p>Live traffic load tests measure peak serving capacity</p>
  </div>
  <div class="page">
    <p>Live traffic load tests measure peak serving capacity safely</p>
    <p>Monitor health metrics  Response latency  Server error</p>
    <p>Reset load when thresholds are hit</p>
  </div>
  <div class="page">
    <p>Roadmap</p>
    <p>Kraken measures peak serving capacity at all scales  A single web server  A single cluster  An entire geographical region</p>
    <p>Kraken identifies bottlenecks limiting utilization  Load imbalance  Network saturation</p>
    <p>Challenges in deploying Kraken</p>
  </div>
  <div class="page">
    <p>Frontend Cluster</p>
    <p>Frontend Cluster</p>
    <p>Cluster weight</p>
    <p>Region</p>
    <p>Region</p>
    <p>Region</p>
    <p>Region</p>
    <p>Edge weight</p>
    <p>Web server weight</p>
    <p>DNS</p>
    <p>Edge POP</p>
    <p>Edge POP</p>
    <p>Edge POP</p>
    <p>Service Cluster</p>
    <p>Backend Cluster</p>
    <p>Search</p>
    <p>Newsfeed</p>
    <p>Kraken uses weights to route requests</p>
  </div>
  <div class="page">
    <p>Kraken measures a web servers peak serving capacity</p>
    <p>Peak web server capacity: 175 requests per second (RPS)  Production target: 90% utilization i.e., 157 RPS</p>
  </div>
  <div class="page">
    <p>Kraken measures a clusters peak serving capacity</p>
    <p>Max cluster capacity = (web server capacity) * (num. web servers in cluster) 12</p>
  </div>
  <div class="page">
    <p>Kraken measures a regions peak serving capacity</p>
  </div>
  <div class="page">
    <p>Inefficient load balancing limits utilization</p>
  </div>
  <div class="page">
    <p>Network saturation limits utilization</p>
  </div>
  <div class="page">
    <p>Challenge: non-linear response to traffic shifts</p>
    <p>Web server</p>
    <p>Newsfeed Newsfeed</p>
    <p>DBDB</p>
    <p>CacheCache</p>
    <p>PYMLPYML</p>
    <p>AdsAds</p>
    <p>SearchSearch</p>
    <p>EverstoreEverstore</p>
    <p>ScribePtail</p>
    <p>CoefficientCoefficient</p>
    <p>LaserLaser</p>
    <p>ScribeScribe</p>
    <p>?</p>
  </div>
  <div class="page">
    <p>Challenge: how can we foster experimentation?</p>
    <p>Set conservative thresholds</p>
    <p>Communicate widely about tests</p>
    <p>Encourage collaboration  Monitoring  Failure mitigation strategies</p>
  </div>
  <div class="page">
    <p>Conclusion</p>
    <p>Weve run 50+ regional, 1000+ cluster live traffic load tests in 3 years</p>
    <p>Kraken has helped us identify hundreds of bottlenecks and verify fixes</p>
    <p>We can now serve 20% more users with the same infrastructure</p>
  </div>
  <div class="page">
    <p>Kraken: assumptions and caveats</p>
    <p>Stateless servers</p>
    <p>Routable requests</p>
    <p>Load impacts downstream systems</p>
  </div>
  <div class="page">
    <p>Kraken: user traffic management</p>
    <p>W eb L B</p>
    <p>Frontend Cluster</p>
    <p>PoP</p>
    <p>DNS</p>
    <p>Frontend Cluster</p>
    <p>Se rv ic e LB</p>
    <p>Service Cluster</p>
    <p>PoP</p>
    <p>Region</p>
    <p>PoP</p>
    <p>Region</p>
    <p>Region</p>
    <p>Region</p>
    <p>PoPs Data center regions Data center</p>
    <p>Edge weight Cluster weight</p>
    <p>Server weight Server weight</p>
  </div>
  <div class="page">
    <p>Kraken: live traffic load tests</p>
    <p>W eb L B</p>
    <p>Frontend Cluster</p>
    <p>Health Monitor</p>
    <p>Feedback Control</p>
    <p>Traffic Shifter</p>
    <p>Edge POP</p>
    <p>DNS</p>
    <p>Measure healthIncrease/reset loadUpdate weights</p>
    <p>Kraken</p>
  </div>
  <div class="page">
    <p>Health metrics for systems affected by web load Service type Metrics</p>
    <p>Web servers CPU utilization, latency, error rate, fraction of operational servers</p>
    <p>Aggregatorleaf CPU utilization, error rate, response quality</p>
    <p>Proxygen software L7 load balancer CPU utilization, latency, connections, retransmit rate, Ethernet utilization, memory capacity utilization</p>
    <p>Memcache Latency, object lease count</p>
    <p>TAO CPU utilization, write suc- cess rate, read latency</p>
    <p>Batch processor Queue length, exception rate</p>
    <p>Logging Error rate</p>
    <p>Search CPU utilization</p>
    <p>Service discovery CPU utilization</p>
    <p>Message delivery CPU utilization</p>
  </div>
  <div class="page">
    <p>Continuous runs measuring a web servers capacity</p>
  </div>
  <div class="page">
    <p>Some lessons from a thousand Kraken tests</p>
    <p>Simplicity is key to Krakens success.</p>
    <p>Identifying the right performance, error rate and latency metrics to track is difficult.</p>
    <p>Cheap solutions, like allocating capacity or fixing misconfiguration, are often more impactful than profile-based tuning or system redesign.</p>
  </div>
</Presentation>
