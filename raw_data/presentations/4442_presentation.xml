<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>BGP Anomaly Detection in an ISP</p>
    <p>Jian Wu (U. Michigan) Z. Morley Mao (U. Michigan) Jennifer Rexford (Princeton)</p>
    <p>Jia Wang (AT&amp;T Labs)</p>
    <p>http://www.cs.princeton.edu/~jrex/papers/nsdi05-jian.pdf</p>
  </div>
  <div class="page">
    <p>Goal</p>
    <p>Identify important anomalies  Lost reachability  Persistent flapping  Large traffic shifts</p>
    <p>Contributions:</p>
    <p>Build a tool to identify a small number of important routing disruptions from a large volume of raw BGP updates in real time.</p>
    <p>Use the tool to characterize routing disruptions in an operational network</p>
  </div>
  <div class="page">
    <p>Capturing Routing Changes</p>
    <p>CBRCBR</p>
    <p>CPEBGP Monit</p>
    <p>or</p>
    <p>CBRCBR</p>
    <p>CBRCBR</p>
    <p>CBRCBR</p>
    <p>CBRCBR</p>
    <p>CBRCBR</p>
    <p>iBG P</p>
    <p>iBGP</p>
    <p>iB G</p>
    <p>P</p>
    <p>iB G</p>
    <p>P</p>
    <p>iBG P</p>
    <p>iBGP</p>
    <p>eBGP</p>
    <p>e B</p>
    <p>G P</p>
    <p>eB GP</p>
    <p>e B</p>
    <p>G P</p>
    <p>eBG P</p>
    <p>eBGP</p>
    <p>Updates Upd</p>
    <p>ate s</p>
    <p>Best routes Be</p>
    <p>st rou</p>
    <p>tes</p>
    <p>Large operational network (8/16/2004  10/10-2004)</p>
  </div>
  <div class="page">
    <p>Challenges</p>
    <p>Large volume of BGP updates  Millions daily, very bursty  Too much for an operator to manage</p>
    <p>Different than root-cause analysis  Identify changes and their effects  Focus on actionable events  Diagnose causes only in/near the AS</p>
  </div>
  <div class="page">
    <p>System Architecture</p>
    <p>Event Classification</p>
    <p>Event Classification</p>
    <p>Typed Events</p>
    <p>EEBR</p>
    <p>EEBR</p>
    <p>EEBR</p>
    <p>BGP Updates</p>
    <p>(106)</p>
    <p>BGP Update Grouping</p>
    <p>BGP Update Grouping</p>
    <p>Events</p>
    <p>Persistent Flapping Prefixes</p>
    <p>(101)</p>
    <p>(105)</p>
    <p>Event Correlation</p>
    <p>Event Correlation</p>
    <p>Clusters</p>
    <p>Frequent Flapping Prefixes</p>
    <p>(103)</p>
    <p>(101)</p>
    <p>Traffic Impact Prediction</p>
    <p>Traffic Impact Prediction</p>
    <p>EEBREEBR EEBR</p>
    <p>Large Disruptions</p>
    <p>Netflow Data</p>
    <p>(101)</p>
  </div>
  <div class="page">
    <p>Grouping BGP Update into Events</p>
    <p>Challenge: A single routing change  leads to multiple update messages  affects routing decisions at multiple routers</p>
    <p>Solution: Group all updates for a prefix with interarrival &lt; 70 seconds Flag prefixes with changes lasting &gt; 10 minutes.</p>
    <p>BGP Update Grouping</p>
    <p>BGP Update Grouping</p>
    <p>EEBR</p>
    <p>EEBR</p>
    <p>EEBR</p>
    <p>BGP Updates</p>
    <p>Events</p>
    <p>Persistent Flapping Prefixes</p>
  </div>
  <div class="page">
    <p>Grouping Thresholds</p>
    <p>Based on data analysis and our understanding of BGP</p>
    <p>Event timeout: 70 seconds  2 * MRAI timer + 10 seconds  98% inter-arrival time &lt; 70 seconds</p>
    <p>Convergence timeout: 10 minutes  BGP usually converges within minutes  99.9% events &lt; 10 minutes</p>
  </div>
  <div class="page">
    <p>Persistent Flapping Prefixes</p>
    <p>Causes of persistent flapping  Conservative damping parameters (78.6%)  Protocol oscillations due to MED (18.3%)  Unstable interface or BGP session (3.0%)</p>
    <p>Surprising finding: 15.2% of updates were caused by persistent flapping prefixes, even though flap damping was enabled!</p>
  </div>
  <div class="page">
    <p>Example: Unstable eBGP Session</p>
    <p>ISP Peer</p>
    <p>Customer EC</p>
    <p>EB</p>
    <p>EA ED</p>
    <p>p</p>
    <p>Flap damping parameters are session-based  Damping not implemented for iBGP sessions</p>
  </div>
  <div class="page">
    <p>Event Classification</p>
    <p>Challenge: Major concerns in network management  Changes in reachability  Heavy load of routing messages on the routers  Change of flow of traffic through the network</p>
    <p>Event Classification</p>
    <p>Event Classification</p>
    <p>Events Typed Events</p>
    <p>Solution: classify events by severity of their impacts</p>
  </div>
  <div class="page">
    <p>Event Category  No Disruption</p>
    <p>ISP</p>
    <p>EA</p>
    <p>p</p>
    <p>EB</p>
    <p>EC</p>
    <p>EE</p>
    <p>AS2</p>
    <p>ED</p>
    <p>AS1</p>
    <p>No Traffic Shift</p>
    <p>No Disruption: each of the border routers has no traffic shift. (50.3%)</p>
  </div>
  <div class="page">
    <p>Event Category  Internal Disruption</p>
    <p>ISP</p>
    <p>EA</p>
    <p>p</p>
    <p>EB</p>
    <p>EC</p>
    <p>EE</p>
    <p>AS2</p>
    <p>ED</p>
    <p>AS1</p>
    <p>Internal Traffic Shift</p>
    <p>Internal Disruption: all of the traffic shifts are internal traffic shift. (15.6%)</p>
  </div>
  <div class="page">
    <p>Event Category  Single External Disruption</p>
    <p>ISP</p>
    <p>EA</p>
    <p>p</p>
    <p>EB</p>
    <p>EC</p>
    <p>EE</p>
    <p>AS2</p>
    <p>ED</p>
    <p>AS1</p>
    <p>external Traffic Shift</p>
    <p>Single External Disruption: only one of the traffic shifts is external traffic shift. (20.7%)</p>
  </div>
  <div class="page">
    <p>Statistics on Event Classification</p>
    <p>Events Updates</p>
    <p>No Disruption 50.3% 48.6%</p>
    <p>Internal Disruption 15.6% 3.4%</p>
    <p>Single External Disruption 20.7% 7.9%</p>
    <p>Multiple External Disruption 7.4% 18.2%</p>
    <p>Loss/Gain of Reachability 6.0% 21.9%</p>
    <p>First 3 categories have significant variations from day to day</p>
    <p>Updates per event depends on the type of events and the number of affected routers</p>
  </div>
  <div class="page">
    <p>Event Correlation</p>
    <p>Challenge: A single routing change  affects multiple destination prefixes</p>
    <p>Event Correlation</p>
    <p>Event CorrelationTyped</p>
    <p>Events Clusters</p>
    <p>Solution: group events of same type that occur close in time</p>
  </div>
  <div class="page">
    <p>EBGP Session Reset  Caused most single external disruption events  Check if the number of prefixes using that session</p>
    <p>as the best route changes dramatically</p>
    <p>Validation with Syslog router report (95%)</p>
    <p>time</p>
    <p>Number of prefixes</p>
    <p>session failure</p>
    <p>session recovery</p>
  </div>
  <div class="page">
    <p>Hot-Potato Changes  Hot-Potato Changes</p>
    <p>Caused internal disruption events  Validation with OSPF measurement (95%)</p>
    <p>[Teixeira et al  SIGMETRICS 04]</p>
    <p>ISP</p>
    <p>P</p>
    <p>EA EB</p>
    <p>EC</p>
    <p>Hot-potato routing = route to closest egress point</p>
  </div>
  <div class="page">
    <p>Traffic Impact Prediction</p>
    <p>Challenge: Routing changes have different impacts on the network which depends on the popularity of the destinations</p>
    <p>Traffic Impact Prediction</p>
    <p>Traffic Impact Prediction</p>
    <p>EEBR</p>
    <p>Clusters Large Disruptions</p>
    <p>Netflow Data</p>
    <p>EEBR EEBR</p>
    <p>Solution: weigh each cluster by traffic volume</p>
  </div>
  <div class="page">
    <p>Traffic Impact Prediction</p>
    <p>Traffic weight  Per-prefix measurement from Netflow  10% prefixes accounts for 90% of traffic</p>
    <p>Traffic weight of a cluster  Sum of traffic weight of the prefixes  A few clusters have large traffic weight  Mostly session resets &amp; hot-potato changes</p>
  </div>
  <div class="page">
    <p>Performance Evaluation  Memory</p>
    <p>Static memory: current routes, 600 MB  Dynamic memory: clusters, 300 MB</p>
    <p>Speed  99% of intervals of 1 second of updates can</p>
    <p>be process within 1 second  Occasional execution lag  Every interval of 70 seconds of updates can</p>
    <p>be processed within 70 seconds</p>
    <p>Measurements were based on 900MHz CPU</p>
  </div>
  <div class="page">
    <p>Conclusion</p>
    <p>BGP anomaly detection  Fast, online fashion  Operator concerns (reachability, flapping,</p>
    <p>traffic)  Significant information reduction</p>
    <p>Uncovered important network behaviors  Persistent flapping prefixes  Hot-potato changes  Session resets and interface failures</p>
  </div>
  <div class="page">
    <p>Detecting Peering Violations  Consistent export requirement</p>
    <p>Peer should advertise prefixes at all peering points, with the same AS path length</p>
    <p>Allows the AS to do hot-potato routing  Detecting violations</p>
    <p>Using iBGP feeds from the border routers  Some inference tricks to identify inconsistencies</p>
    <p>Results of the study  http://www.nanog.org/mtg-0410/feamster.html  http://www.cs.princeton.edu/~jrex/papers/imc04.pdf</p>
  </div>
</Presentation>
