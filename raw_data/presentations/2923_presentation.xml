<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>Spanner: Googles Globally-Distributed Database</p>
    <p>Wilson Hsieh representing a host of authors</p>
    <p>OSDI 2012</p>
  </div>
  <div class="page">
    <p>What is Spanner?</p>
    <p>Distributed multiversion database  General-purpose transactions (ACID)  SQL query language  Schematized tables  Semi-relational data model</p>
    <p>Running in production  Storage for Googles ad data  Replaced a sharded MySQL database</p>
    <p>OSDI 2012 2</p>
  </div>
  <div class="page">
    <p>Example: Social Network</p>
    <p>OSDI 2012</p>
    <p>User posts Friend lists User posts Friend lists User posts Friend lists User posts Friend lists User posts Friend lists User posts Friend lists User posts Friend lists User posts Friend lists</p>
    <p>US</p>
    <p>Brazil</p>
    <p>Russia Spain</p>
    <p>San Francisco Seattle Arizona</p>
    <p>Sao Paulo Santiago Buenos Aires</p>
    <p>Moscow Berlin Krakow</p>
    <p>London Paris Berlin Madrid Lisbon</p>
    <p>User posts Friend lists User posts Friend lists</p>
    <p>x1000</p>
    <p>x1000</p>
    <p>x1000</p>
    <p>x1000</p>
  </div>
  <div class="page">
    <p>Overview</p>
    <p>Feature: Lock-free distributed read transactions  Property: External consistency of distributed</p>
    <p>transactions  First system at global scale</p>
    <p>Implementation: Integration of concurrency control, replication, and 2PC  Correctness and performance</p>
    <p>Enabling technology: TrueTime  Interval-based global time</p>
    <p>OSDI 2012 4</p>
  </div>
  <div class="page">
    <p>Read Transactions</p>
    <p>Generate a page of friends recent posts  Consistent view of friend list and their posts</p>
    <p>OSDI 2012</p>
    <p>Why consistency matters 1. Remove untrustworthy person X as friend 2. Post P: My government is repressive</p>
  </div>
  <div class="page">
    <p>User posts Friend lists User posts Friend lists User posts Friend lists User posts Friend lists</p>
    <p>Single Machine</p>
    <p>Friend2 post</p>
    <p>Generate my page</p>
    <p>Friend1 post</p>
    <p>Friend1000 post Friend999 post</p>
    <p>Block writes</p>
    <p>OSDI 2012</p>
  </div>
  <div class="page">
    <p>User posts Friend lists User posts Friend lists User posts Friend lists User posts Friend lists</p>
    <p>Multiple Machines</p>
    <p>User posts Friend lists User posts Friend lists</p>
    <p>Generate my page</p>
    <p>Friend2 post</p>
    <p>Friend1 post</p>
    <p>Friend1000 post Friend999 post</p>
    <p>User posts Friend lists User posts Friend lists</p>
    <p>Block writes</p>
    <p>OSDI 2012</p>
  </div>
  <div class="page">
    <p>User posts Friend lists User posts Friend lists</p>
    <p>User posts Friend lists User posts Friend lists</p>
    <p>User posts Friend lists User posts Friend lists</p>
    <p>Multiple Datacenters User posts Friend lists User posts Friend lists</p>
    <p>Generate my page</p>
    <p>Friend2 post</p>
    <p>Friend1 post</p>
    <p>Friend1000 post</p>
    <p>Friend999 post</p>
    <p>OSDI 2012</p>
    <p>US</p>
    <p>Spain</p>
    <p>Russia</p>
    <p>Brazil</p>
    <p>x1000</p>
    <p>x1000</p>
    <p>x1000</p>
    <p>x1000</p>
  </div>
  <div class="page">
    <p>Version Management</p>
    <p>Transactions that write use strict 2PL  Each transaction T is assigned a timestamp s  Data written by T is timestamped with s</p>
    <p>OSDI 2012 9</p>
    <p>Time 8&lt;8</p>
    <p>[X]</p>
    <p>[me]</p>
    <p>[P] My friends My posts Xs friends</p>
    <p>[]</p>
    <p>[]</p>
  </div>
  <div class="page">
    <p>Synchronizing Snapshots</p>
    <p>== External Consistency:</p>
    <p>Commit order respects global wall-time order</p>
    <p>OSDI 2012 10</p>
    <p>== Timestamp order respects global wall-time order</p>
    <p>given timestamp order == commit order</p>
    <p>Global wall-clock time</p>
  </div>
  <div class="page">
    <p>Timestamps, Global Clock</p>
    <p>Strict two-phase locking for write transactions  Assign timestamp while locks are held</p>
    <p>T</p>
    <p>Pick s = now()</p>
    <p>Acquired locks Release locks</p>
    <p>OSDI 2012 11</p>
  </div>
  <div class="page">
    <p>Timestamp Invariants</p>
    <p>OSDI 2012 12</p>
    <p>Timestamp order == commit order</p>
    <p>Timestamp order respects global wall-time order</p>
    <p>T2</p>
    <p>T3</p>
    <p>T4</p>
    <p>T1</p>
  </div>
  <div class="page">
    <p>TrueTime</p>
    <p>Global wall-clock time with bounded uncertainty</p>
    <p>time</p>
    <p>earliest latest</p>
    <p>TT.now()</p>
    <p>OSDI 2012 13</p>
  </div>
  <div class="page">
    <p>Timestamps and TrueTime</p>
    <p>T</p>
    <p>Pick s = TT.now().latest</p>
    <p>Acquired locks Release locks</p>
    <p>Wait until TT.now().earliest &gt; ss</p>
    <p>OSDI 2012</p>
    <p>average</p>
    <p>Commit wait</p>
    <p>average</p>
  </div>
  <div class="page">
    <p>Commit Wait and Replication</p>
    <p>OSDI 2012</p>
    <p>T</p>
    <p>Acquired locks Release locks</p>
    <p>Start consensus Notify slaves</p>
    <p>Commit wait donePick s</p>
    <p>Achieve consensus</p>
  </div>
  <div class="page">
    <p>Commit Wait and 2-Phase Commit</p>
    <p>OSDI 2012</p>
    <p>TC</p>
    <p>Acquired locks Release locks</p>
    <p>TP1</p>
    <p>Acquired locks Release locks</p>
    <p>TP2</p>
    <p>Acquired locks Release locks</p>
    <p>Notify participants of s</p>
    <p>Commit wait doneCompute s for each</p>
    <p>Start logging Done logging</p>
    <p>Prepared</p>
    <p>Compute overall s</p>
    <p>Committed</p>
    <p>Send s</p>
  </div>
  <div class="page">
    <p>Example</p>
    <p>OSDI 2012 17</p>
    <p>TP</p>
    <p>Remove X from my friend list</p>
    <p>Remove myself from Xs friend list</p>
    <p>sC=6</p>
    <p>sP=8</p>
    <p>s=8 s=15</p>
    <p>Risky post P</p>
    <p>s=8</p>
    <p>Time &lt;8</p>
    <p>[X]</p>
    <p>[me]</p>
    <p>TC T2</p>
    <p>[P] My friends My posts Xs friends</p>
    <p>[]</p>
    <p>[]</p>
  </div>
  <div class="page">
    <p>What Have We Covered?</p>
    <p>Lock-free read transactions across datacenters  External consistency  Timestamp assignment  TrueTime  Uncertainty in time can be waited out</p>
    <p>OSDI 2012 18</p>
  </div>
  <div class="page">
    <p>What Havent We Covered?</p>
    <p>How to read at the present time  Atomic schema changes  Mostly non-blocking  Commit in the future</p>
    <p>Non-blocking reads in the past  At any sufficiently up-to-date replica</p>
    <p>OSDI 2012 19</p>
  </div>
  <div class="page">
    <p>TrueTime Architecture</p>
    <p>Datacenter 1 Datacenter nDatacenter 2</p>
    <p>GPS timemaster</p>
    <p>GPS timemaster</p>
    <p>GPS timemaster</p>
    <p>Atomic-clock timemaster</p>
    <p>GPS timemaster</p>
    <p>Client</p>
    <p>OSDI 2012 20</p>
    <p>GPS timemaster</p>
    <p>Compute reference [earliest, latest] = now</p>
  </div>
  <div class="page">
    <p>TrueTime implementation</p>
    <p>time</p>
    <p>+6ms</p>
    <p>now = reference now + local-clock offset  = reference  + worst-case local-clock drift</p>
    <p>reference uncertainty</p>
    <p>OSDI 2012 21</p>
  </div>
  <div class="page">
    <p>What If a Clock Goes Rogue?</p>
    <p>Timestamp assignment would violate external consistency</p>
    <p>Empirically unlikely based on 1 year of data  Bad CPUs 6 times more likely than bad clocks</p>
    <p>OSDI 2012 22</p>
  </div>
  <div class="page">
    <p>Network-Induced Uncertainty</p>
    <p>OSDI 2012</p>
    <p>Mar 29 Mar 30 Mar 31 Apr 1</p>
    <p>Date</p>
    <p>E p</p>
    <p>si lo</p>
    <p>n (</p>
    <p>m s)</p>
    <p>Date (April 13)</p>
  </div>
  <div class="page">
    <p>Whats in the Literature</p>
    <p>External consistency/linearizability  Distributed databases  Concurrency control  Replication  Time (NTP, Marzullo)</p>
    <p>OSDI 2012 24</p>
  </div>
  <div class="page">
    <p>Future Work</p>
    <p>Improving TrueTime  Lower  &lt; 1 ms</p>
    <p>Building out database features  Finish implementing basic features  Efficiently support rich query patterns</p>
    <p>OSDI 2012 25</p>
  </div>
  <div class="page">
    <p>Conclusions</p>
    <p>Reify clock uncertainty in time APIs  Known unknowns are better than unknown</p>
    <p>unknowns  Rethink algorithms to make use of uncertainty</p>
    <p>Stronger semantics are achievable  Greater scale != weaker semantics</p>
    <p>OSDI 2012 26</p>
  </div>
  <div class="page">
    <p>Thanks</p>
    <p>To the Spanner team and customers  To our shepherd and reviewers  To lots of Googlers for feedback  To you for listening!</p>
    <p>Questions?</p>
    <p>OSDI 2012 27</p>
  </div>
</Presentation>
