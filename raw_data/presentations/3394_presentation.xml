<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>Ninja: Towards Transparent Tracing and Debugging on ARM</p>
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 1</p>
    <p>Zhenyu Ning &amp; Fengwei Zhang Wayne State University</p>
    <p>{zhenyu.ning, fengwei}@wayne.edu</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 2</p>
    <p>Outline</p>
    <p>Introduction  Background  System Overview  Evaluation  Conclusion</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 3</p>
    <p>Outline</p>
    <p>Introduction  Background  System Overview  Evaluation  Conclusion</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 4</p>
    <p>Evasion Malware</p>
    <p>Analyzer</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 5</p>
    <p>Evasion Malware</p>
    <p>Analyzer</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 6</p>
    <p>Malware Analysis</p>
    <p>Applications</p>
    <p>Operating System</p>
    <p>Hypervisor/Emulator</p>
    <p>MalwareApp App</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 7</p>
    <p>Malware Analysis</p>
    <p>Applications</p>
    <p>Operating System</p>
    <p>Hypervisor/Emulator</p>
    <p>MalwareApp App</p>
    <p>Malware Analyzer</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 8</p>
    <p>Malware Analysis</p>
    <p>Applications</p>
    <p>Operating System</p>
    <p>Hypervisor/Emulator</p>
    <p>MalwareApp App</p>
    <p>Malware Analyzer</p>
    <p>Limitation:</p>
    <p>Unarmed to antivirtualization or antiemulation techniques</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 9</p>
    <p>Malware Analysis</p>
    <p>Applications</p>
    <p>Operating System</p>
    <p>Hypervisor/Emulator</p>
    <p>MalwareApp App</p>
    <p>Malware Analyzer</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 10</p>
    <p>Malware Analysis</p>
    <p>Applications</p>
    <p>Operating System</p>
    <p>Hypervisor/Emulator</p>
    <p>MalwareApp App</p>
    <p>Malware Analyzer</p>
    <p>Limitation:</p>
    <p>Unable to handle malware with high privilege (e.g., rootkits)</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 11</p>
    <p>Malware Analysis</p>
    <p>Applications</p>
    <p>Operating System</p>
    <p>Hypervisor/Emulator</p>
    <p>MalwareApp App</p>
    <p>MalT S&amp;P 15</p>
    <p>Hardware</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 12</p>
    <p>Malware Analysis</p>
    <p>Applications</p>
    <p>Operating System</p>
    <p>Hypervisor/Emulator</p>
    <p>MalwareApp App Limitations:</p>
    <p>High performance overhead on mode switch</p>
    <p>Unprotected modified registers</p>
    <p>Vulnerable to external timing attack</p>
    <p>MalT S&amp;P 15</p>
    <p>Hardware</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 13</p>
    <p>Transparency Requirements</p>
    <p>An Environment that provides the access to the states of the target malware</p>
    <p>An Analyzer which is responsible for the further analysis of the states</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 14</p>
    <p>Transparency Requirements</p>
    <p>An Environment that provides the access to the states of the target malware  It is isolated from the target malware  It exists on an off-the-shelf (OTS) bare-metal platform</p>
    <p>An Analyzer which is responsible for the further analysis of the states</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 15</p>
    <p>Transparency Requirements</p>
    <p>An Environment that provides the access to the states of the target malware  It is isolated from the target malware  It exists on an off-the-shelf (OTS) bare-metal platform</p>
    <p>An Analyzer which is responsible for the further analysis of the states  It should not leave any detectable footprints to the outside of the environment</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 16</p>
    <p>Outline</p>
    <p>Introduction  Background  System Overview  Evaluation  Conclusion</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 17</p>
    <p>Background - TrustZone</p>
    <p>ARM TrustZone technology divides the execution environment into secure domain and non-secure domain.</p>
    <p>The RAM is partitioned to secure and non-secure region.</p>
    <p>The interrupts are assigned into secure or non-secure group.</p>
    <p>Secure-sensitive registers can only be accessed in secure domain.</p>
    <p>Hardware peripherals can be configured as secure access only.</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 18</p>
    <p>Background - TrustZone  In ARMv8 architecture, exceptions are delivered to different Exception Levels (ELs).</p>
    <p>The only way to enter the secure domain is to trigger a EL3 exception.</p>
    <p>The exception return instruction (ERET) can be used to switch back to the non-secure domain.</p>
    <p>EL1 (Rich OS)</p>
    <p>EL2 (Hypervisor)</p>
    <p>EL3 (Secure Monitor)</p>
    <p>EL0 (Applications)</p>
    <p>EL1 (Secure OS)</p>
    <p>Non-secure Domain Secure Domain</p>
    <p>EL0 (Applications)</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 19</p>
    <p>Background  PMU and ETM</p>
    <p>The Performance Monitor Unit (PMU) leverages a set of performance counter registers to count the occurrence of different CPU events.</p>
    <p>The Embedded Trace Macrocell (ETM) traces the instructions and data of the system, and output the trace stream into pre-allocated buffers on the chip.</p>
    <p>Both PMU and ETM exist on ARM Cortex-A5x and Cortex-A7x series CPUs, and do NOT affect the performance of the CPU.</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 20</p>
    <p>Outline</p>
    <p>Introduction  Background  System Overview  Evaluation  Conclusion</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 21</p>
    <p>Overview</p>
    <p>App</p>
    <p>App</p>
    <p>Target Malware</p>
    <p>Rich OS</p>
    <p>Non-secure Domain</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 22</p>
    <p>Overview</p>
    <p>App</p>
    <p>App</p>
    <p>Target Malware</p>
    <p>Rich OS</p>
    <p>Non-secure Domain</p>
    <p>Secure Interrupt Handler</p>
    <p>Secure Domain</p>
    <p>Secure Interrupt</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 23</p>
    <p>Overview</p>
    <p>App</p>
    <p>App</p>
    <p>Target Malware</p>
    <p>Rich OS</p>
    <p>Non-secure Domain</p>
    <p>Secure Interrupt Handler</p>
    <p>Secure Domain</p>
    <p>Secure Interrupt</p>
    <p>Trace Subsystem</p>
    <p>Trace Subsystem:</p>
    <p>Instruction Trace</p>
    <p>System Call Trace</p>
    <p>Android API Trace</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 24</p>
    <p>Overview</p>
    <p>App</p>
    <p>App</p>
    <p>Target Malware</p>
    <p>Rich OS</p>
    <p>Non-secure Domain</p>
    <p>Secure Interrupt Handler</p>
    <p>Secure Domain</p>
    <p>Secure Interrupt</p>
    <p>Trace Subsystem</p>
    <p>Debug Subsystem</p>
    <p>Debug Subsystem:</p>
    <p>Single Stepping</p>
    <p>Breakpoints</p>
    <p>Memory R/W</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 25</p>
    <p>Overview</p>
    <p>App</p>
    <p>App</p>
    <p>Target Malware</p>
    <p>Rich OS</p>
    <p>Non-secure Domain</p>
    <p>Secure Interrupt Handler</p>
    <p>Secure Domain</p>
    <p>Secure Interrupt</p>
    <p>Trace Subsystem</p>
    <p>Debug Subsystem</p>
    <p>Remote Debugging Client</p>
    <p>Secure Port</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 26</p>
    <p>Overview</p>
    <p>App</p>
    <p>App</p>
    <p>Target Malware</p>
    <p>Rich OS</p>
    <p>Non-secure Domain</p>
    <p>Secure Interrupt Handler</p>
    <p>Secure Domain</p>
    <p>Secure Interrupt</p>
    <p>Trace Subsystem</p>
    <p>Debug Subsystem</p>
    <p>Remote Debugging Client</p>
    <p>Secure PortERET</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 27</p>
    <p>Hardware Traps</p>
    <p>Non-secure Domain</p>
    <p>MRS X0, PMCR_EL0 MOV X1, #1</p>
    <p>AND X0, X0, X1</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 28</p>
    <p>Hardware Traps</p>
    <p>Non-secure Domain</p>
    <p>MRS X0, PMCR_EL0 MOV X1, #1</p>
    <p>AND X0, X0, X1</p>
    <p>Analyzing the instruction</p>
    <p>Secure DomainMDCR_EL3.TPM = 1</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 29</p>
    <p>Hardware Traps</p>
    <p>MOV X0, #0x41013000</p>
    <p>Non-secure Domain</p>
    <p>MRS X0, PMCR_EL0 MOV X1, #1</p>
    <p>AND X0, X0, X1</p>
    <p>Analyzing the instruction</p>
    <p>Secure DomainMDCR_EL3.TPM = 1</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 30</p>
    <p>Hardware Traps</p>
    <p>Modifying saved ELR_EL3 MOV X0, #0x41013000</p>
    <p>Non-secure Domain</p>
    <p>MRS X0, PMCR_EL0 MOV X1, #1</p>
    <p>AND X0, X0, X1</p>
    <p>Analyzing the instruction</p>
    <p>Secure DomainMDCR_EL3.TPM = 1</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 31</p>
    <p>Hardware Traps</p>
    <p>ERET Modifying saved ELR_EL3 MOV X0, #0x41013000</p>
    <p>Non-secure Domain</p>
    <p>MRS X0, PMCR_EL0 MOV X1, #1</p>
    <p>AND X0, X0, X1</p>
    <p>Analyzing the instruction</p>
    <p>Secure DomainMDCR_EL3.TPM = 1</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 32</p>
    <p>Outline</p>
    <p>Introduction  Background  System Overview  Evaluation  Conclusion</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 33</p>
    <p>Evaluation - Transparency</p>
    <p>Environment:</p>
    <p>Analyzer:</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 34</p>
    <p>Evaluation - Transparency</p>
    <p>Environment:</p>
    <p>Isolated</p>
    <p>Analyzer:</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 35</p>
    <p>Evaluation - Transparency</p>
    <p>Environment:</p>
    <p>Isolated</p>
    <p>Exists on OTS platforms</p>
    <p>Analyzer:</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 36</p>
    <p>Evaluation - Transparency</p>
    <p>Environment:</p>
    <p>Isolated</p>
    <p>Exists on OTS platforms</p>
    <p>Analyzer:</p>
    <p>No detectable footprints?</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 37</p>
    <p>Evaluation - Transparency</p>
    <p>Environment:</p>
    <p>Isolated</p>
    <p>Exists on OTS platforms</p>
    <p>Analyzer:</p>
    <p>No detectable footprints?</p>
    <p>We believe that the hardware-based approach provides better transparency.</p>
    <p>To build a fully transparent system, we may need additional hardware support.</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 38</p>
    <p>Evaluation  Performance of the TS</p>
    <p>Testbed Specification</p>
    <p>ARM Juno v1 development board</p>
    <p>A dual-core 800 MHZ Cortex-A57 cluster and a quad-core 700 MHZ Cortex-A53 cluster</p>
    <p>ARM Trusted Firmware (ATF) v1.1 and Android 5.1.1</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 39</p>
    <p>Evaluation  Performance of the TS</p>
    <p>Mean STD #Slowdown</p>
    <p>Base: Tracing Disabled 2.133 s 0.69 ms</p>
    <p>Instruction Tracing 2.135 s 2.79 ms 1x</p>
    <p>System call Tracing 2.134 s 5.13 ms 1x</p>
    <p>Android API Tracing 149.372 s 1287.88 ms 70x</p>
    <p>Calculating one million digits of</p>
    <p>GNU Multiple Precision Arithmetic Library</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 40</p>
    <p>Evaluation  Performance of the TS</p>
    <p>Performance scores evaluated by CF-Bench</p>
    <p>Native Scores Java Scores Overall Scores</p>
    <p>Mean #Slowdown Mean #Slowdown Mean #Slowdown</p>
    <p>Basic: Tracing Disabled 25380 18758 21407</p>
    <p>Instruction Tracing 25364 1x 18673 1x 21349 1x</p>
    <p>System call Tracing 25360 1x 18664 1x 21342 1x</p>
    <p>Android API Tracing 6452 4x 122 154x 2654 8x</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 41</p>
    <p>Evaluation  Domain Switching Time</p>
    <p>Time consumption of domain switching (in s)</p>
    <p>34x-1674x faster than MalT (11.72 s)</p>
    <p>ATF Enabled Ninja Enabled Mean STD 95% CI</p>
    <p>0.007 0.000 [0.007, 0.007]</p>
    <p>0.202 0.013 [0.197, 0.207]</p>
    <p>0.342 0.021 [0.334, 0.349]</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 42</p>
    <p>Outline</p>
    <p>Introduction  Background  System Overview  Evaluation  Conclusion</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 43</p>
    <p>Conclusion</p>
    <p>Ninja: A malware analysis framework on ARM. A debug subsystem and a trace subsystem</p>
    <p>Using TrustZone, PMU, and ETM to improve transparency</p>
    <p>The hardware-assisted trace subsystem is immune to timing attack.</p>
  </div>
  <div class="page">
    <p>COMPASS LAB (HTTP://COMPASS.CS.WAYNE.EDU) 44</p>
    <p>Thank you! Email: zhenyu.ning@wayne.edu</p>
    <p>Questions?</p>
  </div>
</Presentation>
