<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>Azure Accelerated Networking: SmartNICs in the Public Cloud</p>
    <p>Daniel Firestone, Andrew Putnam, Sambhrama Mundkur, Derek Chiou, Alireza Dabagh, Mike Andrewartha, Hari Angepat, Vivek Bhanu, Adrian Caulfield, Eric Chung, Harish</p>
    <p>Kumar Chandrappa, Somesh Chaturmohta, Matt Humphrey, Jack Lavier, Norman Lam, Fengfen Liu, Kalin Ovtcharov, Jitu Padhye, Gautham Popuri, Shachar Raindel, Tejas</p>
    <p>Sapre, Mark Shaw, Gabriel Silva, Madhan Sivakumar, Nisheeth Srivastava, Anshuman Verma, Qasim Zuhair, Deepak Bansal, Doug Burger, Kushagra Vaid, David A. Maltz, and</p>
    <p>Albert Greenberg</p>
    <p>Daniel Firestone Tech Lead and Group Manager, Azure Host Networking Team</p>
  </div>
  <div class="page">
    <p>Overview</p>
    <p>Azure and Scale  Recap: Virtual Filtering Platform and Host SDN  Why Accelerated Networking? Scaling up SDN  Hardware Choices  Azure SmartNIC  Accelerated Networking in Azure: Results  Experiences and Lessons Learned  Conclusion and Future</p>
  </div>
  <div class="page">
    <p>Overview</p>
    <p>Azure and Scale  Recap: Virtual Filtering Platform and Host SDN  Why Accelerated Networking? Scaling up SDN  Hardware Choices  Azure SmartNIC  Accelerated Networking in Azure: Results  Experiences and Lessons Learned  Conclusion and Future</p>
  </div>
  <div class="page">
    <p>Microsoft Azure</p>
    <p>mediacaching identity service bus</p>
    <p>mobile services</p>
    <p>cloud services</p>
    <p>virtual machines</p>
    <p>Data Services tableData Lake</p>
    <p>blob storage</p>
    <p>SQL database</p>
    <p>App Services</p>
    <p>media</p>
    <p>hpcintegration analytics</p>
    <p>caching identity service bus</p>
    <p>web apps mobile services</p>
    <p>cloud services</p>
    <p>Infrastructure Services cdn</p>
    <p>virtual machines</p>
    <p>virtual network vpn</p>
    <p>traffic manager</p>
  </div>
  <div class="page">
    <p>Fortune 500 using Microsoft Cloud</p>
    <p>&gt;85%</p>
    <p>TRILLION Azure storage objects</p>
    <p>MILLION Azure Active Directory Orgs</p>
    <p>&gt;50% of Azure VMs are Linux VMs</p>
    <p>TRILLION requests/day</p>
    <p>&gt; 3 TRILLION Azure Event Hubs</p>
    <p>events/week</p>
    <p>&gt;110 BILLION Azure DB requests/day</p>
    <p>Azure Scale &amp; Momentum</p>
    <p>&gt;18 BILLIONAzure Active Directory authentications/week New Azure customers a month</p>
    <p>&gt;120,000</p>
  </div>
  <div class="page"/>
  <div class="page">
    <p>Overview</p>
    <p>Azure and Scale  Recap: Virtual Filtering Platform and Host SDN  Why Accelerated Networking? Scaling up SDN  Hardware Choices  Azure SmartNIC  Accelerated Networking in Azure: Results  Experiences and Lessons Learned  Conclusion and Future</p>
  </div>
  <div class="page">
    <p>Virtual Filtering Platform (VFP) Azures SDN Dataplane</p>
    <p>Virtual switch for Hyper-V / Azure  Provides core SDN functionality for Azure</p>
    <p>networking services, including:  Address Virtualization for VNET  VIP -&gt; DIP Translation for SLB  ACLs, Metering, and Security Guards</p>
    <p>Uses programmable rule/flow tables to perform per-packet actions</p>
    <p>Programmed by multiple Azure SDN controllers, supports all dataplane policy at line rate with offloads</p>
  </div>
  <div class="page">
    <p>Node: 10.4.1.5</p>
    <p>VFP</p>
    <p>Key Primitive: Match Action Tables</p>
    <p>Blue VM1 10.1.1.2</p>
    <p>NIC</p>
    <p>Controllers</p>
    <p>Tenant Description</p>
    <p>VNet Description</p>
    <p>Flow Action</p>
    <p>VNet Routing Policy ACLsNAT</p>
    <p>Endpoints</p>
    <p>Flow ActionFlow Action</p>
    <p>TO: 10.2/16 Encap to GW</p>
    <p>TO: 10.1.1.5 Encap to 10.5.1.7</p>
    <p>TO: !10/8 NAT out of VNET</p>
    <p>Flow ActionFlow Action</p>
    <p>TO: 79.3.1.2 DNAT to 10.1.1.2</p>
    <p>TO: !10/8 SNAT to 79.3.1.2</p>
    <p>Flow Action</p>
    <p>TO: 10.1.1/24 Allow</p>
    <p>TO: !10/8 Allow</p>
    <p>VFP exposes a typed MatchAction-Table API to the agents/controllers</p>
    <p>One table (Layer) per policy  Inspired by OpenFlow and other</p>
    <p>MAT designs, but designed for multi-controller, stateful, scalable host SDN applications</p>
    <p>VNET SLB NAT ACLS</p>
  </div>
  <div class="page">
    <p>Unified Flow Tables  A Fastpath Through VFP</p>
  </div>
  <div class="page">
    <p>Overview</p>
    <p>Azure and Scale  Recap: Virtual Filtering Platform and Host SDN  Why Accelerated Networking? Scaling up SDN  Hardware Choices  Azure SmartNIC  Accelerated Networking in Azure: Results  Experiences and Lessons Learned  Conclusion and Future</p>
  </div>
  <div class="page">
    <p>Scaling Up SDN: NIC Speeds in Azure</p>
    <p>2009: 1Gbps  2012: 10Gbps  2015: 40Gbps  2017: 50Gbps  Soon: 100Gbps?</p>
    <p>We got a 50x improvement in network throughput, but not a 50x improvement in CPU power!</p>
    <p>NIC Speed, Gbps</p>
  </div>
  <div class="page">
    <p>Host SDN worked well at 1GbE, ok at 10GbE what about 40GbE+?</p>
  </div>
  <div class="page">
    <p>Traditional Approach to Scale: ASICs</p>
    <p>Weve worked with network ASIC vendors over the years to accelerate many functions, including:</p>
    <p>TCP offloads: Segmentation, checksum,   Steering: VMQ, RSS,   Encapsulation: NVGRE, VXLAN,   Direct NIC Access: DPDK, PacketDirect,   RDMA</p>
    <p>Is this a long term solution?</p>
  </div>
  <div class="page">
    <p>Example ASIC Solution: Single Root IO Virtualization (SR-IOV) gives</p>
    <p>native performance for virtualized workloads</p>
    <p>But where is the SDN Policy?</p>
  </div>
  <div class="page">
    <p>Hardware or Bust</p>
    <p>SR-IOV is a classic example of an all or nothing offload  its latency, jitter, CPU, performance benefits come from skipping the host entirely</p>
    <p>If even one widely-used action isnt supported in hardware, have to fall back to software path and most of the benefit is lost even if hardware can do 99% of the work</p>
    <p>Other examples: RDMA, DPDK,  a common pattern  This means we need to consider carefully how we will add new</p>
    <p>functionality to our hardware as needed over time</p>
    <p>How do we get the performance of hardware with programmability of software?</p>
  </div>
  <div class="page">
    <p>Overview</p>
    <p>Azure and Scale  Recap: Virtual Filtering Platform and Host SDN  Why Accelerated Networking? Scaling up SDN  Hardware Choices  Azure SmartNIC  Accelerated Networking in Azure: Results  Experiences and Lessons Learned  Conclusion and Future</p>
  </div>
  <div class="page">
    <p>FPGAs</p>
    <p>EFFICIENCY</p>
    <p>Control Unit (CU)</p>
    <p>Registers</p>
    <p>Arithmetic Logic Unit</p>
    <p>(ALU) + + + +</p>
    <p>+ + +</p>
    <p>Silicon alternatives</p>
    <p>FLEXIBILITY</p>
    <p>CPUs G/NPUs ASICs</p>
    <p>Option 5: Dont offload at all, instead make SDN more efficient with e.g. poll-mode DPDK</p>
  </div>
  <div class="page">
    <p>CPU vs. FPGA</p>
  </div>
  <div class="page">
    <p>What is an FPGA, Really?</p>
    <p>Field Programmable Gate Array  Chip has large quantities of programmable</p>
    <p>gates  highly parallel  Program specialized circuits that</p>
    <p>communicate directly  Two kinds of parallelism:</p>
    <p>Thread-level parallelism (stamp out multiple pipelines)</p>
    <p>Pipeline parallelism (create one long pipeline storing many packets at different stages)</p>
    <p>FPGA chips are now large SoCs (can run a control plane)</p>
  </div>
  <div class="page">
    <p>Our Solution: Azure SmartNIC (FPGA)</p>
    <p>HW is needed for scale, perf, and COGS at 40G+</p>
    <p>12-18 month ASIC cycle + time to roll new HW is too slow</p>
    <p>To compete and react to new needs, we need agility  SDN</p>
    <p>Programmed using Generic Flow Tables  Language for programming SDN to hardware  Uses connections and structured actions as primitives</p>
    <p>Bump in the Wire: Reconfigurable FPGA +</p>
    <p>NIC ASIC</p>
    <p>Host</p>
    <p>CPU</p>
    <p>NIC ASIC</p>
    <p>FPGA</p>
    <p>SmartNIC</p>
    <p>ToR</p>
  </div>
  <div class="page">
    <p>FPGAs: Rude Q&amp;A</p>
  </div>
  <div class="page">
    <p>SmartNIC  Accelerating SDN</p>
  </div>
  <div class="page">
    <p>Overview</p>
    <p>Azure and Scale  Recap: Virtual Filtering Platform and Host SDN  Why Accelerated Networking? Scaling up SDN  Hardware Choices  Azure SmartNIC  Accelerated Networking in Azure: Results  Experiences and Lessons Learned  Conclusion and Future</p>
  </div>
  <div class="page">
    <p>Azure Accelerated Networking</p>
    <p>Highest bandwidth VMs of any cloud so far  Standard compute VMs get up to 32Gbps  Stock Linux VM with CUBIC gets 30+Gbps on</p>
    <p>a single connection</p>
    <p>Consistent low latency network performance  Provides SR-IOV to the VM  5x+ latency improvement  sub 15us within tenants  Increased packets per second  Up to 25M PPS (12M forwarding) for DPDK VMs  Reduced jitter means more consistency in workloads</p>
    <p>Enables workloads requiring native performance to run in cloud VMs  &gt;2x improvement for many DB and OLTP applications</p>
  </div>
  <div class="page">
    <p>AccelNet Comparative Results</p>
  </div>
  <div class="page">
    <p>Overview</p>
    <p>Azure and Scale  Recap: Virtual Filtering Platform and Host SDN  Why Accelerated Networking? Scaling up SDN  Hardware Choices  Azure SmartNIC  Accelerated Networking in Azure: Results  Experiences and Lessons Learned  Conclusion and Future</p>
  </div>
  <div class="page">
    <p>Serviceability is Key  All parts of this system can be updated, any of</p>
    <p>which require us to take out the hardware path  or VM can be live migrated</p>
    <p>FPGA image, driver, GFT layer, Vswitch/VFP, NIC PF driver</p>
    <p>IaaS requires high uptime and low disruption  cant take away the NIC device from under the app, and cant reboot the VM / app</p>
    <p>Instead, we keep the synthetic vNIC and support transparent failover between the vNIC and VF</p>
    <p>Added support to Windows, Linux, DPDK (all upstream)</p>
    <p>VF (Hardware)</p>
    <p>vNIC</p>
    <p>Synthetic VM Bus</p>
    <p>TCP/IP</p>
    <p>Lesson: A huge amount of the effort to deploy AccelNet was in making all parts of this path rebootlessly serviceable without impact</p>
  </div>
  <div class="page">
    <p>Timeline</p>
    <p>2009: Azure!  2011-2012: VFP  2013-2014: VFPv2  2H2015: Begin deploying SmartNICs  Summer 2016: AccelNet Preview  Summer 2017: AccelNet Global GA  Late 2017-Early 2018: DPDK</p>
  </div>
  <div class="page">
    <p>Changes, Changes, Changes</p>
    <p>A few examples of many</p>
    <p>TCP and protocol state machines  Complex packet forwarding and duplication actions  New SDN actions  Accelerating the offload path  Line rate diagnostics and monitoring</p>
  </div>
  <div class="page">
    <p>Lessons Learned</p>
    <p>Design for serviceability upfront  Use a unified development team  Use software development techniques for FPGAs  Better perf means better reliability  HW/SW co-design is best when iterative  Failure rates remained low  FPGAs in the DC were reasonably reliable  Upper layers should be agnostic of offloads  Mitigating Spectre performance impact</p>
  </div>
  <div class="page">
    <p>Overview</p>
    <p>Azure and Scale  Recap: Virtual Filtering Platform and Host SDN  Why Accelerated Networking? Scaling up SDN  Hardware Choices  Azure SmartNIC  Accelerated Networking in Azure: Results  Experiences and Lessons Learned  Conclusion and Future</p>
  </div>
  <div class="page">
    <p>Future Work: Everything here is a hardware acceleration of a</p>
    <p>software SDN function what new functions can we build with programmable hardware as</p>
    <p>a base primitive?</p>
  </div>
  <div class="page">
    <p>Conclusion: Software or Hardware? Each has its place</p>
  </div>
  <div class="page">
    <p>Want to come build the next generation of scalable cloud networks? Were hiring!</p>
    <p>fstone@microsoft.com</p>
  </div>
</Presentation>
