<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>The Common Case The Common Case</p>
    <p>Transactional Behavior of Transactional Behavior of</p>
    <p>Multithreaded ProgramsMultithreaded Programs</p>
    <p>JaeWoongJaeWoong ChungChung Hassan ChaHassan Chafifi, Chi Cao Minh, , Chi Cao Minh,</p>
    <p>Austen McDonald, Brian D. Austen McDonald, Brian D. CarlstromCarlstrom,,</p>
    <p>Christos Kozyrakis, Kunle OlukotunChristos Kozyrakis, Kunle Olukotun</p>
    <p>Computer Systems LabComputer Systems Lab</p>
    <p>Stanford UniversityStanford University</p>
    <p>http://http://tcc.stanford.edutcc.stanford.edu</p>
  </div>
  <div class="page">
    <p>The Parallel Programming ProblemThe Parallel Programming Problem</p>
    <p>CMPsCMPs are here but no parallel software to run on themare here but no parallel software to run on them</p>
    <p>LockLock--based parallel programming is simply brokenbased parallel programming is simply broken</p>
    <p>CoarseCoarse--grained locks: serializationgrained locks: serialization</p>
    <p>FineFine--grained locks: deadlocks, races, priority inversion, grained locks: deadlocks, races, priority inversion,</p>
    <p>Poor Poor composabilitycomposability, not fault, not fault--tolerant, tolerant,</p>
    <p>Transactional Memory (TM): an promising alternativeTransactional Memory (TM): an promising alternative</p>
    <p>Transactions: atomic &amp; isolated access to sharedTransactions: atomic &amp; isolated access to shared--memory memory</p>
    <p>Performance through optimistic concurrency Performance through optimistic concurrency</p>
    <p>Parallel programming with TMParallel programming with TM</p>
    <p>Coarse grain NonNon--blocking synchronizationblocking synchronization for parallel for parallel</p>
    <p>algorithmsalgorithms</p>
    <p>Speculative parallelizationSpeculative parallelization for sequential algorithms for sequential algorithms</p>
  </div>
  <div class="page">
    <p>The Design Space for TMThe Design Space for TM</p>
    <p>A transactional memory system providesA transactional memory system provides</p>
    <p>Basics: versioning, conflict resolution, commit, abortBasics: versioning, conflict resolution, commit, abort</p>
    <p>Desired: nesting for libraries, virtualization Desired: nesting for libraries, virtualization</p>
    <p>Several proposed designsSeveral proposed designs</p>
    <p>SoftwareSoftware--only: [DSTM], [OSTM], [ASTM], [SXM], [only: [DSTM], [OSTM], [ASTM], [SXM], [McRTMcRT--STM]STM]</p>
    <p>HardwareHardware--assisted: [TLR], [TCC], [U/LTM], [VTM], [assisted: [TLR], [TCC], [U/LTM], [VTM], [LogTMLogTM]]</p>
    <p>Hybrids: [Hybrids: [HyTMHyTM], [Hybrid], [Hybrid--TM] TM]</p>
    <p>Different tradeoffs in implementing basic/desired featuresDifferent tradeoffs in implementing basic/desired features</p>
    <p>Key questionsKey questions</p>
    <p>Which is the common case to optimize for?Which is the common case to optimize for?</p>
  </div>
  <div class="page">
    <p>In Search of the Common CaseIn Search of the Common Case</p>
    <p>Key metrics of transactional programKey metrics of transactional program  Transaction lengthTransaction length</p>
    <p>Cost of fixed overheads, time virtualization issuesCost of fixed overheads, time virtualization issues</p>
    <p>ReadRead--/write/write--set sizeset size  Buffer space requirements, buffer virtualization issuesBuffer space requirements, buffer virtualization issues</p>
    <p>WriteWrite--set to length ratioset to length ratio  Amortize commit/abort overheadsAmortize commit/abort overheads</p>
    <p>Frequency of nesting &amp; I/O in transactionsFrequency of nesting &amp; I/O in transactions  Support for nesting, Support for nesting, syscallssyscalls, ,</p>
    <p>Frequency of conflictsFrequency of conflicts  Scheduling and contention management policiesScheduling and contention management policies</p>
    <p>The The chicken &amp; egg problemchicken &amp; egg problem  Programmers need efficient TM systems to support developmentProgrammers need efficient TM systems to support development</p>
    <p>Designers need TM applications to derive common caseDesigners need TM applications to derive common case</p>
    <p>Can we break the deadlock?Can we break the deadlock?</p>
  </div>
  <div class="page">
    <p>Paper SummaryPaper Summary</p>
    <p>Study the TM behavior of existing parallel programsStudy the TM behavior of existing parallel programs</p>
    <p>Map existing parallel constructs to transactionsMap existing parallel constructs to transactions</p>
    <p>36 applications, multiple domains, 4 programming models36 applications, multiple domains, 4 programming models</p>
    <p>Analyzed common caseAnalyzed common case for for</p>
    <p>Transaction length, readTransaction length, read--/write/write--set size, writeset size, write--set to length ratio, set to length ratio,</p>
    <p>nesting &amp; I/Onesting &amp; I/O</p>
    <p>For both nonFor both non--blocking synchronization &amp; spec. parallelizationblocking synchronization &amp; spec. parallelization</p>
    <p>Implementation agnostic measurements Implementation agnostic measurements</p>
    <p>Derived guidelinesDerived guidelines for TM system designfor TM system design</p>
    <p>Buffering requirements and virtualization approachBuffering requirements and virtualization approach</p>
    <p>Overhead amortization, nesting &amp; I/O support, Overhead amortization, nesting &amp; I/O support,</p>
  </div>
  <div class="page">
    <p>Methodology OverviewMethodology Overview</p>
    <p>Key assumptionKey assumption</p>
    <p>The inherent parallelism &amp; synchronization patterns are The inherent parallelism &amp; synchronization patterns are</p>
    <p>likely the same regardless of language primitives used likely the same regardless of language primitives used</p>
    <p>MethodologyMethodology</p>
    <p>E.g. lock/unlock E.g. lock/unlock --&gt; transaction begin/end&gt; transaction begin/end</p>
    <p>Measurements are agnostic to TM designMeasurements are agnostic to TM design</p>
    <p>Limitation: cannot measure violation behavior Limitation: cannot measure violation behavior</p>
  </div>
  <div class="page">
    <p>Parallel ApplicationsParallel Applications</p>
    <p>Different domains : scientific, enterprise, AI/robotics, multimeDifferent domains : scientific, enterprise, AI/robotics, multimedia dia</p>
    <p>Different qualities : highly optimized Vs. less optimizedDifferent qualities : highly optimized Vs. less optimized</p>
    <p>Java, Java, PthreadsPthreads, ANL , ANL  studied for nonstudied for non--blocking synchronizationsblocking synchronizations  OpenMPOpenMP  studied for speculative parallelizationstudied for speculative parallelization</p>
    <p>APPLU, APPLU, EquakeEquake, Art, Swim, CG, BT, IS, Art, Swim, CG, BT, ISOpenMPOpenMPSpeculativeSpeculative</p>
    <p>ParallelismParallelism</p>
    <p>Barnes, Mp3d, Ocean, Radix, FMM, Barnes, Mp3d, Ocean, Radix, FMM, CholeskyCholesky, ,</p>
    <p>RadiosityRadiosity, FFT, , FFT, VolrendVolrend, Water, Water--N2, WaterN2, Water--SpatialSpatial</p>
    <p>ANLANL</p>
    <p>Apache, Apache, KingateKingate, Bp, Bp--vision, Localize, Ultra Tic vision, Localize, Ultra Tic TacTac Toe, Toe,</p>
    <p>MPEG2, AOL ServerMPEG2, AOL Server PthreadPthread</p>
    <p>MolDynMolDyn, , MonteCarloMonteCarlo, , RayTracerRayTracer, Crypt, , Crypt, LUFactLUFact, ,</p>
    <p>Series, SOR, Series, SOR, SparseMatmultSparseMatmult, SPECjbb2000, PMD, , SPECjbb2000, PMD,</p>
    <p>HSQLDBHSQLDB</p>
    <p>JavaJavaNonNon--blockingblocking</p>
    <p>SynchronizationSynchronization</p>
    <p>ApplicationsApplicationsLanguagesLanguagesTransaction Transaction</p>
    <p>UsageUsage</p>
  </div>
  <div class="page">
    <p>NonNon--Blocking SynchronizationBlocking Synchronization</p>
    <p>Transactions are used Transactions are used for critical sections in parallel algorithmsfor critical sections in parallel algorithms</p>
    <p>Original primitives mapped to transactional boundaries Original primitives mapped to transactional boundaries</p>
    <p>E.g. Java synchronized block, E.g. Java synchronized block, pthread_mutexpthread_mutex, ANL LOCK macro , ANL LOCK macro</p>
    <p>mapped transaction boundariesmapped transaction boundaries</p>
    <p>Semantics issueSemantics issue</p>
    <p>To conserve the original program semantics, To conserve the original program semantics, waitwait splits transactionsplits transaction</p>
    <p>This mapping is not always safe, but was fine in our studyThis mapping is not always safe, but was fine in our study</p>
    <p>ENDEND--BEGINBEGINWaitWait</p>
    <p>ENDENDUnlockUnlock</p>
    <p>BEGINBEGINLockLock</p>
    <p>Transaction Transaction MappingMapping</p>
    <p>Original Threading Original Threading PrimitivePrimitive</p>
  </div>
  <div class="page">
    <p>Transaction LengthTransaction Length</p>
    <p>Up to Up to 95%95% of transactions have less than of transactions have less than 5000 instructions5000 instructions</p>
    <p>=&gt; =&gt; LightLight--weight transactional primitivesweight transactional primitives are requiredare required</p>
    <p>Some programs have Some programs have rare but long transactionsrare but long transactions</p>
    <p>=&gt; =&gt; Time virtualizationTime virtualization is needed (transaction contextis needed (transaction context--switching) switching)</p>
    <p>MaxMax95th %95th %50th %50th %AvgAvg</p>
    <p>Length in InstructionsLength in Instructions</p>
    <p>ApplicationApplication</p>
    <p>Number of instructions executed in transactionNumber of instructions executed in transaction</p>
  </div>
  <div class="page">
    <p>Time Virtualization for TMTime Virtualization for TM</p>
    <p>Interrupt</p>
    <p>Can wait? No</p>
    <p>Yes</p>
    <p>Wait for a short xaction to</p>
    <p>finish; use its CPU</p>
    <p>for interrupt</p>
    <p>Is there a</p>
    <p>young xaction?</p>
    <p>No</p>
    <p>Abort a young xaction;</p>
    <p>use its CPU for</p>
    <p>interrupt</p>
    <p>Swap out xaction</p>
    <p>to VM; use its CPU</p>
    <p>for interrupt</p>
    <p>Yes</p>
    <p>Interrupt and contextInterrupt and context--switch procedureswitch procedure</p>
    <p>Common</p>
    <p>case Common</p>
    <p>case</p>
    <p>Rare case!</p>
    <p>Handle in VM</p>
    <p>software</p>
    <p>[Satya94][Chen97][Satya94][Chen97]</p>
    <p>OtherOther</p>
    <p>proposalsproposals</p>
  </div>
  <div class="page">
    <p>Percentile of Transactions</p>
    <p>W ri te S e t S iz e i n K b y te s</p>
    <p>ANL Java Pthreads</p>
    <p>Percentile of Transactions</p>
    <p>R e a d S e t S iz e i n K b y te s ANL Java Pthreads</p>
    <p>ReadRead--/Write/Write--Set SizeSet Size</p>
    <p>98% of transactions: &lt;16KB read98% of transactions: &lt;16KB read--set, &lt;6KB write setset, &lt;6KB write set</p>
    <p>=&gt; =&gt; 32K L1 Cache32K L1 Cache will be enough for most transactionswill be enough for most transactions</p>
    <p>There are There are few very large transactionfew very large transaction &gt; 32K&gt; 32K</p>
    <p>=&gt; =&gt; space virtualizationspace virtualization is needed but itis needed but its better be cheaps better be cheap</p>
    <p>Bytes of data read/written by transactionBytes of data read/written by transaction</p>
  </div>
  <div class="page">
    <p>Write-Set Size to Transaction Length Ratio</p>
    <p>P e rc e n ta g e o f T ra n s a c ti o n</p>
    <p>ANL</p>
    <p>Java</p>
    <p>Pthreads</p>
    <p>WriteWrite--Set to Length RatioSet to Length Ratio</p>
    <p>&lt; &lt; 25% in most transactions25% in most transactions</p>
    <p>=&gt;=&gt; Big challenge for SW TM because of high perBig challenge for SW TM because of high per--write overheadwrite overhead</p>
    <p>=&gt; Even HW TM needs sufficient bandwidth for versioning and comm=&gt; Even HW TM needs sufficient bandwidth for versioning and commitit</p>
    <p>Ratio of # unique addresses written to # instructions in transacRatio of # unique addresses written to # instructions in transactiontion</p>
  </div>
  <div class="page">
    <p>Transaction Nesting and I/OTransaction Nesting and I/O</p>
    <p>Nesting occurs only in java VM codeNesting occurs only in java VM code</p>
    <p>2.2 average depth2.2 average depth</p>
    <p>=&gt; =&gt; Limited supportLimited support for nesting is sufficient for now for nesting is sufficient for now</p>
    <p>I/O within transactions is rareI/O within transactions is rare</p>
    <p>27 applications have less than 0.1% of transactions with I/O27 applications have less than 0.1% of transactions with I/O</p>
    <p>8 applications have up to 1% of transactions with I/O8 applications have up to 1% of transactions with I/O</p>
    <p>No transactions include both input and outputNo transactions include both input and output</p>
    <p>=&gt; =&gt; Buffered Buffered I/O would not deadlocknot deadlock</p>
  </div>
  <div class="page">
    <p>Speculative parallelizationSpeculative parallelization</p>
    <p>Speculatively parallelize loops in sequential algorithmsSpeculatively parallelize loops in sequential algorithms</p>
    <p>E.g. each loop iteration becomes a transactionsE.g. each loop iteration becomes a transactions</p>
    <p>This studyThis study</p>
    <p>6 loop based applications6 loop based applications</p>
    <p>Mapped outermost loop iteration to single transactionMapped outermost loop iteration to single transaction</p>
    <p>ENDENDOutermost Iteration EndOutermost Iteration End</p>
    <p>BEGINBEGINOutermost Iteration StartOutermost Iteration Start</p>
    <p>Transaction Transaction MappingMapping</p>
    <p>Original Threading Original Threading PrimitivePrimitive</p>
  </div>
  <div class="page">
    <p>R e a d S e t S iz e i n K b y te s</p>
    <p>equake art is swim cg bt</p>
    <p>Transaction Percentile</p>
    <p>W ri te S e t S iz e i n K b y te s</p>
    <p>equake art is swim cg bt</p>
    <p>ReadRead--/Write/Write--Set SizeSet Size</p>
    <p>The readThe read--/write/write--sets get larger up to L2sets get larger up to L2--sized buffers (~128K)sized buffers (~128K) =&gt; They doesn=&gt; They doesnt fit in L1 cache but still fits into t fit in L1 cache but still fits into L2L2--sized buffersized buffer</p>
    <p>=&gt; =&gt; Inner loop parallelizationInner loop parallelization might be better to reduce buffer requirementmight be better to reduce buffer requirement</p>
    <p>Bytes of data read/written by transactionBytes of data read/written by transaction</p>
  </div>
  <div class="page">
    <p>TakeTake--away Pointsaway Points</p>
    <p>Speculative Speculative</p>
    <p>ParallelismParallelism</p>
    <p>NonNon--blockingblocking</p>
    <p>SynchronizationSynchronization</p>
    <p>TransactionTransaction</p>
    <p>UsageUsage</p>
    <p>L2 cache for versioningL2 cache for versioningLarge readLarge read--/write/write--setssets</p>
    <p>Buffered I/OBuffered I/OFew transactions with I/OFew transactions with I/O</p>
    <p>Limited nesting supportLimited nesting supportFew nested transactionsFew nested transactions</p>
    <p>Per write overhead is criticalPer write overhead is critical</p>
    <p>Challenge for STMChallenge for STM High writeHigh write--set to length ratioset to length ratio</p>
    <p>L1 cache for versioningL1 cache for versioningReadRead--/write/write--sets &lt; 16Ksets &lt; 16K</p>
    <p>LightLight--weight TM primitivesweight TM primitivesShortShort--lived transactionslived transactions</p>
    <p>TM Design GuidelinesTM Design GuidelinesObservationObservation</p>
  </div>
  <div class="page">
    <p>SummarySummary</p>
    <p>Extensive study of transactional behavior of programsExtensive study of transactional behavior of programs</p>
    <p>36 parallel applications from multiple domains36 parallel applications from multiple domains</p>
    <p>Map existing parallel constructs to transactionsMap existing parallel constructs to transactions</p>
    <p>Covered both nonCovered both non--blocking synchronization &amp; speculative blocking synchronization &amp; speculative</p>
    <p>parallelizationparallelization</p>
    <p>ContributionsContributions</p>
    <p>Quantitative ObservationsQuantitative Observations on transactional characteristicson transactional characteristics</p>
    <p>Most transactions are shortMost transactions are short--lived, small, and not nestedlived, small, and not nested</p>
    <p>Design GuidelinesDesign Guidelines for Transactional Memory systemsfor Transactional Memory systems</p>
    <p>Effective Guideline for TM ArchitectsEffective Guideline for TM Architects</p>
  </div>
</Presentation>
