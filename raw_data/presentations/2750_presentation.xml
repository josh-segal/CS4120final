<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>Andromeda Performance, Isolation, and Velocit at</p>
    <p>Scale in Cloud Net ork Virtualization</p>
    <p>NSDI April ,</p>
  </div>
  <div class="page">
    <p>Andromeda Goals</p>
    <p>Performance and Isolation High throughput and lo latenc , regardless of the actions of other tenants</p>
    <p>Velocit Quickl de elop and deplo ne features and performance impro ements</p>
    <p>Scalabilit Large net orks, man tenants, rapid pro isioning</p>
  </div>
  <div class="page">
    <p>Cluster xx 10.1.0.0/16</p>
    <p>Cluster yy 10.2.0.0/16</p>
    <p>vmA</p>
    <p>vmX</p>
    <p>vmY</p>
    <p>vmB</p>
    <p>vmC</p>
    <p>vmD</p>
    <p>vmE</p>
    <p>vmZ</p>
    <p>vmV</p>
    <p>virtual switch</p>
    <p>vmF</p>
    <p>vmM</p>
    <p>vmP</p>
    <p>vmN</p>
    <p>vmL</p>
    <p>vmQ</p>
    <p>virtual switch</p>
    <p>virtual switch</p>
    <p>virtual switch</p>
    <p>virtual switch</p>
    <p>Host 10.1.1.3</p>
    <p>Host 10.1.2.4</p>
    <p>Host 10.1.2.5</p>
    <p>Host 10.2.1.7</p>
    <p>Host 10.1.1.9</p>
    <p>Virtual IP 192.168.0.2 192.168.0.3 192.168.0.4 192.168.0.5 192.168.0.6 192.168.0.7 10.240.0.3 10.240.0.6 10.240.0.7</p>
    <p>vnid 1 1 1 1 1 1 2 2 2</p>
    <p>Host:key local:17 10.1.1.3:1 10.1.2.4:1 10.1.2.4:2 10.1.2.4:3 10.2.1.7:1 10.1.1.3:2 10.1.1.3:2 10.1.1.</p>
    <p>Net ork Virtualization</p>
  </div>
  <div class="page">
    <p>Andromeda Architecture VM ControllerVM ControllerVM Controller</p>
    <p>OpenFlo Front End</p>
    <p>VM Host</p>
    <p>VM</p>
    <p>Virtual s itch</p>
    <p>VM</p>
    <p>VM VM</p>
    <p>VM ControllerVM ControllerVM Controller VM ControllerVM ControllerVM Controller</p>
    <p>OpenFlo Front End</p>
    <p>VM Host</p>
    <p>VM</p>
    <p>Virtual s itch</p>
    <p>VM</p>
    <p>VM VM</p>
    <p>VM Host</p>
    <p>Virtual s itch</p>
    <p>VM</p>
    <p>VM VM</p>
    <p>RPC</p>
    <p>E tended OpenFlo</p>
    <p>Match Actions Match Actions Match Actions</p>
  </div>
  <div class="page">
    <p>Andromeda Architecture VM ControllerVM ControllerVM Controller</p>
    <p>OpenFlo Front End</p>
    <p>VM Host</p>
    <p>VM</p>
    <p>Virtual s itch</p>
    <p>VM</p>
    <p>VM VM</p>
    <p>VM ControllerVM ControllerVM Controller VM ControllerVM ControllerVM Controller</p>
    <p>OpenFlo Front End</p>
    <p>VM Host</p>
    <p>VM</p>
    <p>Virtual s itch</p>
    <p>VM</p>
    <p>VM VM</p>
    <p>VM Host</p>
    <p>VM</p>
    <p>Virtual s itch</p>
    <p>VM</p>
    <p>VM VM</p>
    <p>RPC</p>
    <p>E tended OpenFlo</p>
    <p>Match Actions Match Actions Match Actions</p>
  </div>
  <div class="page">
    <p>Andromeda Architecture VM ControllerVM ControllerVM Controller</p>
    <p>OpenFlo Front End</p>
    <p>VM Host</p>
    <p>VM</p>
    <p>Virtual s itch</p>
    <p>VM</p>
    <p>VM VM</p>
    <p>VM ControllerVM ControllerVM Controller VM ControllerVM ControllerVM Controller</p>
    <p>OpenFlo Front End</p>
    <p>VM Host</p>
    <p>VM</p>
    <p>Virtual s itch</p>
    <p>VM</p>
    <p>VM VM</p>
    <p>VM Host</p>
    <p>VM</p>
    <p>Virtual s itch</p>
    <p>VM</p>
    <p>VM VM</p>
    <p>RPC</p>
    <p>E tended OpenFlo</p>
    <p>Match Actions Match Actions Match Actions</p>
  </div>
  <div class="page">
    <p>Andromeda Architecture VM ControllerVM ControllerVM Controller</p>
    <p>OpenFlo Front End</p>
    <p>VM Host</p>
    <p>VM</p>
    <p>Virtual s itch</p>
    <p>VM</p>
    <p>VM VM</p>
    <p>VM ControllerVM ControllerVM Controller VM ControllerVM ControllerVM Controller</p>
    <p>OpenFlo Front End</p>
    <p>VM Host</p>
    <p>VM</p>
    <p>Virtual s itch</p>
    <p>VM</p>
    <p>VM VM</p>
    <p>VM Host</p>
    <p>VM</p>
    <p>Virtual s itch</p>
    <p>VM</p>
    <p>VM VM</p>
    <p>RPC</p>
    <p>E tended OpenFlo</p>
    <p>Match Actions Match Actions Match Actions</p>
  </div>
  <div class="page">
    <p>Scaling Goals</p>
    <p>Global connecti it</p>
    <p>Large irtual net orks k+ VMs</p>
    <p>Rapid pro isioning Enable on-demand orkloads</p>
  </div>
  <div class="page">
    <p>Programming Time for Large Net orks Setup:  VMs are placed on , hosts  VM Controller partitions</p>
    <p>Programming time is O nH n = number of VMs H = number of hosts</p>
    <p>Quadratic scaling leads to pro isioning challenges  Control plane CPU and memor  Dataplane memor</p>
  </div>
  <div class="page">
    <p>mA</p>
    <p>mX</p>
    <p>mY</p>
    <p>mB</p>
    <p>mD</p>
    <p>irtual s itch</p>
    <p>mC</p>
    <p>irtual s itch</p>
    <p>Host . . .</p>
    <p>Host . . .</p>
    <p>Scaling ith Ho erboards</p>
    <p>HoverboardHoverboard Hoverboard</p>
    <p>vmE</p>
    <p>vmZ</p>
    <p>vmV</p>
    <p>virtual switch</p>
    <p>Host 10.1.2.5</p>
    <p>low priority route</p>
  </div>
  <div class="page">
    <p>mA</p>
    <p>mX</p>
    <p>mY</p>
    <p>mB</p>
    <p>mD</p>
    <p>irtual s itch</p>
    <p>mC</p>
    <p>irtual s itch</p>
    <p>Host . . .</p>
    <p>Host . . .</p>
    <p>Ho erboard Offloading</p>
    <p>HoverboardHoverboard Hoverboard</p>
    <p>vmE</p>
    <p>vmZ</p>
    <p>vmV</p>
    <p>virtual switch</p>
    <p>Host 10.1.2.5</p>
    <p>vmX  vmZ off load flow</p>
    <p>low priority route</p>
  </div>
  <div class="page">
    <p>mA</p>
    <p>mX</p>
    <p>mY</p>
    <p>mB</p>
    <p>mD</p>
    <p>irtual s itch</p>
    <p>mC</p>
    <p>irtual s itch</p>
    <p>Host . . .</p>
    <p>Host . . .</p>
    <p>Ho erboard Offloading</p>
    <p>HoverboardHoverboard Hoverboard</p>
    <p>vmE</p>
    <p>vmZ</p>
    <p>vmV</p>
    <p>virtual switch</p>
    <p>Host 10.1.2.5</p>
    <p>low priority route</p>
    <p>vmX  vmZ off load flow</p>
    <p>VM Controller</p>
    <p>OpenFlow Front Endst ats</p>
    <p>flow prog</p>
    <p>ramm ing</p>
  </div>
  <div class="page">
    <p>Ho erboards reduce time to program net ork connecti it for large net orks</p>
    <p>faster for a , -VM net ork</p>
    <p>Programming Time for Large Net orks</p>
  </div>
  <div class="page">
    <p>Wh Ho erboards Are Effecti e</p>
    <p>% of VM pairs ha e peak throughput &lt; kbps</p>
    <p>o er % of VM pairs ne er communicate</p>
    <p>Peak throughput for all VM pairs in all virtual networks in one cluster over a 30-minute interval</p>
    <p>Today, more than 99.5% of traffic is offloaded.</p>
  </div>
  <div class="page">
    <p>Andromeda Data Plane</p>
    <p>VM Host Open vSwitch</p>
    <p>Host OS Kernel</p>
    <p>NIC</p>
    <p>Extended OpenFlow</p>
    <p>OpenFlo Front End OS bypass, busy polling dedicated CPU Fast Path for high performance</p>
    <p>Userspace dataplane, live migration, and hitless upgrades for feature velocity</p>
    <p>Manages on-host Flow Tables</p>
  </div>
  <div class="page">
    <p>Andromeda Data Plane</p>
    <p>VM Host Management Plane</p>
    <p>Open vSwitch</p>
    <p>Host OS Kernel</p>
    <p>NIC</p>
    <p>Extended OpenFlow</p>
    <p>OpenFlo Front End OS bypass, busy polling dedicated CPU Fast Path for high performance</p>
    <p>Userspace dataplane, live migration, and hitless upgrades for feature velocity</p>
    <p>Manages on-host VMs</p>
  </div>
  <div class="page">
    <p>Andromeda Data Plane</p>
    <p>VM Host Management Plane</p>
    <p>Open vSwitch</p>
    <p>Andromeda Fast Path</p>
    <p>Host OS Kernel</p>
    <p>NIC</p>
    <p>Extended OpenFlow</p>
    <p>OpenFlo Front End OS bypass, busy polling dedicated CPU Fast Path for high performance</p>
    <p>Userspace dataplane, live migration, and hitless upgrades for feature velocity</p>
    <p>Busy polls physical &amp; virtual NIC queues, forwards VM packets</p>
  </div>
  <div class="page">
    <p>Andromeda Data Plane</p>
    <p>VM Host Management Plane</p>
    <p>Open vSwitch</p>
    <p>Andromeda Fast Path Match Action</p>
    <p>Flo cache</p>
    <p>miss insert</p>
    <p>Host OS Kernel</p>
    <p>NIC</p>
    <p>Extended OpenFlow</p>
    <p>OpenFlo Front End OS bypass, busy polling dedicated CPU Fast Path for high performance</p>
    <p>Userspace dataplane, live migration, and hitless upgrades for feature velocity</p>
    <p>Routes packet, applies per-flow Fast Path actions (encap, decap, etc)</p>
  </div>
  <div class="page">
    <p>Andromeda Data Plane</p>
    <p>VM Host Management Plane</p>
    <p>Open vSwitch</p>
    <p>Guest VM Coprocessor</p>
    <p>Andromeda Fast Path Match Action</p>
    <p>Flo cache</p>
    <p>miss insert</p>
    <p>Host OS Kernel</p>
    <p>NIC</p>
    <p>Extended OpenFlow</p>
    <p>OpenFlo Front End OS bypass, busy polling dedicated CPU Fast Path for high performance</p>
    <p>Userspace dataplane, live migration, and hitless upgrades for feature velocity</p>
    <p>Per-VM attributed threads for executing CPU-intensive packet ops (e.g., DoS)</p>
  </div>
  <div class="page">
    <p>Andromeda Data Plane</p>
    <p>VM Host Management Plane</p>
    <p>Open vSwitchGuest VM</p>
    <p>Guest VM Coprocessor</p>
    <p>Andromeda Fast Path Match Action</p>
    <p>Flo cache</p>
    <p>miss insert</p>
    <p>Host OS Kernel</p>
    <p>NIC</p>
    <p>shared memory ring</p>
    <p>Extended OpenFlow</p>
    <p>OpenFlo Front End OS bypass, busy polling dedicated CPU Fast Path for high performance</p>
    <p>Userspace dataplane, live migration, and hitless upgrades for feature velocity</p>
    <p>Fast Path polls guest VM rings &amp; copies packets to/from guest VM memory</p>
  </div>
  <div class="page">
    <p>Data Plane - Fast Path</p>
    <p>VM Host Management Plane</p>
    <p>Open vSwitchGuest VM</p>
    <p>Guest VM Coprocessor</p>
    <p>Andromeda Fast Path</p>
    <p>miss insert</p>
    <p>Host OS Kernel</p>
    <p>NIC</p>
    <p>Extended OpenFlow</p>
    <p>OpenFlo Front End High performance traffic processed end-to-end on Fast Path</p>
    <p>&gt; 30Gb/s throughput &amp; &gt; 3M pps on one core</p>
    <p>Flow Table performs routing, encap/decap, etc.</p>
    <p>Fast Path polls virtual &amp; physical NIC rings</p>
    <p>Packet Match Action</p>
    <p>Flo cache</p>
    <p>Pull packet from NIC Parse, TcpDump, ...</p>
  </div>
  <div class="page">
    <p>Data Plane - Fast Path</p>
    <p>VM Host Management Plane</p>
    <p>Open vSwitchGuest VM</p>
    <p>Guest VM Coprocessor</p>
    <p>Andromeda Fast Path</p>
    <p>miss insert</p>
    <p>Host OS Kernel</p>
    <p>NIC</p>
    <p>Extended OpenFlow</p>
    <p>OpenFlo Front End High performance traffic processed end-to-end on Fast Path</p>
    <p>&gt; 30Gb/s throughput &amp; &gt; 3M pps on one core</p>
    <p>Flow Table performs routing, encap/decap, etc.</p>
    <p>Fast Path polls virtual &amp; physical NIC rings</p>
    <p>Packet</p>
    <p>Match Action</p>
    <p>Flow Lookup Route, decap, ...</p>
  </div>
  <div class="page">
    <p>Data Plane - Fast Path</p>
    <p>VM Host Management Plane</p>
    <p>Open vSwitchGuest VM</p>
    <p>Guest VM Coprocessor</p>
    <p>Andromeda Fast Path</p>
    <p>miss insert</p>
    <p>Host OS Kernel</p>
    <p>NIC</p>
    <p>Extended OpenFlow</p>
    <p>OpenFlo Front End High performance traffic processed end-to-end on Fast Path</p>
    <p>&gt; 30Gb/s throughput &amp; &gt; 3M pps on one core</p>
    <p>Flow Table performs routing, encap/decap, etc.</p>
    <p>Fast Path polls virtual &amp; physical NIC rings</p>
    <p>Packet</p>
    <p>Match Action</p>
    <p>Deliver packet to VM Copy, update rings, ...</p>
    <p>Flo cache</p>
  </div>
  <div class="page">
    <p>Data Plane - Coprocessor Path</p>
    <p>VM Host Management Plane</p>
    <p>Open vSwitchGuest VM</p>
    <p>Guest VM Coprocessor</p>
    <p>Andromeda Fast Path</p>
    <p>miss insert</p>
    <p>Host OS Kernel</p>
    <p>NIC</p>
    <p>Extended OpenFlow</p>
    <p>OpenFlo Front End</p>
    <p>Packet Match Action</p>
    <p>Flo cache</p>
    <p>Pull packet from NIC Parse, TcpDump, ...</p>
    <p>Coprocessors are per-VM threads CPU attributed to VM container</p>
    <p>Coprocessors execute CPU-intensive packet ops such as DoS</p>
    <p>Decouples feature growth from Fast Path speed</p>
  </div>
  <div class="page">
    <p>Data Plane - Coprocessor Path</p>
    <p>VM Host Management Plane</p>
    <p>Open vSwitchGuest VM</p>
    <p>Guest VM Coprocessor</p>
    <p>Andromeda Fast Path</p>
    <p>miss insert</p>
    <p>Host OS Kernel</p>
    <p>NIC</p>
    <p>Extended OpenFlow</p>
    <p>OpenFlo Front End</p>
    <p>Packet</p>
    <p>Match Action</p>
    <p>Flow Lookup Route, decap, set Coprocessor stages...</p>
    <p>Coprocessors are per-VM threads CPU attributed to VM container</p>
    <p>Coprocessors execute CPU-intensive packet ops such as DoS</p>
    <p>Decouples feature growth from Fast Path speed</p>
  </div>
  <div class="page">
    <p>Data Plane - Coprocessor Path</p>
    <p>VM Host Management Plane</p>
    <p>Open vSwitchGuest VM</p>
    <p>Guest VM Coprocessor</p>
    <p>Andromeda Fast Path</p>
    <p>miss insert</p>
    <p>Host OS Kernel</p>
    <p>NIC</p>
    <p>Extended OpenFlow</p>
    <p>OpenFlo Front End</p>
    <p>Match Action</p>
    <p>Flo cache</p>
    <p>Packet</p>
    <p>Send to Coprocessor Apply Coprocessor stages (e.g., DoS)</p>
    <p>Coprocessors are per-VM threads CPU attributed to VM container</p>
    <p>Coprocessors execute CPU-intensive packet ops such as DoS</p>
    <p>Decouples feature growth from Fast Path speed</p>
  </div>
  <div class="page">
    <p>Data Plane - Coprocessor Path</p>
    <p>VM Host Management Plane</p>
    <p>Open vSwitchGuest VM</p>
    <p>Guest VM Coprocessor</p>
    <p>Andromeda Fast Path</p>
    <p>miss insert</p>
    <p>Host OS Kernel</p>
    <p>NIC</p>
    <p>Extended OpenFlow</p>
    <p>OpenFlo Front End</p>
    <p>Packet</p>
    <p>Match Action</p>
    <p>Flo cache</p>
    <p>Deliver packet to VM Copy, update rings, ...</p>
    <p>Coprocessors are per-VM threads CPU attributed to VM container</p>
    <p>Coprocessors execute CPU-intensive packet ops such as DoS</p>
    <p>Decouples feature growth from Fast Path speed</p>
  </div>
  <div class="page">
    <p>VM-VM Throughput Single core per host for dataplane Fast Path. Sk lake testbed hosts.</p>
    <p>Both hosts connected to same Top of Rack s itch.</p>
  </div>
  <div class="page">
    <p>VM-VM Round Trip Latenc Single core per host for dataplane Fast Path. Sk lake testbed hosts.</p>
    <p>Both hosts connected to same Top of Rack s itch.</p>
  </div>
  <div class="page">
    <p>CPU Efficienc</p>
    <p>Minimizing host and guest net ork CPU c cles per b te CPB is critical</p>
    <p>Since initial production release, e ha e impro ed CPB b &gt; 6 as measured on sender + recei er host during a multi-stream benchmark.</p>
    <p>Andromeda . + use a single core per host for the dataplane Fast Path. Results from Sand bridge testbed hosts connected to same ToR s itch.</p>
  </div>
  <div class="page">
    <p>CPU Efficienc E olution</p>
    <p>Host: 43.5 Guest:16.0</p>
    <p>Host: 30.4 Guest:12.3</p>
    <p>Host: 5.4 Guest: 5.6</p>
    <p>Host: 2.6 Guest: 5.0</p>
    <p>Host: 2.0 Guest: 4.9</p>
    <p>Andromeda 1.0 Kernel datapath</p>
    <p>Andromeda 1.5 Optimize pipeline</p>
    <p>Andromeda 2.0 OS bypass, 1 thread hop</p>
    <p>Andromeda 2.1 Remove thread hop</p>
    <p>Andromeda 2.2 Memory copy offload</p>
  </div>
  <div class="page">
    <p>Velocit A rapid release c cle enables s ift deplo ment of features &amp; bug fi es.</p>
    <p>Our dataplane has eekl rollouts ia non-disrupti e upgrades.</p>
    <p>Li e migration allo s VMs to be migrated bet een ph sical host ithout disruption, enabling transparent host maintenance.</p>
  </div>
  <div class="page">
    <p>Dataplane Hitless Upgrade /</p>
    <p>Physical NIC</p>
    <p>Upgrade Brownout</p>
    <p>Old Dataplane state is transferred to New Dataplane in the background</p>
    <p>Old Dataplane continues serving physical NIC &amp; virtual NIC queues</p>
    <p>State XferOld Dataplane New Dataplane</p>
    <p>Guest VM</p>
  </div>
  <div class="page">
    <p>Dataplane Hitless Upgrade /</p>
    <p>Physical NIC</p>
    <p>State XferOld Dataplane New Dataplane</p>
    <p>Guest VM</p>
    <p>Upgrade Blackout</p>
    <p>Old Dataplane stops serving virtual &amp; physical NIC queues</p>
    <p>Then, any updated (delta) Old Dataplane state is transferred to New Dataplane</p>
  </div>
  <div class="page">
    <p>Dataplane Hitless Upgrade /</p>
    <p>Physical NIC</p>
    <p>New Dataplane</p>
    <p>Guest VM</p>
    <p>Upgrade Complete</p>
    <p>State xfer done. Median blackout time is 270ms.</p>
    <p>New Dataplane starts serving VM virtual NIC &amp; physical NIC queues</p>
    <p>Old dataplane terminated</p>
  </div>
  <div class="page">
    <p>Conclusion We ha e discussed the design and e olution of Andromeda</p>
    <p>Control plane scalabilit &amp; Rapid pro isioning</p>
    <p>Ho erboard model a oids programming long tail of mostl idle flo s on VM host. Scales to k VMs/net ork</p>
    <p>High performance &amp; Feature elocit</p>
    <p>OS B pass dedicated CPU dataplane pro ides high performance &gt; Gb/s, &gt; M pps ith core &amp; eekl non-disrupti e updates</p>
  </div>
</Presentation>
