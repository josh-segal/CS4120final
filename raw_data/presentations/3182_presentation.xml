<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>BareCloud:</p>
    <p>Bare-metal Analysis-based Evasive</p>
    <p>Malware Detection</p>
    <p>Dhilung Kirat, Giovanni Vigna, Christopher Kruegel</p>
    <p>UC Santa Barbara</p>
    <p>USENIX Security 2014</p>
    <p>San Diego, CA</p>
  </div>
  <div class="page">
    <p>Dynamic Malware Analysis</p>
    <p>Execute Behavior Profiles</p>
    <p>Reports</p>
  </div>
  <div class="page">
    <p>Dynamic Malware Analysis</p>
    <p>Execute Behavior Profiles</p>
    <p>Reports</p>
  </div>
  <div class="page">
    <p>Dynamic Malware Analysis</p>
    <p>Virtualization/Emulation</p>
    <p>Execute Behavior Profiles</p>
    <p>Reports</p>
  </div>
  <div class="page">
    <p>Dynamic Malware Analysis</p>
    <p>Virtualization/Emulation</p>
    <p>Execute Behavior Profiles</p>
    <p>Reports</p>
    <p>Evasive Malware</p>
  </div>
  <div class="page">
    <p>Dynamic Malware Analysis</p>
    <p>Virtualization/Emulation</p>
    <p>Execute</p>
    <p>Evasive Malware</p>
  </div>
  <div class="page">
    <p>Detect Analysis Environment</p>
    <p>Disk  HKLM\Hardware\DeviceMap\Scsi  HKLM\System\CurrentControlSet\Services\Disk\Enum</p>
    <p>Bios  HKLM\Hardware\Description\System\SystemBiosVersion</p>
    <p>Keyboard/Mouse  Presence of mouse, keyboard layout</p>
    <p>User  Username, Windows Product ID  Active user</p>
  </div>
  <div class="page">
    <p>Detect Analysis Environment</p>
    <p>CPU  SIDT instruction</p>
    <p>CPU Emulation bug (including MMX instruction set)</p>
    <p>Vulnerability  CVE-2012-3221 VirtualBox</p>
    <p>Timing attack  The virtualization and emulation systems add some level</p>
    <p>of overhead</p>
  </div>
  <div class="page">
    <p>Fully Undetectable (FUD)</p>
  </div>
  <div class="page">
    <p>Dynamic Malware Analysis</p>
    <p>Execute Profiles Reports</p>
    <p>Solutions?</p>
  </div>
  <div class="page">
    <p>Dynamic Malware Analysis</p>
    <p>Execute Profiles Reports</p>
    <p>Transparent Analysis</p>
  </div>
  <div class="page">
    <p>Transparent Analysis</p>
    <p>Monitoring Components</p>
    <p>Execution Environment</p>
  </div>
  <div class="page">
    <p>Dynamic Malware Analysis</p>
    <p>Transparency Visibility</p>
  </div>
  <div class="page">
    <p>Can we automatically identify</p>
    <p>evasive malware under reduced</p>
    <p>visibility?</p>
  </div>
  <div class="page">
    <p>Dynamic Malware Analysis</p>
    <p>Bare-metal system</p>
    <p>Execute Profiles Reports</p>
    <p>BareCloud</p>
  </div>
  <div class="page">
    <p>Dynamic Malware Analysis</p>
    <p>Bare-metal system</p>
    <p>Execute Profiles Reports</p>
    <p>BareCloud</p>
    <p>No in-guest</p>
    <p>monitoring component</p>
  </div>
  <div class="page">
    <p>Dynamic Malware Analysis</p>
    <p>Bare-metal system</p>
    <p>BareCloud</p>
    <p>LVM Snapshot</p>
    <p>Network Activities</p>
    <p>Network Packets</p>
    <p>File Activities</p>
    <p>SleuthKit</p>
    <p>iSCSI</p>
    <p>IPMI</p>
  </div>
  <div class="page">
    <p>Dynamic Malware Analysis</p>
    <p>Bare-metal system</p>
    <p>BareCloud</p>
    <p>LVM Snapshot</p>
    <p>Network Activities</p>
    <p>Network Packets</p>
    <p>File Activities</p>
    <p>SleuthKit</p>
    <p>iSCSI</p>
    <p>IPMI</p>
  </div>
  <div class="page">
    <p>BareCloud</p>
    <p>Baremetal</p>
    <p>Behavior Profile</p>
  </div>
  <div class="page">
    <p>BareCloud</p>
    <p>Ether  Baremetal</p>
    <p>Behavior Profile</p>
    <p>Behavior Profile</p>
  </div>
  <div class="page">
    <p>BareCloud</p>
    <p>Anubis</p>
    <p>Ether  Baremetal</p>
    <p>Behavior Profile</p>
    <p>Behavior Profile</p>
    <p>Behavior</p>
    <p>Profile</p>
  </div>
  <div class="page">
    <p>BareCloud</p>
    <p>VBox  Anubis</p>
    <p>Ether  Baremetal</p>
    <p>Behavior Profile</p>
    <p>Behavior Profile</p>
    <p>Behavior</p>
    <p>Profile</p>
    <p>Behavior</p>
    <p>Profile</p>
  </div>
  <div class="page">
    <p>BareCloud</p>
    <p>VBox  Anubis</p>
    <p>Ether  Baremetal</p>
    <p>Behavior Profile</p>
    <p>Behavior Profile</p>
    <p>Behavior</p>
    <p>Profile</p>
    <p>Behavior</p>
    <p>Profile</p>
  </div>
  <div class="page">
    <p>BareCloud</p>
    <p>VBox  Anubis</p>
    <p>Ether  Baremetal</p>
    <p>Behavior Profile</p>
    <p>Behavior Profile</p>
    <p>Behavior</p>
    <p>Profile</p>
    <p>Behavior</p>
    <p>Profile</p>
  </div>
  <div class="page">
    <p>Transient vs. Persistent</p>
    <p>All Ac&gt;vi&gt;es Behavior Normaliza&gt;on Persistent Changes</p>
  </div>
  <div class="page">
    <p>Behavior Deviation</p>
    <p>Malware</p>
    <p>Evasion</p>
    <p>Programed Randomiza&gt;on  Normalize behavior  Hierarchical Similarity</p>
    <p>Analysis System Internal SoIware Environment  Iden&gt;cal setup</p>
    <p>External Network Environment  Simultaneous Execu&gt;on  Iden&gt;cal External Network  Consistent Reply</p>
  </div>
  <div class="page">
    <p>Behavior Comparison</p>
    <p>Behavior Profile</p>
    <p>A</p>
    <p>Behavior Profile</p>
    <p>B</p>
  </div>
  <div class="page">
    <p>Behavior Comparison</p>
    <p>Behavior Profile</p>
    <p>A</p>
    <p>Behavior Profile</p>
    <p>B</p>
    <p>JaccardSimilarity = AB AB</p>
  </div>
  <div class="page">
    <p>Behavior Comparison</p>
    <p>Profile A Create file X</p>
    <p>Create file Y</p>
    <p>Create file Z</p>
    <p>Profile B Create file X</p>
    <p>Create file Y</p>
    <p>Modify file Z</p>
    <p>Profile C</p>
    <p>Create file X</p>
    <p>Create file Y</p>
    <p>Connect to C&amp;C</p>
  </div>
  <div class="page">
    <p>Behavior Comparison</p>
    <p>Profile A</p>
    <p>Create file X</p>
    <p>Create file Y</p>
    <p>Create file Z</p>
    <p>Profile B</p>
    <p>Create file X</p>
    <p>Create file Y</p>
    <p>Modify file Z</p>
    <p>Profile C</p>
    <p>Create file X</p>
    <p>Create file Y</p>
    <p>Connect to C&amp;C</p>
  </div>
  <div class="page">
    <p>Behavior Comparison</p>
    <p>Profile A Create file X</p>
    <p>Create file Y</p>
    <p>Create file Z</p>
    <p>Profile B Create file X</p>
    <p>Create file Y</p>
    <p>Modify file Z</p>
    <p>Profile C Create file X</p>
    <p>Create file Y</p>
    <p>Connect to C&amp;C</p>
    <p>JaccardSimilarity(A, B) = 2/4 = JaccardSimilarity(A, C)</p>
  </div>
  <div class="page">
    <p>Behavior Comparison</p>
    <p>Behavior Profile</p>
    <p>A</p>
    <p>Behavior Profile</p>
    <p>B</p>
  </div>
  <div class="page">
    <p>Behavior Comparison</p>
    <p>Behavior Profile</p>
    <p>A</p>
    <p>Behavior Profile</p>
    <p>B</p>
    <p>What type of events?  Filesystem?  Network?</p>
    <p>Are events related to the same object?</p>
    <p>Same file?  Same network endpoint?</p>
    <p>What type of opera&gt;ons?</p>
    <p>Create?  Delete?  HTTP?</p>
  </div>
  <div class="page">
    <p>Behavior Similarity Hierarchy</p>
    <p>Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
  </div>
  <div class="page">
    <p>Behavior Similarity Hierarchy</p>
    <p>Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Z</p>
    <p>create</p>
    <p>size</p>
    <p>Profile A</p>
    <p>Create file X</p>
    <p>Create file Y</p>
    <p>Create file Z</p>
  </div>
  <div class="page">
    <p>Behavior Similarity Hierarchy</p>
    <p>Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Z</p>
    <p>modify</p>
    <p>size</p>
    <p>Profile B</p>
    <p>Create file X</p>
    <p>Create file Y</p>
    <p>Modify file Z</p>
  </div>
  <div class="page">
    <p>Behavior Similarity Hierarchy</p>
    <p>Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>network</p>
    <p>C&amp;C Address</p>
    <p>hWp</p>
    <p>size</p>
    <p>Profile C</p>
    <p>Create file X</p>
    <p>Create file Y</p>
    <p>Connect to C&amp;C</p>
  </div>
  <div class="page">
    <p>Hierarchical Similarity</p>
    <p>Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>network</p>
    <p>C&amp;C Address</p>
    <p>hWp</p>
    <p>size Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Z</p>
    <p>create</p>
    <p>size</p>
    <p>Profile A Profile C</p>
  </div>
  <div class="page">
    <p>Hierarchical Similarity</p>
    <p>Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>network</p>
    <p>C&amp;C Address</p>
    <p>hWp</p>
    <p>size Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Z</p>
    <p>create</p>
    <p>size</p>
    <p>Profile A Profile C</p>
    <p>Candidate Sets</p>
  </div>
  <div class="page">
    <p>Hierarchical Similarity</p>
    <p>Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>network</p>
    <p>C&amp;C Address</p>
    <p>hWp</p>
    <p>size Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Z</p>
    <p>create</p>
    <p>size</p>
    <p>Profile A Profile C</p>
    <p>Candidate Sets</p>
  </div>
  <div class="page">
    <p>Hierarchical Similarity</p>
    <p>Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>network</p>
    <p>C&amp;C Address</p>
    <p>hWp</p>
    <p>size Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Z</p>
    <p>create</p>
    <p>size</p>
    <p>Sim1 = 1/2</p>
    <p>Profile A Profile C</p>
    <p>Candidate Sets</p>
  </div>
  <div class="page">
    <p>Hierarchical Similarity</p>
    <p>Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>network</p>
    <p>C&amp;C Address</p>
    <p>hWp</p>
    <p>size Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Z</p>
    <p>create</p>
    <p>size</p>
    <p>Sim1 = 1/2</p>
    <p>Profile A Profile C</p>
    <p>Candidate Sets</p>
  </div>
  <div class="page">
    <p>Hierarchical Similarity</p>
    <p>Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>network</p>
    <p>C&amp;C Address</p>
    <p>hWp</p>
    <p>size Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Z</p>
    <p>create</p>
    <p>size</p>
    <p>Sim1 = 1/2</p>
    <p>Sim2 = 2/3</p>
    <p>Profile A Profile C</p>
  </div>
  <div class="page">
    <p>Hierarchical Similarity</p>
    <p>Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>network</p>
    <p>C&amp;C Address</p>
    <p>hWp</p>
    <p>size Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Z</p>
    <p>create</p>
    <p>size</p>
    <p>Sim1 = 1/2</p>
    <p>Sim2 = 2/3</p>
    <p>Sim3 = 1</p>
    <p>Sim4 = 1</p>
    <p>Profile A Profile C</p>
  </div>
  <div class="page">
    <p>Hierarchical Similarity</p>
    <p>Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>network</p>
    <p>C&amp;C Address</p>
    <p>hWp</p>
    <p>size Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Z</p>
    <p>create</p>
    <p>size</p>
    <p>Sim1 = 1/2</p>
    <p>Sim2 = 2/3</p>
    <p>Sim3 = 1</p>
    <p>Sim4 = 1</p>
    <p>Sim(A, C) = AVG(Sim1  Sim4) = 0.79</p>
    <p>Profile A Profile C</p>
  </div>
  <div class="page">
    <p>Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Z</p>
    <p>modify</p>
    <p>size</p>
    <p>Hierarchical Similarity</p>
    <p>Opera&gt;on AWribute</p>
    <p>Opera&gt;on Name</p>
    <p>Object Name</p>
    <p>Object Type</p>
    <p>root</p>
    <p>file</p>
    <p>C:\X</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Y</p>
    <p>create</p>
    <p>size</p>
    <p>C:\Z</p>
    <p>create</p>
    <p>size</p>
    <p>Sim1 = 1</p>
    <p>Sim2 = 1</p>
    <p>Sim3 = 1/2</p>
    <p>Sim4 = 1</p>
    <p>Sim(A, B) = AVG(Sim1  Sim4) = 0.87</p>
    <p>Profile A Profile B</p>
  </div>
  <div class="page">
    <p>Behavior Comparison</p>
    <p>Profile A</p>
    <p>Create file X</p>
    <p>Create file Y</p>
    <p>Create file Z</p>
    <p>Profile B</p>
    <p>Create file X</p>
    <p>Create file Y</p>
    <p>Modify file Z</p>
    <p>Profile C</p>
    <p>Create file X</p>
    <p>Create file Y</p>
    <p>Connect to C&amp;C</p>
    <p>JaccardSimilarity(A, B) == JaccardSimilarity(A, C)</p>
    <p>HierarchicalSim(A, B) &gt; HierarchicalSim(A, C) 0.87 &gt; 0.79</p>
  </div>
  <div class="page">
    <p>Deviation Score</p>
    <p>Behavior Distance Distance(A, B) = 1 - Sim(A, B)</p>
    <p>Deviation Score D Quadratic mean of the behavior distances with respect to the baremetal analysis</p>
    <p>Deviation Threshold t  Evasive if D &gt; t</p>
    <p>VBox  Anubis</p>
    <p>Ether  Baremetal</p>
    <p>Behavior Profile</p>
    <p>Behavior Profile</p>
    <p>Behavior</p>
    <p>Profile</p>
    <p>Behavior</p>
    <p>Profile</p>
  </div>
  <div class="page">
    <p>Evaluation</p>
    <p>Ground truth  111 evasive samples (29 families)  119 non-evasive samples (49 families)</p>
    <p>Calculated behavior Deviation score D  Calculate Jaccard distance-based</p>
    <p>deviation JD  Maximum Jaccard-distance among different</p>
    <p>behavior profiles of a malware</p>
    <p>Precision-recall analysis by varying the deviation threshold t</p>
  </div>
  <div class="page">
    <p>Evaluation</p>
    <p>Recall</p>
    <p>Pr ec</p>
    <p>is io</p>
    <p>n</p>
    <p>Hierarchical similarity Jaccard similarity</p>
  </div>
  <div class="page">
    <p>Evaluation</p>
    <p>Threshold (t)</p>
    <p>Pr ec</p>
    <p>is io</p>
    <p>n</p>
    <p>Precision Recall</p>
    <p>t=0.84</p>
  </div>
  <div class="page">
    <p>Large-scale Evaluation</p>
    <p>Recent real-world malware feed observed by Anubis</p>
    <p>Randomly select samples with  low system and low network activity  high system and high network activity  high system but low network activity  Low system but high network activity</p>
    <p>110,005 samples  4 months period beginning from July 2013</p>
  </div>
  <div class="page">
    <p>Large-scale Evaluation</p>
    <p>Environment Detection Count Percentage</p>
    <p>Anubis 4947 84.78</p>
    <p>Ether 4562 78.18</p>
    <p>VirtualBox 3576 61.28</p>
    <p>All 2530 43.35</p>
  </div>
  <div class="page">
    <p>Limitations</p>
    <p>Hardware vs software iSCSI initiator</p>
    <p>Stalling code  Wait for user input  Advanced waiting</p>
    <p>Decoy reconnaissance  Real hardware ID not randomized</p>
  </div>
  <div class="page">
    <p>Conclusions</p>
    <p>Evasive Malware is a real threat to the new wave of dynamic analysis based</p>
    <p>malware detection systems</p>
    <p>We presented a system that can detect these evasive malware</p>
    <p>automatically</p>
  </div>
  <div class="page">
    <p>Thank You!</p>
  </div>
  <div class="page">
    <p>Questions</p>
  </div>
</Presentation>
