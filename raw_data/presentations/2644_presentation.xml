<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>Enabling ECN in Multi-Service Multi-Queue Data Centers</p>
    <p>Wei Bai, Li Chen, Kai Chen, Haitao Wu (Microsoft)</p>
    <p>SING Group @ Hong Kong University of Science and Technology</p>
  </div>
  <div class="page">
    <p>Background</p>
    <p>Data Centers</p>
    <p>Many services with diverse network requirements</p>
  </div>
  <div class="page">
    <p>Background</p>
    <p>Data Centers</p>
    <p>Many services with diverse network requirements</p>
    <p>ECN-based Transports</p>
    <p>ECN = Explicit Congestion Notification</p>
  </div>
  <div class="page">
    <p>Background</p>
    <p>Data Centers</p>
    <p>Many services with diverse network requirements</p>
    <p>ECN-based Transports</p>
    <p>Achieve high throughput &amp; low latency</p>
    <p>Widely deployed: DCTCP, DCQCN, etc.</p>
  </div>
  <div class="page">
    <p>ECN-based Transports</p>
  </div>
  <div class="page">
    <p>ECN-based Transports</p>
    <p>ECN-enabled end-hosts</p>
    <p>React to ECN by adjusting sending rates</p>
  </div>
  <div class="page">
    <p>ECN-based Transports</p>
    <p>ECN-enabled end-hosts</p>
    <p>React to ECN by adjusting sending rates</p>
    <p>ECN-aware switches</p>
    <p>Perform ECN marking based on Active Queue Management (AQM) policies</p>
  </div>
  <div class="page">
    <p>ECN-based Transports</p>
    <p>ECN-enabled end-hosts</p>
    <p>React to ECN by adjusting sending rates</p>
    <p>ECN-aware switches</p>
    <p>Perform ECN marking based on Active Queue Management (AQM) policies</p>
    <p>Our focus</p>
  </div>
  <div class="page">
    <p>ECN-aware Switches</p>
    <p>Adopt RED to perform ECN marking</p>
    <p>RED = Random Early Detection</p>
  </div>
  <div class="page">
    <p>ECN-aware Switches</p>
    <p>Adopt RED to perform ECN marking</p>
    <p>Per-queue/port/service-pool ECN/RED</p>
    <p>Track buffer occupancy of different egress entities</p>
  </div>
  <div class="page">
    <p>ECN-aware Switches</p>
    <p>Adopt RED to perform ECN marking</p>
    <p>Per-queue/port/service-pool ECN/RED</p>
    <p>port queue 1</p>
    <p>queue 2</p>
  </div>
  <div class="page">
    <p>ECN-aware Switches</p>
    <p>Adopt RED to perform ECN marking</p>
    <p>Per-queue/port/service-pool ECN/RED</p>
    <p>port queue 1</p>
    <p>queue 2</p>
  </div>
  <div class="page">
    <p>ECN-aware Switches</p>
    <p>Adopt RED to perform ECN marking</p>
    <p>Per-queue/port/service-pool ECN/RED</p>
    <p>port queue 1</p>
    <p>queue 2</p>
    <p>port queue 3</p>
    <p>queue 4</p>
    <p>shared buffer</p>
  </div>
  <div class="page">
    <p>ECN-aware Switches</p>
    <p>Adopt RED to perform ECN marking</p>
    <p>Per-queue/port/service-pool ECN/RED</p>
    <p>Leverage multiple queues to classify traffic</p>
    <p>Isolate traffic from different services/applications</p>
  </div>
  <div class="page">
    <p>ECN-aware Switches</p>
    <p>Adopt RED to perform ECN marking</p>
    <p>Per-queue/port/service-pool ECN/RED</p>
    <p>Leverage multiple queues to classify traffic</p>
    <p>Isolate traffic from different services/applications</p>
    <p>Services running DCTCP</p>
    <p>Services running TCP</p>
    <p>Services running UDP</p>
  </div>
  <div class="page">
    <p>ECN-aware Switches</p>
    <p>Adopt RED to perform ECN marking</p>
    <p>Per-queue/port/service-pool ECN/RED</p>
    <p>Leverage multiple queues to classify traffic</p>
    <p>Isolate traffic from different services/applications</p>
    <p>Real-time services</p>
    <p>Best-effort services</p>
    <p>Background services</p>
  </div>
  <div class="page">
    <p>ECN-aware Switches</p>
    <p>Adopt RED to perform ECN marking</p>
    <p>Per-queue/port/service-pool ECN/RED</p>
    <p>Leverage multiple queues to classify traffic</p>
    <p>Isolate traffic from different services/applications</p>
    <p>Weighted max-min fair sharing among queues</p>
    <p>Real-time services</p>
    <p>Best-effort services</p>
    <p>Background services</p>
    <p>Weight = 4</p>
    <p>Weight = 2</p>
    <p>Weight = 1</p>
  </div>
  <div class="page">
    <p>ECN-aware Switches</p>
    <p>Adopt RED to perform ECN marking</p>
    <p>Per-queue/port/service-pool ECN/RED</p>
    <p>Leverage multiple queues to classify traffic</p>
    <p>Isolate traffic from different services/applications</p>
    <p>Weighted max-min fair sharing among queues</p>
    <p>Perform ECN marking in multi-queue context</p>
  </div>
  <div class="page">
    <p>ECN marking with Single Queue</p>
  </div>
  <div class="page">
    <p>ECN marking with Single Queue</p>
    <p>RED Algorithm</p>
  </div>
  <div class="page">
    <p>ECN marking with Single Queue</p>
    <p>RED Algorithm Practical Configuration</p>
    <p>(e.g., DCTCP)</p>
  </div>
  <div class="page">
    <p>ECN marking with Single Queue</p>
    <p>To achieve 100% throughput</p>
  </div>
  <div class="page">
    <p>ECN marking with Single Queue</p>
    <p>To achieve 100% throughput</p>
    <p>Determined by congestion control algorithms</p>
  </div>
  <div class="page">
    <p>ECN marking with Single Queue</p>
    <p>To achieve 100% throughput</p>
    <p>Standard ECN marking threshold</p>
  </div>
  <div class="page">
    <p>ECN marking with Single Queue</p>
    <p>To achieve 100% throughput</p>
    <p>The standard threshold is relatively stable in DCN,</p>
    <p>e.g., 65 packets for 10G network (DCTCP paper)</p>
  </div>
  <div class="page">
    <p>ECN marking with Multi-Queue (1)</p>
  </div>
  <div class="page">
    <p>ECN marking with Multi-Queue (1)</p>
    <p>Per-queue with the standard threshold</p>
    <p>() =</p>
    <p>standard threshold</p>
    <p>port</p>
    <p>queue 1</p>
    <p>queue 2</p>
    <p>queue 3</p>
    <p>Dont mark Mark</p>
  </div>
  <div class="page">
    <p>ECN marking with Multi-Queue (1)</p>
    <p>Per-queue with the standard threshold</p>
    <p>() =</p>
    <p>Increase packet latency</p>
    <p>standard threshold</p>
    <p>port</p>
    <p>queue 1</p>
    <p>queue 2</p>
    <p>queue 3</p>
    <p>Dont mark Mark</p>
  </div>
  <div class="page">
    <p>ECN marking with Multi-Queue (1)</p>
    <p>Per-queue with the standard threshold</p>
    <p>() =</p>
    <p>Increase packet latency</p>
    <p>Evenly classify 8 long-lived flows into a varying number of queues</p>
  </div>
  <div class="page">
    <p>ECN marking with Multi-Queue (2)</p>
    <p>Per-queue with the minimum threshold</p>
    <p>() =</p>
    <p>Normalized weight</p>
    <p>minimum threshold</p>
    <p>port</p>
    <p>queue 1</p>
    <p>queue 2</p>
    <p>queue 3</p>
    <p>Dont mark Mark</p>
  </div>
  <div class="page">
    <p>ECN marking with Multi-Queue (2)</p>
    <p>Per-queue with the minimum threshold</p>
    <p>() =</p>
    <p>Degrade throughput</p>
    <p>minimum threshold</p>
    <p>port</p>
    <p>queue 1</p>
    <p>queue 2</p>
    <p>queue 3</p>
    <p>Dont mark Mark</p>
  </div>
  <div class="page">
    <p>ECN marking with Multi-Queue (2)</p>
    <p>Per-queue with the minimum threshold</p>
    <p>() =</p>
    <p>Degrade throughput</p>
    <p>Overall Average FCT Average FCT (&gt;10MB) 32</p>
  </div>
  <div class="page">
    <p>ECN marking with Multi-Queue (3)</p>
    <p>Per-port</p>
    <p>=</p>
    <p>standard threshold</p>
    <p>port</p>
    <p>queue 1</p>
    <p>queue 2</p>
    <p>queue 3</p>
    <p>Dont mark Mark</p>
  </div>
  <div class="page">
    <p>ECN marking with Multi-Queue (3)</p>
    <p>Per-port</p>
    <p>=</p>
    <p>Violate weighted fair sharing</p>
    <p>standard threshold</p>
    <p>port</p>
    <p>queue 1</p>
    <p>queue 2</p>
    <p>queue 3</p>
    <p>Dont mark Mark</p>
  </div>
  <div class="page">
    <p>ECN marking with Multi-Queue (3)</p>
    <p>Per-port</p>
    <p>=</p>
    <p>Violate weighted fair sharing</p>
    <p>Both services have a equal-weight dedicated queue on the switch 35</p>
  </div>
  <div class="page">
    <p>Question</p>
    <p>Can we design an ECN marking scheme with following properties:</p>
    <p>Deliver low latency</p>
    <p>Achieve high throughput</p>
    <p>Preserve weighted fair sharing</p>
    <p>Compatible with legacy ECN/RED implementation</p>
  </div>
  <div class="page">
    <p>Question</p>
    <p>Can we design an ECN marking scheme with following properties:</p>
    <p>Deliver low latency</p>
    <p>Achieve high throughput</p>
    <p>Preserve weighted fair sharing</p>
    <p>Compatible with legacy ECN/RED implementation</p>
    <p>Our answer: MQ-ECN</p>
  </div>
  <div class="page">
    <p>MQ-ECNS DESIGN</p>
  </div>
  <div class="page">
    <p>Start from GPS Model</p>
    <p>queues share the link with capacity</p>
    <p>N</p>
    <p>Generalized Processor Sharing (GPS)</p>
  </div>
  <div class="page">
    <p>queues share the link with capacity</p>
    <p>N</p>
    <p>Input Rate</p>
    <p>1</p>
    <p>. . .</p>
    <p>2</p>
    <p>Start from GPS Model</p>
  </div>
  <div class="page">
    <p>Start from GPS Model</p>
    <p>queues share the link with capacity</p>
    <p>Weight</p>
    <p>N</p>
    <p>2</p>
    <p>Input Rate</p>
    <p>1</p>
    <p>. . . . . .</p>
    <p>2</p>
  </div>
  <div class="page">
    <p>Start from GPS Model</p>
    <p>queues share the link with capacity</p>
    <p>= min(  =1 ,)</p>
    <p>Weight</p>
    <p>N</p>
    <p>2</p>
    <p>Input Rate</p>
    <p>1</p>
    <p>. . . . . .</p>
    <p>Output Rate</p>
    <p>min(1,1)</p>
    <p>min(2,2)</p>
    <p>min(,)</p>
    <p>. . .</p>
    <p>Weighted Fair Share Rate</p>
    <p>2</p>
  </div>
  <div class="page">
    <p>Start from GPS Model</p>
    <p>queues share the link with capacity</p>
    <p>= min(  =1 ,)</p>
    <p>Use ECN to throttle queue i if  &gt;</p>
    <p>Weight</p>
    <p>N</p>
    <p>2</p>
    <p>Input Rate</p>
    <p>1</p>
    <p>. . . . . .</p>
    <p>Output Rate</p>
    <p>min(1,1)</p>
    <p>min(2,2)</p>
    <p>min(,)</p>
    <p>. . .</p>
    <p>2</p>
  </div>
  <div class="page">
    <p>Start from GPS Model</p>
    <p>queues share the link with capacity</p>
    <p>= min(  =1 ,)</p>
    <p>() =</p>
    <p>Weight</p>
    <p>N</p>
    <p>2</p>
    <p>Input Rate</p>
    <p>1</p>
    <p>. . . . . .</p>
    <p>Output Rate</p>
    <p>min(1,1)</p>
    <p>min(2,2)</p>
    <p>min(,)</p>
    <p>. . .</p>
    <p>2</p>
  </div>
  <div class="page">
    <p>Start from GPS Model</p>
    <p>queues share the link with capacity</p>
    <p>= min(  =1 ,)</p>
    <p>() =</p>
    <p>Weight</p>
    <p>N</p>
    <p>2</p>
    <p>Input Rate</p>
    <p>1</p>
    <p>. . . . . .</p>
    <p>Output Rate</p>
    <p>min(1,1)</p>
    <p>min(2,2)</p>
    <p>min(,)</p>
    <p>. . .</p>
    <p>2</p>
    <p>bit-by-bit round robin</p>
  </div>
  <div class="page">
    <p>Start from GPS Model</p>
    <p>queues share the link with capacity</p>
    <p>= min(  =1 ,)</p>
    <p>() =</p>
    <p>Quantum</p>
    <p>N</p>
    <p>2bits</p>
    <p>bits</p>
    <p>Input Rate</p>
    <p>1</p>
    <p>. . . . . .</p>
    <p>Output Rate</p>
    <p>min(1,1)</p>
    <p>min(2,2)</p>
    <p>min(,)</p>
    <p>. . .</p>
    <p>bit-by-bit round robin</p>
    <p>2</p>
  </div>
  <div class="page">
    <p>Start from GPS Model</p>
    <p>queues share the link with capacity</p>
    <p>= min(  =1 ,)</p>
    <p>() =</p>
    <p>Quantum</p>
    <p>N</p>
    <p>Input Rate</p>
    <p>1</p>
    <p>. . . . . .</p>
    <p>Output Rate</p>
    <p>min(1,1)</p>
    <p>min(2,2)</p>
    <p>min(,)</p>
    <p>. . .</p>
    <p>Time of a round:</p>
    <p>2</p>
    <p>2</p>
  </div>
  <div class="page">
    <p>Start from GPS Model</p>
    <p>queues share the link with capacity</p>
    <p>= min(  =1 ,)</p>
    <p>() =</p>
    <p>N</p>
    <p>Input Rate</p>
    <p>1</p>
    <p>. . .</p>
    <p>Output Rate</p>
    <p>min(1,1)</p>
    <p>min(2,2)</p>
    <p>min(,)</p>
    <p>. . .</p>
    <p>Time of a round:</p>
    <p>2</p>
    <p>Quantum</p>
    <p>1</p>
    <p>2</p>
    <p>. . .</p>
  </div>
  <div class="page">
    <p>MQ-ECN</p>
    <p>queues share the link with capacity</p>
    <p>= min(  =1 ,)</p>
    <p>() =</p>
  </div>
  <div class="page">
    <p>MQ-ECN</p>
    <p>() =</p>
    <p>Why does it work?</p>
  </div>
  <div class="page">
    <p>MQ-ECN</p>
    <p>() =</p>
    <p>Deliver low latency</p>
    <p>Achieve high throughput</p>
    <p>() adapts to traffic dynamics</p>
  </div>
  <div class="page">
    <p>MQ-ECN</p>
    <p>() =</p>
    <p>Deliver low latency</p>
    <p>Achieve high throughput</p>
    <p>Preserve weighted fair sharing</p>
    <p>()is in proportion to the weight</p>
  </div>
  <div class="page">
    <p>MQ-ECN</p>
    <p>() =</p>
    <p>Deliver low latency</p>
    <p>Achieve high throughput</p>
    <p>Preserve weighted fair sharing</p>
    <p>Compatible with legacy ECN/RED implementation</p>
    <p>Per-queue ECN/RED with dynamic thresholds</p>
  </div>
  <div class="page">
    <p>MQ-ECN</p>
    <p>() =</p>
    <p>Deliver low latency</p>
    <p>Achieve high throughput</p>
    <p>Preserve weighted fair sharing</p>
    <p>Compatible with legacy ECN/RED implementation</p>
    <p>More details</p>
    <p>Handle inaccurate estimation of</p>
    <p>Apply to round-robin packet schedulers</p>
    <p>DWRR, WRR, etc.</p>
  </div>
  <div class="page">
    <p>Testbed Evaluation</p>
    <p>MQ-ECN software prototype</p>
    <p>Linux qdisc kernel module performing DWRR</p>
    <p>Testbed setup</p>
    <p>9 servers are connected to a server-emulated switch with 9 NICs</p>
    <p>End-hosts use DCTCP as the transport protocol</p>
    <p>Benchmark traffic</p>
    <p>Web search (DCTCP paper)</p>
    <p>More results in large-scale simulations 55</p>
  </div>
  <div class="page">
    <p>Static Flow Experiment</p>
    <p>Service 1</p>
    <p>Service 2</p>
    <p>weight</p>
  </div>
  <div class="page">
    <p>Static Flow Experiment</p>
  </div>
  <div class="page">
    <p>Static Flow Experiment</p>
    <p>MQ-ECN preserves weighted fair sharing</p>
  </div>
  <div class="page">
    <p>Realistic Traffic: Small Flows (&lt;100KB)</p>
    <p>Balanced traffic pattern Unbalanced traffic pattern</p>
  </div>
  <div class="page">
    <p>Realistic Traffic: Small Flows (&lt;100KB)</p>
    <p>MQ-ECN achieves low latency</p>
    <p>Balanced traffic pattern Unbalanced traffic pattern</p>
  </div>
  <div class="page">
    <p>Realistic Traffic: Large Flows (&gt;10MB)</p>
    <p>Balanced traffic pattern Unbalanced traffic pattern</p>
  </div>
  <div class="page">
    <p>Realistic Traffic: Large Flows (&gt;10MB)</p>
    <p>MQ-ECN achieves high throughput</p>
    <p>Balanced traffic pattern Unbalanced traffic pattern</p>
  </div>
  <div class="page">
    <p>Conclusions</p>
    <p>Identify performance impairments of existing ECN/RED schemes in multi-queue context</p>
    <p>MQ-ECN: simple, yet effective</p>
    <p>High throughput, low latency, weighted fair sharing  Currently, apply to round-robin packet schedulers</p>
    <p>ECN marking scheme for arbitrary schedulers is an important ongoing effort</p>
    <p>Code: http://sing.cse.ust.hk/projects/MQ-ECN</p>
  </div>
  <div class="page">
    <p>Thanks!</p>
  </div>
  <div class="page">
    <p>Support Arbitrary Packet Schedulers</p>
    <p>Find a general solution to estimate per-queue effective draining rate</p>
    <p>Draining rate should be measured when the queue keeps congested</p>
    <p>() =</p>
    <p>Measurement window is hard to decide</p>
  </div>
</Presentation>
