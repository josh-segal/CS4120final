<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>CHEETAH: A High-Speed Load-Balancer Design with Guaranteed Per-Connection-Consistency</p>
    <p>Tom Barbette, Chen Tang, Haoran Yao, Gerald Q. Maguire Jr, Dejan Kostic,</p>
    <p>Panagiotis Papadimitratos &amp; Marco Chiesa</p>
    <p>LB</p>
  </div>
  <div class="page">
    <p>Datacenter</p>
    <p>Load-balancer</p>
    <p>LB</p>
  </div>
  <div class="page">
    <p>Load-balancer</p>
    <p>LB</p>
    <p>Per-Connection</p>
    <p>Consistency</p>
    <p>(PCC)</p>
  </div>
  <div class="page">
    <p>Load-balancer</p>
    <p>LB</p>
    <p>Per-Connection</p>
    <p>Consistency</p>
    <p>(PCC)</p>
    <p>!!!</p>
  </div>
  <div class="page">
    <p>Load-balancer</p>
    <p>LB</p>
    <p>Per-Connection</p>
    <p>Consistency</p>
    <p>(PCC)</p>
    <p>!!!</p>
  </div>
  <div class="page">
    <p>Load-balancer</p>
    <p>Per-Connection</p>
    <p>Consistency</p>
    <p>(PCC)</p>
    <p>Uniform Load</p>
    <p>Balancing</p>
    <p>LB</p>
  </div>
  <div class="page">
    <p>Load-balancer</p>
    <p>Per-Connection</p>
    <p>Consistency</p>
    <p>(PCC)</p>
    <p>Uniform Load</p>
    <p>Balancing</p>
    <p>LBEfficient</p>
  </div>
  <div class="page">
    <p>Load-balancer</p>
    <p>Per-Connection</p>
    <p>Consistency</p>
    <p>(PCC)</p>
    <p>Uniform Load</p>
    <p>Balancing</p>
    <p>Dynamicity</p>
    <p>LBEfficient</p>
  </div>
  <div class="page">
    <p>The challenge: Ensuring PCC</p>
    <p>For each packet of an existing connection, the LB asks itself</p>
    <p>Per-Connection-Consistency</p>
    <p>Which server is handling this connection?</p>
  </div>
  <div class="page">
    <p>Todays solutions cannot ensure all requirements at the same time</p>
    <p>PCC Dynamic</p>
    <p>Uniform Efficient</p>
  </div>
  <div class="page">
    <p>Stateless solutions</p>
    <p>PCC</p>
    <p>Dynamic</p>
    <p>Uniform</p>
    <p>Efficient</p>
    <p>ECMP, WCMP [EuroSys14]</p>
  </div>
  <div class="page">
    <p>Stateless solutions</p>
    <p>PCC</p>
    <p>Uniform</p>
    <p>Efficient</p>
    <p>Dynamic</p>
    <p>Consistent hashing [STOC97], Beamer [NSDI18], Faild [NSDI18]</p>
  </div>
  <div class="page">
    <p>Stateful solutions</p>
    <p>PCC</p>
    <p>Uniform</p>
    <p>Efficient</p>
    <p>Silkroad [SIGCOMM17], Ananta [SIGCOMM13], Maglev [NSDI16], Katran</p>
    <p>Dynamic</p>
  </div>
  <div class="page">
    <p>CHEETAH: ask the user to remember for us</p>
    <p>PCC</p>
    <p>CHEETAH</p>
    <p>Which server is handling this connection?</p>
  </div>
  <div class="page">
    <p>CHEETAH</p>
    <p>key idea: store information about the load balancing decisions into a cookie</p>
    <p>support any realizable load-balancing logic</p>
    <p>high resilience</p>
    <p>amenable to simple and fast implementation</p>
  </div>
  <div class="page">
    <p>CHEETAH IMPLEMENTATIONS</p>
    <p>5x faster software processing time while guaranteeing PCC</p>
    <p>twice better tail latency compared to hashing thanks to more uniform load spreading</p>
    <p>P4_Tofino</p>
    <p>FastClick</p>
    <p>P4_16</p>
  </div>
  <div class="page">
    <p>CHEETAH</p>
  </div>
  <div class="page">
    <p>Servers</p>
    <p>Load-Balancer</p>
    <p>LB-logic</p>
    <p>Users</p>
    <p>CHEETAH Overview</p>
    <p>selected server 2</p>
  </div>
  <div class="page">
    <p>Servers</p>
    <p>Load-Balancer</p>
    <p>LB-logic</p>
    <p>get server idset cookie</p>
    <p>Users</p>
    <p>CHEETAH Overview</p>
    <p>selected server 2</p>
  </div>
  <div class="page">
    <p>Servers</p>
    <p>Load-Balancer</p>
    <p>LB-logic</p>
    <p>get server idset cookie</p>
    <p>extract server id</p>
    <p>Users 2</p>
    <p>CHEETAH Overview</p>
    <p>selected server 2</p>
    <p>Where to store the cookie?</p>
    <p>TCP timestamp</p>
    <p>QUIC connection ID</p>
    <p>IPv6 address</p>
  </div>
  <div class="page">
    <p>Servers</p>
    <p>Load-Balancer</p>
    <p>LB-logic</p>
    <p>get server idset cookie</p>
    <p>extract server id</p>
    <p>Users</p>
    <p>CHEETAH Overview</p>
    <p>selected server 2</p>
    <p>was server 2</p>
    <p>Allows attackers to target a server</p>
  </div>
  <div class="page">
    <p>Servers</p>
    <p>Load-Balancer</p>
    <p>set cookie</p>
    <p>cookie = id XOR hash(4-tuple)</p>
    <p>Users</p>
    <p>AE7B</p>
    <p>LB-logic</p>
    <p>get server id</p>
    <p>extract server id</p>
    <p>id = cookie XOR hash (4-tuple)</p>
    <p>Stateless CHEETAH</p>
    <p>selected server</p>
    <p>previous server</p>
    <p>AE7B</p>
  </div>
  <div class="page">
    <p>Servers</p>
    <p>Load-Balancer</p>
    <p>set cookie</p>
    <p>cookie = id XOR hash(4-tuple)</p>
    <p>Users</p>
    <p>LB-logic</p>
    <p>get server id</p>
    <p>extract server id</p>
    <p>id = cookie XOR hash (4-tuple)</p>
    <p>Stateless CHEETAH</p>
    <p>selected server</p>
    <p>previous server</p>
    <p>AE7B</p>
    <p>AE7B</p>
    <p>AE7B</p>
  </div>
  <div class="page">
    <p>Servers</p>
    <p>extract server id</p>
    <p>id = cookie XOR hash (4-tuple)</p>
    <p>Load-Balancer</p>
    <p>set cookie</p>
    <p>cookie = id XOR hash(4-tuple)</p>
    <p>Users</p>
    <p>LB-logic</p>
    <p>get server id</p>
    <p>Stateless CHEETAH</p>
    <p>selected server</p>
    <p>previous server</p>
  </div>
  <div class="page">
    <p>Servers</p>
    <p>Load-Balancer</p>
    <p>set cookie</p>
    <p>cookie = id XOR hash(4-tuple)</p>
    <p>Users</p>
    <p>LB-logic</p>
    <p>get server id</p>
    <p>extract server id</p>
    <p>id = cookie XOR hash (4-tuple)</p>
    <p>Stateless CHEETAH</p>
    <p>selected server</p>
    <p>previous server</p>
    <p>The server can directly set up the cookie</p>
    <p>to enable</p>
    <p>Direct Server Return (DSR)</p>
  </div>
  <div class="page">
    <p>There are two CHEETAHS</p>
    <p>Stateless CHEETAH Stateful CHEETAH</p>
    <p>NAT</p>
    <p>Statistics</p>
    <p>Rate limiter</p>
    <p>...</p>
    <p>Keep per-connection state</p>
    <p>on the LB</p>
    <p>https://www.goodfreephotos.com</p>
  </div>
  <div class="page">
    <p>hash Server ID NAT Statistics</p>
    <p>FEFE</p>
    <p>A7A7 DIP_6 9.0.1.2:3456 90 packets</p>
    <p>Stateful CHEETAH</p>
    <p>Flow index</p>
    <p>https://www.goodfreephotos.com</p>
    <p>Stateful CHEETAH</p>
    <p>O(1) lookup</p>
    <p>cookie</p>
    <p>Per-connection state table</p>
  </div>
  <div class="page">
    <p>Stack of Empty indexes</p>
    <p>...</p>
    <p>Stack of Empty indexes</p>
    <p>Stateful CHEETAH</p>
    <p>hash Server ID NAT Statistics</p>
    <p>A7A7 DIP_6 9.0.1.2:3456 90 packets</p>
    <p>O(1) insertion</p>
    <p>O(1) deletion</p>
    <p>O(1) lookup</p>
    <p>Fast in software</p>
    <p>Entirely doable from hardware dataplane</p>
    <p>Flow indexcookie</p>
    <p>Per-connection state table</p>
  </div>
  <div class="page">
    <p>EVALUATION Stateful at the price of stateless</p>
  </div>
  <div class="page">
    <p>Packet processing performance analysis</p>
  </div>
  <div class="page">
    <p>Packet processing performance analysis</p>
  </div>
  <div class="page">
    <p>We have the advantages</p>
    <p>of stateful classification at</p>
    <p>the price of stateless:</p>
    <p>PCC</p>
    <p>Dynamicity</p>
    <p>Uniformity</p>
    <p>Packet processing performance analysis</p>
  </div>
  <div class="page">
    <p>Packet processing performance analysis</p>
    <p>cuckoo hash table</p>
    <p>Requests for a 8K file to 64 servers using HTTP, 640 000 req/s</p>
  </div>
  <div class="page">
    <p>EVALUATION Reducing load imbalances</p>
    <p>with arbitrary LB mechanisms</p>
  </div>
  <div class="page">
    <p>Uniform workload:</p>
    <p>Variance across server load with hashing</p>
    <p>medium to high load</p>
    <p>In line with Maglev</p>
    <p>[NSDI16] which shows</p>
    <p>up to a ~30%</p>
    <p>overprovision</p>
  </div>
  <div class="page">
    <p>Uniform workload:</p>
    <p>Variance across server load with Round-Robin (RR)</p>
    <p>By using round-robin,</p>
    <p>CHEETAH can bring down the variance to</p>
    <p>reach a near-uniform</p>
    <p>load balancing</p>
  </div>
  <div class="page">
    <p>Uniform workload:</p>
    <p>Tail latency</p>
    <p>Requests for a 8K file using HTTP to 64 servers, at 100 to 200 req/s per servers</p>
    <p>CHEETAH lowers the tail latency by 2 to 3x</p>
  </div>
  <div class="page">
    <p>Bimodal workload:</p>
    <p>Round-Robin (RR) does not help</p>
  </div>
  <div class="page">
    <p>Bimodal workload:</p>
    <p>Least loaded</p>
  </div>
  <div class="page">
    <p>Bimodal workload:</p>
    <p>Average Weighted Round-Robin and Power-of-2-choice</p>
    <p>a factor of ~2X</p>
    <p>CHEETAH allows to use your preferred</p>
    <p>advanced server</p>
    <p>selection techniques</p>
  </div>
  <div class="page">
    <p>In the paper</p>
    <p>468 servers, motivation, # broken connections when ensuring uniformity with hashing</p>
    <p>Large-scale simulations</p>
    <p>PCC w/ dynamicity, comparison with Beamer [NSDI18]</p>
    <p>More experiments</p>
    <p>Other possible cookie encodings</p>
    <p>Details about the cookie encoding and limitations</p>
    <p>Stateful load balancers still break connections at scale!</p>
    <p>Multi-tier load-balancing considerations</p>
    <p>LB</p>
    <p>LBLB LB</p>
    <p>!!!</p>
  </div>
  <div class="page">
    <p>Exploited a network cookie to:</p>
    <p>&gt; Guarantee PCC and support any implementable LB mechanism</p>
    <p>&gt; Present a fast design to allow O(1) flow</p>
    <p>insertion and lookup from the dataplane</p>
    <p>Cookie as a standard?</p>
    <p>Implemented on both software switches and programmable Tofino ASIC</p>
    <p>Thank you!</p>
    <p>CHEETAH: stateful at the price of stateless</p>
    <p>Tom Barbette</p>
    <p>includes</p>
    <p>dataset and</p>
    <p>experiments</p>
    <p>github.com/cheetahlb</p>
  </div>
  <div class="page">
    <p>Backup slides</p>
  </div>
  <div class="page">
    <p>TESTBED</p>
  </div>
  <div class="page">
    <p>Uniform workload experiment</p>
    <p>LB</p>
    <p>Machine 1</p>
    <p>Machine 2</p>
    <p>Machine 3</p>
    <p>Machine 4</p>
    <p>Machine 5</p>
    <p>CPU 1</p>
    <p>CPU 2 CPU 3 CPU 4 CPU 5 CPU 6</p>
    <p>CPU 7 CPU 8 CPU 9 CPU 10 CPU 11</p>
    <p>CPU 12 CPU 13 CPU1 4 CPU 15 CPU 16</p>
    <p>Machine 6</p>
    <p>Machine 7</p>
    <p>Machine 8</p>
    <p>SRIOV</p>
  </div>
  <div class="page">
    <p>FULL STATEFUL DESIGN</p>
  </div>
  <div class="page">
    <p>CHEETAH stateful load balancerclient-side server-side</p>
    <p>ConnTable[0]</p>
    <p>id hash DIP</p>
    <p>ConnStack[0]</p>
    <p>cookie</p>
    <p>ConnTable[m-1] ConnStack[m-1]</p>
    <p>cookie</p>
    <p>h a</p>
    <p>sh S (c</p>
    <p>) %</p>
    <p>m</p>
    <p>id hash DIP</p>
    <p>......</p>
    <p>IP src, VIP</p>
    <p>TCP src, dst</p>
    <p>payload</p>
  </div>
  <div class="page">
    <p>CHEETAH stateful load balancer</p>
    <p>ConnTable[0]</p>
    <p>id hash DIP</p>
    <p>ConnStack[0]</p>
    <p>cookie</p>
    <p>DIP_3</p>
    <p>hashS(c)</p>
    <p>ConnTable[m-1] ConnStack[m-1]</p>
    <p>cookie</p>
    <p>id hash DIP</p>
    <p>......</p>
    <p>LB-logic IP src, VIP</p>
    <p>TCP src, dst</p>
    <p>payload</p>
    <p>h a</p>
    <p>sh S (c</p>
    <p>) %</p>
    <p>m</p>
    <p>client-side server-side</p>
  </div>
  <div class="page">
    <p>CHEETAH stateful load balancer</p>
    <p>ConnTable[0]</p>
    <p>id hash DIP</p>
    <p>ConnStack[0]</p>
    <p>cookie</p>
    <p>DIP_3</p>
    <p>hashS(c)</p>
    <p>ConnTable[m-1] ConnStack[m-1]</p>
    <p>cookie</p>
    <p>id hash DIP</p>
    <p>......</p>
    <p>LB-logic IP src, VIP</p>
    <p>TCP src, dst</p>
    <p>payload IP src, DIP_3</p>
    <p>TCP src, dst</p>
    <p>cookie q</p>
    <p>payload</p>
    <p>h a</p>
    <p>sh S (c</p>
    <p>) %</p>
    <p>m</p>
    <p>client-side server-side</p>
  </div>
  <div class="page">
    <p>TS PARSING</p>
  </div>
  <div class="page">
    <p>Implementation: storing the cookie</p>
    <p>Where to store the cookie?</p>
    <p>TCP timestamp, QUIC connection-id, IPv6 addresses</p>
    <p>quickly extracting the TCP timestamp is key to high performance</p>
    <p>Based on a 1hour KTH packet trace</p>
  </div>
</Presentation>
