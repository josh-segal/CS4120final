<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>Read It Twice! A mass-storage-based TOCTTOU attack</p>
    <p>Collin Mulliner and Benjamin Michele</p>
    <p>Security in Telecommunications Technische Universitat Berlin and Telekom Innovation Laboratories</p>
    <p>Germany {collin,ben}@sec.t-labs.tu-berlin.de</p>
    <p>August 7, 2012</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 1 / 27</p>
  </div>
  <div class="page">
    <p>What is this talk about?</p>
    <p>Compromising CE devices via emulated USB mass-storage</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 2 / 27</p>
  </div>
  <div class="page">
    <p>What is this talk about?</p>
    <p>Compromising CE devices via emulated USB mass-storage</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 2 / 27</p>
  </div>
  <div class="page">
    <p>Our contribution</p>
    <p>Mass-storage-based time-of-check-to-time-of-use (TOCTTOU) attack: Read It Twice (RIT)</p>
    <p>Mass-storage device that changes its content between check and execute/install phase of a connected host Circumvention of block and file system caches</p>
    <p>Black box analysis of file accesses to mass-storage devices</p>
    <p>Method and tool Maps block accesses to file accesses at run time</p>
    <p>POC against a Samsung TV, using our RIT analysis and attack tool</p>
    <p>Used in this talk to demonstrate the general attack and tool</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 3 / 27</p>
  </div>
  <div class="page">
    <p>Our contribution</p>
    <p>Mass-storage-based time-of-check-to-time-of-use (TOCTTOU) attack: Read It Twice (RIT)</p>
    <p>Mass-storage device that changes its content between check and execute/install phase of a connected host Circumvention of block and file system caches</p>
    <p>Black box analysis of file accesses to mass-storage devices</p>
    <p>Method and tool Maps block accesses to file accesses at run time</p>
    <p>POC against a Samsung TV, using our RIT analysis and attack tool</p>
    <p>Used in this talk to demonstrate the general attack and tool</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 3 / 27</p>
  </div>
  <div class="page">
    <p>Our contribution</p>
    <p>Mass-storage-based time-of-check-to-time-of-use (TOCTTOU) attack: Read It Twice (RIT)</p>
    <p>Mass-storage device that changes its content between check and execute/install phase of a connected host Circumvention of block and file system caches</p>
    <p>Black box analysis of file accesses to mass-storage devices</p>
    <p>Method and tool Maps block accesses to file accesses at run time</p>
    <p>POC against a Samsung TV, using our RIT analysis and attack tool</p>
    <p>Used in this talk to demonstrate the general attack and tool</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 3 / 27</p>
  </div>
  <div class="page">
    <p>Software installation: Program flow</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 4 / 27</p>
  </div>
  <div class="page">
    <p>Software installation: Program flow and attack</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 4 / 27</p>
  </div>
  <div class="page">
    <p>POC: Shell on Samsung TV</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 5 / 27</p>
  </div>
  <div class="page">
    <p>Modern TV features</p>
    <p>USB interface for mass-storage</p>
    <p>Watch movies Install apps Upgrade firmware</p>
    <p>CI+ card slot for pay TV</p>
    <p>Network and Internet connection</p>
    <p>Integrated camera and microphone</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 6 / 27</p>
  </div>
  <div class="page">
    <p>Modern TV features</p>
    <p>USB interface for mass-storage</p>
    <p>Watch movies Install apps Upgrade firmware</p>
    <p>CI+ card slot for pay TV</p>
    <p>Network and Internet connection</p>
    <p>Integrated camera and microphone</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 6 / 27</p>
  </div>
  <div class="page">
    <p>Conflict of interest</p>
    <p>User</p>
    <p>Enable missing features</p>
    <p>Fix bugs</p>
    <p>Customize product</p>
    <p>Record pay TV</p>
    <p>Vendor</p>
    <p>Protect intellectual property</p>
    <p>Avoid warranty issues</p>
    <p>Adhere to the specifications</p>
    <p>Protect multimedia content</p>
    <p>Locked-down devices</p>
    <p>User access disabled by vendor . . .</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 7 / 27</p>
  </div>
  <div class="page">
    <p>Conflict of interest</p>
    <p>User</p>
    <p>Enable missing features</p>
    <p>Fix bugs</p>
    <p>Customize product</p>
    <p>Record pay TV</p>
    <p>Vendor</p>
    <p>Protect intellectual property</p>
    <p>Avoid warranty issues</p>
    <p>Adhere to the specifications</p>
    <p>Protect multimedia content</p>
    <p>Locked-down devices</p>
    <p>User access disabled by vendor . . .</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 7 / 27</p>
  </div>
  <div class="page">
    <p>Conflict of interest</p>
    <p>User</p>
    <p>Enable missing features</p>
    <p>Fix bugs</p>
    <p>Customize product</p>
    <p>Record pay TV</p>
    <p>Vendor</p>
    <p>Protect intellectual property</p>
    <p>Avoid warranty issues</p>
    <p>Adhere to the specifications</p>
    <p>Protect multimedia content</p>
    <p>Locked-down devices</p>
    <p>User access disabled by vendor . . .</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 7 / 27</p>
  </div>
  <div class="page">
    <p>Samsung LExxB650: Content library / app launcher</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 8 / 27</p>
  </div>
  <div class="page">
    <p>Samsung LExxB650: Two types of apps</p>
    <p>clmeta.dat</p>
    <p>XML file</p>
    <p>Contains app category</p>
    <p>Evaluated at install time</p>
    <p>Evaluated at load time</p>
    <p>Unprivileged apps</p>
    <p>Category Wellness, . . .</p>
    <p>Macromedia Flash-based</p>
    <p>No signature required</p>
    <p>Privileged apps</p>
    <p>Category Game</p>
    <p>Shared objects</p>
    <p>Native code</p>
    <p>Run as root</p>
    <p>Require valid signature for installation, but not at run time</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 9 / 27</p>
  </div>
  <div class="page">
    <p>Samsung LExxB650: Two types of apps</p>
    <p>clmeta.dat</p>
    <p>XML file</p>
    <p>Contains app category</p>
    <p>Evaluated at install time</p>
    <p>Evaluated at load time</p>
    <p>Unprivileged apps</p>
    <p>Category Wellness, . . .</p>
    <p>Macromedia Flash-based</p>
    <p>No signature required</p>
    <p>Privileged apps</p>
    <p>Category Game</p>
    <p>Shared objects</p>
    <p>Native code</p>
    <p>Run as root</p>
    <p>Require valid signature for installation, but not at run time</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 9 / 27</p>
  </div>
  <div class="page">
    <p>Samsung LExxB650: Two types of apps</p>
    <p>clmeta.dat</p>
    <p>XML file</p>
    <p>Contains app category</p>
    <p>Evaluated at install time</p>
    <p>Evaluated at load time</p>
    <p>Unprivileged apps</p>
    <p>Category Wellness, . . .</p>
    <p>Macromedia Flash-based</p>
    <p>No signature required</p>
    <p>Privileged apps</p>
    <p>Category Game</p>
    <p>Shared objects</p>
    <p>Native code</p>
    <p>Run as root</p>
    <p>Require valid signature for installation, but not at run time</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 9 / 27</p>
  </div>
  <div class="page">
    <p>Samsung LExxB650: Two types of apps</p>
    <p>clmeta.dat</p>
    <p>XML file</p>
    <p>Contains app category</p>
    <p>Evaluated at install time</p>
    <p>Evaluated at load time</p>
    <p>Unprivileged apps</p>
    <p>Category Wellness, . . .</p>
    <p>Macromedia Flash-based</p>
    <p>No signature required</p>
    <p>Privileged apps</p>
    <p>Category Game</p>
    <p>Shared objects</p>
    <p>Native code</p>
    <p>Run as root</p>
    <p>Require valid signature for installation, but not at run time</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 9 / 27</p>
  </div>
  <div class="page">
    <p>clmeta.dat: Unprivileged app</p>
    <p>&lt;?xml version =&quot;1.0&quot; encoding =&quot;utf -8&quot;?&gt;</p>
    <p>&lt;contentlibrary &gt;</p>
    <p>&lt;contentpack id=&quot; tocttou&quot;&gt;</p>
    <p>&lt;category &gt;Wellness &lt;/category &gt;</p>
    <p>&lt;title language_id =&quot; English&quot;&gt;tocttou &lt;/title &gt;</p>
    <p>&lt;startpoint language_id =&quot; English&quot;&gt;</p>
    <p>tocttou.so &lt;/ startpoint &gt;</p>
    <p>&lt;thumbnailpath &gt;tocttou.bmp &lt;/ thumbnailpath &gt;</p>
    <p>&lt;totalsize &gt;1&lt;/totalsize &gt;</p>
    <p>&lt;/contentpack &gt;</p>
    <p>&lt;/contentlibrary &gt;</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 10 / 27</p>
  </div>
  <div class="page">
    <p>clmeta.dat: Privileged app</p>
    <p>&lt;?xml version =&quot;1.0&quot; encoding =&quot;utf -8&quot;?&gt;</p>
    <p>&lt;contentlibrary &gt;</p>
    <p>&lt;contentpack id=&quot; tocttou&quot;&gt;</p>
    <p>&lt;category &gt;Game &lt;/category &gt;</p>
    <p>&lt;title language_id =&quot; English&quot;&gt;tocttou &lt;/title &gt;</p>
    <p>&lt;startpoint language_id =&quot; English&quot;&gt;</p>
    <p>tocttou.so &lt;/ startpoint &gt;</p>
    <p>&lt;thumbnailpath &gt;tocttou.bmp &lt;/ thumbnailpath &gt;</p>
    <p>&lt;totalsize &gt;1&lt;/totalsize &gt;</p>
    <p>&lt;/contentpack &gt;</p>
    <p>&lt;/contentlibrary &gt;</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 11 / 27</p>
  </div>
  <div class="page">
    <p>App install: Two apps on USB mass-storage</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 12 / 27</p>
  </div>
  <div class="page">
    <p>App install: TV checks all folders for apps</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 13 / 27</p>
  </div>
  <div class="page">
    <p>App install: TV offers unprivileged apps</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 14 / 27</p>
  </div>
  <div class="page">
    <p>App install: User chooses app</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 15 / 27</p>
  </div>
  <div class="page">
    <p>App install: TV copies app folder to internal flash memory</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 16 / 27</p>
  </div>
  <div class="page">
    <p>App install: TV copies app folder to internal flash memory</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 16 / 27</p>
  </div>
  <div class="page">
    <p>Requirements for TOCTTOU attack</p>
    <p>USB mass-storage device</p>
    <p>Able to change content while connected Client or OTG USB interface to connect to host</p>
    <p>Content change triggered by file accesses</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 17 / 27</p>
  </div>
  <div class="page">
    <p>Implementation</p>
    <p>Gumstix developer board running Linux</p>
    <p>USB OTG port</p>
    <p>Linux USB stack offers mass-storage emulation via Gadget API</p>
    <p>linux/drivers/usb/gadget/file storage.c  g file storage.ko Modifications</p>
    <p>Block and file system access tracking for FAT16/32 Switch file system based on file access counters</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 18 / 27</p>
  </div>
  <div class="page">
    <p>Tool output: Unprivileged app installation</p>
    <p>Directories are scanned for clmeta.dat files</p>
    <p>Apps are displayed with their icon</p>
    <p>Tocttou app folder copied to internal memory</p>
    <p>TOCTTOU attack would fail /TOCTTOU/clmeta.dat read only once from emulated storage!</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 19 / 27</p>
  </div>
  <div class="page">
    <p>Tool output: Unprivileged app installation</p>
    <p>Directories are scanned for clmeta.dat files</p>
    <p>Apps are displayed with their icon</p>
    <p>Tocttou app folder copied to internal memory</p>
    <p>TOCTTOU attack would fail /TOCTTOU/clmeta.dat read only once from emulated storage!</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 19 / 27</p>
  </div>
  <div class="page">
    <p>Block cache</p>
    <p>Problem</p>
    <p>TVs OS caches all block accesses to mass-storage in unused RAM</p>
    <p>Replace clmeta.dat in block cache</p>
    <p>Force TV to read large file between checking and copying of clmeta.dat</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 20 / 27</p>
  </div>
  <div class="page">
    <p>Block cache</p>
    <p>Problem</p>
    <p>TVs OS caches all block accesses to mass-storage in unused RAM</p>
    <p>Replace clmeta.dat in block cache</p>
    <p>Force TV to read large file between checking and copying of clmeta.dat</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 20 / 27</p>
  </div>
  <div class="page">
    <p>Candidate files</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 21 / 27</p>
  </div>
  <div class="page">
    <p>Candidate files</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 21 / 27</p>
  </div>
  <div class="page">
    <p>Output of successful attack</p>
    <p>TOCTTOU (DIR)</p>
    <p>CLMETA.DAT (471b) [/ TOCTTOU]</p>
    <p>CLMETA.DAT -&gt; read completed! [1/2]</p>
    <p>CACHE (DIR)</p>
    <p>CLMETA.DAT (272630223b) [/CACHE]</p>
    <p>CLMETA.DAT -&gt; read completed! [2/2] [file system switched !]</p>
    <p>CACHE.BMP (843758b) [/ CACHE]</p>
    <p>CACHE.BMP -&gt; read completed!</p>
    <p>TOCTTOU (DIR)</p>
    <p>TOCTTOU (DIR)</p>
    <p>TOCTTOU.BMP (490734b) [/ TOCTTOU]</p>
    <p>TOCTTOU.BMP -&gt; read completed!</p>
    <p>TOCTTOU.SO (4608b) [/ TOCTTOU]</p>
    <p>TOCTTOU.SO -&gt; read completed!</p>
    <p>CLMETA.DAT (471b) [/ TOCTTOU]</p>
    <p>CLMETA.DAT -&gt; read completed! [3/2]</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 22 / 27</p>
  </div>
  <div class="page">
    <p>TVs Wellness apps after successful attack</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 23 / 27</p>
  </div>
  <div class="page">
    <p>POC: Summary</p>
    <p>Execution of own native code on TV</p>
    <p>Present unprivileged app to TV</p>
    <p>Elevate privileges between check and install</p>
    <p>Execute app with full privileges, i.e., root user</p>
    <p>Start telnet daemon</p>
    <p>Disable firmware upgrade signature check  Modify firmware</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 24 / 27</p>
  </div>
  <div class="page">
    <p>Countermeasures</p>
    <p>Copy to internal trusted memory before check and install/execute</p>
    <p>Low-cost embedded devices Sufficient free memory available?</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 25 / 27</p>
  </div>
  <div class="page">
    <p>Future work</p>
    <p>Further CE devices</p>
    <p>App install code Firmware upgrade process</p>
    <p>Further mass-storage devices</p>
    <p>SD cards Hard disks</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 26 / 27</p>
  </div>
  <div class="page">
    <p>Questions?</p>
    <p>fgsect.de</p>
    <p>{collin,ben}@sec.t-labs.tu-berlin.de</p>
    <p>Collin Mulliner and Ben Michele (SECT) Read It Twice! August 7, 2012 27 / 27</p>
  </div>
</Presentation>
