<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>Themis: Fair and Efficient GPU Cluster Scheduling</p>
    <p>Kshiteej Mahajan1, Arjun Balasubramanian1, Arjun Singhvi1, Shivaram Venkataraman1, Aditya Akella1, Amar Phanishayee2, Shuchi Chawla1</p>
  </div>
  <div class="page">
    <p>Deep Learning at a Large Enterprise</p>
    <p>Speech, Image, Ads, NLP, Web Search</p>
  </div>
  <div class="page">
    <p>Deep Learning at a Large Enterprise</p>
    <p>Speech, Image, Ads, NLP, Web Search</p>
    <p>Innovate and Train newer DL models on GPUs</p>
  </div>
  <div class="page">
    <p>Deep Learning at a Large Enterprise</p>
    <p>Hyperparameter Optimization is typical  train same DL model (M) with different hyperparameters (H)</p>
    <p>DL App H1 (lr = 1e-3) H2 (lr = 1e-4)</p>
    <p>H3 (lr = 5e-4) H4 (lr = 2e-3)</p>
    <p>Job 1 Job 2</p>
    <p>Job 3 Job 4</p>
    <p>DL App, Model M 4</p>
  </div>
  <div class="page">
    <p>DL Apps at a Large Enterprise</p>
    <p>Hyperparameter Optimization is typical  train same DL model (M) with different hyperparameters (H)</p>
    <p>DL App H1 (lr = 1e-3) H2 (lr = 1e-4)</p>
    <p>H3 (lr = 5e-4) H4 (lr = 2e-3)</p>
    <p>Job 1 Job 2</p>
    <p>Job 3 Job 4</p>
    <p>DL App, Model M 5</p>
  </div>
  <div class="page">
    <p>Deep Learning at a Large Enterprise</p>
    <p>Independent GPU Instances</p>
  </div>
  <div class="page">
    <p>GPU Cluster Scheduler: Goal</p>
    <p>GPU Cluster Scheduler</p>
    <p>Multiplex access to shared GPU cluster for contending DL apps</p>
    <p>Shared GPU cluster</p>
  </div>
  <div class="page">
    <p>GPU Cluster Scheduler: Goal</p>
    <p>GPU Cluster Scheduler</p>
    <p>Multiplex access to shared GPU cluster for contending DL apps</p>
    <p>Shared GPU cluster</p>
    <p>Desired Goal  Incentivize sharing of GPU resources</p>
  </div>
  <div class="page">
    <p>GPU Cluster Scheduler: Goal</p>
    <p>GPU Cluster Scheduler</p>
    <p>Multiplex access to shared GPU cluster for contending DL apps</p>
    <p>Shared GPU cluster</p>
    <p>Primary Goal  Sharing Incentive (SI)</p>
    <p>If N DL apps are sharing a cluster then no DL app should run slower than on a private cluster with 1/N resources.</p>
  </div>
  <div class="page">
    <p>Overview  Existing GPU Cluster Schedulers</p>
    <p>Do not give Sharing Incentive  DL App Properties  Drawbacks  Requirements</p>
    <p>Themis  Design  Implementation  Evaluation</p>
  </div>
  <div class="page">
    <p>Existing GPU Cluster Schedulers</p>
    <p>GPU Cluster Scheduler</p>
    <p>Shared GPU cluster</p>
    <p>DRF  Tiresias (LAS)  SLAQ  Optimus  Gandiva</p>
  </div>
  <div class="page">
    <p>GPU Cluster Scheduler: Drawback 1</p>
    <p>Metric = App Resource</p>
    <p>Share</p>
    <p>Mechanism = Allocate on Task Completion to</p>
    <p>Min Metric Shared GPU cluster</p>
    <p>DRF</p>
    <p>Interface = Task Resource Demand</p>
  </div>
  <div class="page">
    <p>GPU Cluster Scheduler: Drawback 1</p>
    <p>Metric = Resource Share</p>
    <p>Mechanism = on task completion, schedule task from</p>
    <p>app with min Resource Share</p>
    <p>Shared GPU cluster DRF</p>
    <p>Interface = Task Resource Demand</p>
    <p>Assume Short Tasks for Sharing Incentive</p>
    <p>Short Tasks allow for frequent multiplexing</p>
  </div>
  <div class="page">
    <p>Interface = Task Resource Demand</p>
    <p>GPU Cluster Scheduler: Drawback 1</p>
    <p>Metric = Resource Share</p>
    <p>Mechanism = on task completion, schedule task from</p>
    <p>app with min Resource Share</p>
    <p>Shared GPU cluster</p>
    <p>Assume Short Tasks for Sharing Incentive</p>
    <p>Short Tasks allow for frequent multiplexing</p>
    <p>DRF</p>
    <p>ML median task duration  3.75 hours</p>
    <p>Lot of apps with 5X shorter and 5X longer tasks</p>
  </div>
  <div class="page">
    <p>Interface = Task Resource Demand</p>
    <p>GPU Cluster Scheduler: Drawback 1</p>
    <p>Metric = Resource Share</p>
    <p>Mechanism = on task completion, schedule task from</p>
    <p>app with min Resource Share</p>
    <p>Shared GPU cluster</p>
    <p>Assume Short Tasks for Sharing Incentive</p>
    <p>Short Tasks allow for frequent multiplexing</p>
    <p>DRF</p>
    <p>ML median task duration  3.75 hours</p>
    <p>Lot of apps with 5X shorter and 5X longer tasks</p>
    <p>Long waiting time for Short Apps</p>
    <p>No SI for Short Apps</p>
    <p>SHORT RESOURCE INTENSIVE LONG TASK</p>
    <p>long waiting time</p>
  </div>
  <div class="page">
    <p>Interface = Task Resource Demand</p>
    <p>GPU Cluster Scheduler: Requirement 1</p>
    <p>Metric = Resource Share</p>
    <p>Mechanism = on task completion, schedule task from</p>
    <p>app with min Resource Share</p>
    <p>Shared GPU cluster</p>
    <p>Assume Short Tasks for Sharing Incentive</p>
    <p>Short Tasks allow for frequent multiplexing</p>
    <p>DRF</p>
    <p>ML median task duration  3.75 hours</p>
    <p>Lot of apps with 5X shorter and 5X longer tasks</p>
    <p>No SI for Short Apps</p>
    <p>SHORT BREAK UP LONG TASK</p>
    <p>SI for ML Apps =&gt; Preemption is necessary</p>
    <p>Allocate any task for at most lease duration</p>
    <p>schedule short task on preemption of</p>
    <p>long task</p>
  </div>
  <div class="page">
    <p>GPU Cluster Scheduler: Drawback 2</p>
    <p>Metric = App Attained</p>
    <p>Service (= #GPUs * time)</p>
    <p>Mechanism = Allocate for lease duration to Min</p>
    <p>Metric Shared GPU cluster</p>
    <p>Tiresias (LAS)</p>
    <p>Interface = Task Resource Demand</p>
  </div>
  <div class="page">
    <p>GPU Cluster Scheduler: Drawback 2</p>
    <p>Metric = App Attained</p>
    <p>Service (= GPU time)</p>
    <p>Mechanism = Allocate for lease duration to Min</p>
    <p>Metric Shared GPU cluster Tiresias (LAS)</p>
    <p>Interface = Task Resource Demand</p>
    <p>DL apps have a placement preference</p>
    <p>E.g.: VGG model family prefers dense placement</p>
  </div>
  <div class="page">
    <p>GPU Cluster Scheduler: Drawback 2</p>
    <p>Metric = App Attained</p>
    <p>Service (= GPU time)</p>
    <p>Mechanism = Allocate for lease duration to Min</p>
    <p>Metric Shared GPU cluster Tiresias (LAS)</p>
    <p>Interface = Task Resource Demand</p>
    <p>DL apps have a placement preference</p>
    <p>E.g.: VGG model family prefers dense placement</p>
    <p>Server 1 Server 2 Attained Service is equal in both placements (= 4 GPUs * time)</p>
    <p>Both placements are equivalent</p>
    <p>Poor placement =&gt; slower execution time</p>
    <p>VGG app would rather prefer its own server</p>
    <p>No SI</p>
    <p>Server 1 Server 2</p>
    <p>VGG App</p>
    <p>VGG App</p>
    <p>Placement 1</p>
    <p>Placement 2</p>
  </div>
  <div class="page">
    <p>GPU Cluster Scheduler: Drawback 2</p>
    <p>Metric = App Attained</p>
    <p>Service (= GPU time)</p>
    <p>Mechanism = Allocate for lease duration to Min</p>
    <p>Metric Shared GPU cluster Tiresias (LAS)</p>
    <p>Interface = Task Resource Demand</p>
    <p>DL apps have a placement preference</p>
    <p>E.g.: VGG model family prefers dense placement</p>
    <p>Attained Service is equal in both placements (= 4 GPUs * time)</p>
    <p>Both placements are equivalent</p>
    <p>SI violation with placement 1</p>
    <p>Server 1 Server 2</p>
    <p>Server 1 Server 2</p>
    <p>VGG App</p>
    <p>VGG App</p>
    <p>Placement 1</p>
    <p>Placement 2</p>
    <p>Binary Placement Enforcement  Strict Consolidation (wait for Placement 2)</p>
    <p>Partial Progress can be made with Placement 1</p>
    <p>Long wait time without progress</p>
    <p>SI is violated 20</p>
  </div>
  <div class="page">
    <p>GPU Cluster Scheduler: Requirement 2</p>
    <p>Metric = App Attained</p>
    <p>Service (= GPU time)</p>
    <p>Mechanism = Allocate for lease duration to Min</p>
    <p>Metric Shared GPU cluster Tiresias (LAS)</p>
    <p>Interface = Task Resource Demand</p>
    <p>DL apps have a placement preference</p>
    <p>E.g.: VGG model family prefers dense placement</p>
    <p>Attained Service is equal in both placements (= 4 GPUs * time)</p>
    <p>Both placements are equivalent</p>
    <p>SI violation with placement 1</p>
    <p>Server 1 Server 2</p>
    <p>Server 1 Server 2</p>
    <p>VGG App</p>
    <p>VGG App</p>
    <p>Placement 1</p>
    <p>Placement 2</p>
    <p>Binary Placement Enforcement  Strict Consolidation (only allow Placement 2)</p>
    <p>High wait time  SI is violated  SI for ML Apps =&gt;</p>
    <p>Fine-grained Placement Preference</p>
  </div>
  <div class="page">
    <p>Overview  Existing GPU Cluster Schedulers</p>
    <p>Do not give Sharing Incentive  DL App Properties  Drawbacks  Requirements</p>
    <p>Themis  Design  Implementation  Evaluation</p>
  </div>
  <div class="page">
    <p>Towards a new GPU Cluster Scheduler</p>
    <p>Metric = ?</p>
    <p>Mechanism = ?</p>
    <p>Shared GPU clusterThemis</p>
    <p>Interface = ?</p>
  </div>
  <div class="page">
    <p>Themis: Metric</p>
    <p>Metric = ?</p>
    <p>Mechanism = ?</p>
    <p>Shared GPU clusterThemis</p>
    <p>Interface = ?</p>
  </div>
  <div class="page">
    <p>Themis: Metric</p>
    <p>GPU Cluster Scheduler</p>
    <p>Shared GPU cluster</p>
    <p>Green Apps Shared Finish</p>
    <p>Time Tsh</p>
  </div>
  <div class="page">
    <p>Themis: Metric</p>
    <p>GPU Cluster Scheduler</p>
    <p>Shared GPU cluster</p>
    <p>Independent GPU instances</p>
    <p>Green Apps Independent Finish Time</p>
    <p>Tid</p>
  </div>
  <div class="page">
    <p>Themis: Metric</p>
    <p>GPU Cluster Scheduler</p>
    <p>Shared GPU cluster</p>
    <p>Independent GPU instances</p>
    <p>Green Apps Independent Running Time</p>
    <p>Tid</p>
    <p>Green Apps Shared Running</p>
    <p>Time Tsh</p>
    <p>Primary Goal  Sharing Incentive (SI)</p>
    <p>Tsh &lt;= Tid</p>
    <p>&gt;=</p>
  </div>
  <div class="page">
    <p>Themis: Finish-Time Fairness Metric</p>
    <p>= Tsh / Tid  Tsh: finish-time of app in shared cluster  Tid: finish-time of app in exclusive 1/N share of cluster  N: Average contention during app lifetime</p>
  </div>
  <div class="page">
    <p>Themis: Finish-Time Fairness Metric</p>
    <p>= Tsh / Tid  Tsh: finish-time of app in shared cluster  Tid: finish-time of app in exclusive 1/N share of cluster  N: Average contention during app lifetime</p>
    <p>SI: for all apps,  &lt;= 1</p>
  </div>
  <div class="page">
    <p>Themis: Finish-Time Fairness Metric</p>
    <p>= Tsh / Tid  Tsh: finish-time of app in shared cluster  Tid: finish-time of app in exclusive 1/N share of cluster  N: Average contention during app lifetime</p>
    <p>SI: for all apps,  &lt;= 1  Fine-Grained Placement Preferences</p>
    <p>Excessive queueing or bad placements worsens Tsh and hence</p>
  </div>
  <div class="page">
    <p>Themis: Metric</p>
    <p>Metric = finish-time fairness</p>
    <p>()</p>
    <p>Mechanism = ?</p>
    <p>Shared GPU clusterThemis</p>
    <p>Interface = ?</p>
  </div>
  <div class="page">
    <p>Themis: Interface</p>
    <p>Metric = finish-time fairness</p>
    <p>()</p>
    <p>Mechanism = ?</p>
    <p>Shared GPU clusterThemis</p>
    <p>Interface = ?</p>
  </div>
  <div class="page">
    <p>Themis: Interface</p>
    <p>Key Purpose: Enable book-keeping of</p>
    <p>Who calculates   the app or the scheduler?</p>
  </div>
  <div class="page">
    <p>Themis: Interface</p>
    <p>DL App = Managed by an Hyperparameter Optimizer (Hyperparam-Opt) like Google Vizier</p>
  </div>
  <div class="page">
    <p>Themis: Interface</p>
    <p>DL App = Managed by an Hyperparameter Optimizer (Hyperparam-Opt) like Google Vizier</p>
    <p>Launch several DL jobs with different Hyperparameters Hi</p>
    <p>H1 H2 HN</p>
  </div>
  <div class="page">
    <p>Themis: Interface</p>
    <p>DL App = Managed by an Hyperparameter Optimizer (Hyperparam-Opt) like Google Vizier</p>
    <p>Launch several DL jobs with different Hyperparameters Hi</p>
    <p>GPU allocation, Gi, within jobs decided by Hyperparam-Opt</p>
    <p>H1 H2 HN G1 G2 GNGapp</p>
    <p>Hyperparam-Opt Allocation Logic</p>
  </div>
  <div class="page">
    <p>Themis: Interface</p>
    <p>DL App = Managed by an Hyperparameter Optimizer (Hyperparam-Opt) like Google Vizier</p>
    <p>Launch several DL jobs with different Hyperparameters Hi</p>
    <p>GPU allocation, Gi, within jobs decided by Hyperparam-Opt</p>
    <p>Track training accuracy of each job and classify jobs as poor, ok and good</p>
    <p>Estimate finish time of each job</p>
    <p>H1 H2 HN G1 G2 GNGvector</p>
    <p>Hyperparam-Opt Allocation Logic</p>
    <p>Hyperparam-Opt Termination Logic</p>
    <p>terminate at time1</p>
    <p>terminate at timeN</p>
    <p>trained model at time2</p>
    <p>poor okgood</p>
  </div>
  <div class="page">
    <p>Themis: Interface</p>
    <p>DL App = Managed by an Hyperparameter Optimizer (Hyperparam-Opt) like Google Vizier</p>
    <p>Launch several DL jobs with different Hyperparameters Hi</p>
    <p>GPU allocation, Gi, within jobs decided by Hyperparam-Opt</p>
    <p>Terminate poor model training instances until one best trained model</p>
    <p>Wleft =  Gi  Hi  ( is best calculated by</p>
    <p>the Hyperparam-Opt</p>
    <p>H1 H2 HN G1 G2 GNGvector</p>
    <p>Hyperparam-Opt Allocation Logic</p>
    <p>Hyperparam-Opt Termination Logic</p>
    <p>terminate at time1</p>
    <p>terminate at timeN</p>
    <p>trained model at time2</p>
    <p>Apps Hyperparam-Opt tracks per-job progress</p>
    <p>App does calculation of</p>
    <p>Scheduler pulls updated values of  from the Agent co-located with Apps Hyperparam-Opt</p>
    <p>Details in the paper 38</p>
  </div>
  <div class="page">
    <p>Towards a new GPU Cluster Scheduler</p>
    <p>Metric = finish-time fairness</p>
    <p>()</p>
    <p>Mechanism = ?</p>
    <p>Shared GPU clusterThemis</p>
    <p>Interface = Get  estimates via Agent</p>
  </div>
  <div class="page">
    <p>Towards a new GPU Cluster Scheduler</p>
    <p>Metric = finish-time fairness</p>
    <p>()</p>
    <p>Mechanism = ?</p>
    <p>Shared GPU clusterThemis</p>
    <p>Interface = Get  estimates via Agent</p>
  </div>
  <div class="page">
    <p>Themis: Mechanism</p>
    <p>Key Goal: Sharing Incentive</p>
    <p>SI: for all apps,  &lt;= 1</p>
    <p>Difficult to guarantee with online arrivals</p>
    <p>Our focus: min (max ): empirically keeps s  1 without admission control</p>
  </div>
  <div class="page">
    <p>Server 1 Server 2 Strawman Mechanism SI Objective  min (max )</p>
    <p>Red GPUs become available</p>
  </div>
  <div class="page">
    <p>Strawman Mechanism Server 1 Server 2</p>
    <p>SI Objective  min (max )</p>
    <p>Interface: Get  estimates from all apps Red GPUs become available</p>
  </div>
  <div class="page">
    <p>Server 1 Server 2 Strawman Mechanism</p>
    <p>SI Objective  min (max )</p>
    <p>1 2&gt; &gt; 3 &gt; N</p>
    <p>Interface: Get  estimates from all apps Red GPUs become available</p>
    <p>Sort in decreasing order of  Allocate to app with highest  (green app) for lease duration</p>
  </div>
  <div class="page">
    <p>Server 1 Server 2 Strawman Mechanism: Issues</p>
    <p>SI Objective  min (max )</p>
    <p>1 2&gt; &gt; 3 &gt; N</p>
    <p>Interface: Get  estimates from all apps Red GPUs become available</p>
    <p>Sort in decreasing order of  Allocate to app with highest  (green app) for lease duration</p>
  </div>
  <div class="page">
    <p>Server 1 Server 2 Themis: Mechanism</p>
    <p>SI Objective  min (max )</p>
    <p>1 2&gt; &gt; 3 &gt; N</p>
    <p>Interface: Get  estimates from all apps Red GPUs become available</p>
    <p>using Partial Allocation Auctions</p>
  </div>
  <div class="page">
    <p>Server 1 Server 2 Themis: Mechanism</p>
    <p>SI Objective  min (max )</p>
    <p>1 2&gt; &gt; 3 &gt; N</p>
    <p>Interface: Get  estimates from all apps Red GPUs become available</p>
    <p>(Red GPUs can potentially go to Blue App) using Auctions</p>
  </div>
  <div class="page">
    <p>Themis: Mechanism: Partial Allocation Auction</p>
    <p>1 2&gt;</p>
    <p>Resource Alloc new + 0 old</p>
    <p>+1 Red GPU +2 Red GPUs old-2</p>
    <p>old-</p>
    <p>Server 1 Server 2</p>
    <p>Red GPUs become available</p>
  </div>
  <div class="page">
    <p>Themis: Mechanism: Partial Allocation Auction</p>
    <p>1 2&gt;</p>
    <p>Resource Alloc new + 0 old</p>
    <p>+ 2 Red GPUs +1 Red GPU old-</p>
    <p>old-2</p>
    <p>Widen Interface to make resource offer and get bids</p>
    <p>Bid from each app is a valuation table</p>
    <p>Server 1 Server 2</p>
    <p>Red GPUs become available</p>
    <p>Input: Valuation Tables from filtered apps</p>
    <p>Pareto efficiency (PE)  max  1/,   (  proportional fair allocations</p>
    <p>Strategy Proofness (SP)  Allocate a fraction of this per app for lease duration  rest is hidden payment</p>
    <p>More lying =&gt; higher hidden payments =&gt; incentivizes truth-telling</p>
    <p>Leftover Allocation  Allocate hidden payments to unfiltered apps at random to avoid unallocated resources and enable work conservation</p>
  </div>
  <div class="page">
    <p>Themis: Overall Design</p>
    <p>Hyperparam-opt at the top</p>
    <p>Agent: Shim layer added to Apps to enable interaction (estimate , make bids) with Scheduler</p>
    <p>Scheduler: Finish-Time Fair Metric (); Mechanism: SI + PE + SP THEMIS SCHEDULER</p>
    <p>Ask all apps for  estimates</p>
    <p>Offers to subset of apps</p>
    <p>Make Bids</p>
    <p>Receive Allocation</p>
    <p>Give  Estimates</p>
    <p>AGENT</p>
    <p>App1 App2 AppN . . . . .</p>
    <p>Appm</p>
    <p>Res. Alloc. new 0 old</p>
    <p>M1:2G M1:1G,M2:1G old -</p>
    <p>old - 2</p>
    <p>Apps make bids Allocate Winning</p>
    <p>Bids</p>
  </div>
  <div class="page">
    <p>Themis: Implementation</p>
    <p>Hyperparam-opt at the top</p>
    <p>Agent: Shim layer added to Apps to enable interaction with Scheduler</p>
    <p>Scheduler: Finish-Time Fair Metric;</p>
    <p>Mechanism: SI + PE + SP</p>
    <p>THEMIS SCHEDULER</p>
    <p>Ask all apps for  estimates</p>
    <p>Offers to subset of apps</p>
    <p>Make Bids</p>
    <p>Receive Allocation</p>
    <p>Give  Estimates</p>
    <p>AGENT</p>
    <p>App1 App2 AppN . . . . .</p>
    <p>Appm</p>
    <p>Res. Alloc. new 0 old</p>
    <p>M1:2G M1:1G,M2:1G old -</p>
    <p>old - 2</p>
    <p>Apps make bids Allocate Winning</p>
    <p>Bids Submarine AM</p>
    <p>Hadoop 3.2.0 YARN RM</p>
  </div>
  <div class="page">
    <p>Themis: Evaluation</p>
    <p>20 machine, 64 GPU cluster  8 instances each with 2 Tesla K80 GPUs and  12 instances each with 4 Tesla K80 GPUs</p>
    <p>A publicly available trace of DL apps from Microsoft  Baselines:</p>
    <p>Tiresias  Least Attained Service Job First  Optimus  Best Throughput Scaling First  Gandiva  Best Packing Job First  SLAQ  Best Loss Gradient Job First</p>
  </div>
  <div class="page">
    <p>Macrobenchmark: Sharing Incentive</p>
    <p>CDF of  for all apps in the workload</p>
    <p>max  = 1.2 (~1) with Themis</p>
    <p>distribution has long tail without Themis</p>
    <p>No Admission Control max  = 1.2</p>
    <p>Placement Insensitivity hurts!</p>
  </div>
  <div class="page">
    <p>Macrobenchmark: Efficiency</p>
    <p>GPU Time to execute workload</p>
    <p>Themis better than Gandiva</p>
    <p>Auctions enable globally optimal packing</p>
    <p>Greedy-local vs. globally-optimal packing</p>
  </div>
  <div class="page">
    <p>Sensitivity Analysis/Tradeoffs</p>
    <p>max finish-time fair metric () and GPU time for different values of fairness knob (f)</p>
  </div>
  <div class="page">
    <p>Sensitivity Analysis/Tradeoffs</p>
    <p>max finish-time fair metric () and GPU time for different values of fairness knob (f)</p>
    <p>f = 0.8 maximizes sharing incentive without degrading efficiency</p>
    <p>Sub-optimal placement</p>
    <p>More choice; pack better</p>
  </div>
  <div class="page">
    <p>Conclusion</p>
    <p>Consolidation of GPUs =&gt; Sharing Incentive is key</p>
    <p>DL App properties =&gt; existing schedulers violate SI</p>
    <p>Themis proposes a new metric finish-time fairness that captures SI</p>
    <p>Filtering + Partial Allocation Auctions =&gt; Themis performs better than existing schedulers on SI and Efficiency</p>
  </div>
</Presentation>
