<?xml version="1.0" ?>
<Presentation>
  <div class="page">
    <p>Token Tenure: PATCHing Token Counting Using Directory-Based Cache Coherence</p>
    <p>Arun Raghavan, Colin Blundell, Milo Martin University of Pennsylvania</p>
    <p>{arraghav, blundell, milom}@cis.upenn.edu</p>
  </div>
  <div class="page">
    <p>This work licensed under the Creative Commons</p>
    <p>Attribution-Share Alike 3.0 United States License</p>
    <p>You are free:  to Share  to copy, distribute, display, and perform the work  to Remix  to make derivative works</p>
    <p>Under the following conditions:  Attribution. You must attribute the work in the manner specified by the author or</p>
    <p>licensor (but not in any way that suggests that they endorse you or your use of the work).</p>
    <p>Share Alike. If you alter, transform, or build upon this work, you may distribute the resulting work only under the same, similar or a compatible license.</p>
    <p>For any reuse or distribution, you must make clear to others the license terms of this work. The best way to do this is with a link to:</p>
    <p>http://creativecommons.org/licenses/by-sa/3.0/us/  Any of the above conditions can be waived if you get permission from</p>
    <p>the copyright holder.  Apart from the remix rights granted under this license, nothing in this</p>
    <p>license impairs or restricts the author's moral rights.</p>
    <p>[ 2 ]PATCH - Arun Raghavan - MICRO 2008</p>
  </div>
  <div class="page">
    <p>Why Yet Another Coherence Protocol? Fast</p>
    <p>sharing Avoids</p>
    <p>broadcast Scalable</p>
    <p>interconnect</p>
    <p>Snoopy</p>
    <p>Directory  Track sharers</p>
    <p>Token Coherence  Token counting</p>
    <p>Our goal</p>
    <p>This work: combining directory and token counting</p>
    <p>?</p>
  </div>
  <div class="page">
    <p>Overview</p>
    <p>Begin with a standard directory protocol  Fast sharing misses? Direct requests  Ensure safety? Token counting  Broadcast-free forward progress? Token Tenure</p>
    <p>Directory selects one requestor to retain tokens  Requestors give up tokens after a timeout interval</p>
    <p>PATCH: Predictive, Adaptive Token Counting Hybrid  Send request hints directly to predicted sharers  Retain scalability? Lowest-priority, best-effort delivery</p>
    <p>Fast sharing misses, scales as directory</p>
    <p>[ 4 ]PATCH - Arun Raghavan - MICRO 2008</p>
  </div>
  <div class="page">
    <p>Directory Operation</p>
    <p>[ 5 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>P0 P1 P2</p>
    <p>Directory Directory Directory</p>
  </div>
  <div class="page">
    <p>Directory Operation</p>
    <p>[ 6 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>P0 P1 P2</p>
    <p>Sharers: Owner: P0</p>
    <p>M I I</p>
    <p>Directory Directory Directory</p>
  </div>
  <div class="page">
    <p>Directory Operation</p>
    <p>[ 7 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>P0 P1 P2</p>
    <p>Sharers: Owner: P0</p>
    <p>M I I</p>
    <p>Directory</p>
    <p>Store miss</p>
    <p>G e</p>
    <p>tMF w</p>
    <p>d (P</p>
    <p>a cks =</p>
    <p>I Data, acks=1</p>
    <p>M</p>
    <p>U n</p>
    <p>b lo</p>
    <p>ck</p>
  </div>
  <div class="page">
    <p>Directory Operation</p>
    <p>[ 8 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>P0 P1 P2</p>
    <p>Sharers: Owner: P0</p>
    <p>M I I</p>
    <p>Directory</p>
    <p>Store miss</p>
    <p>G e</p>
    <p>tM</p>
    <p>I M</p>
    <p>U n</p>
    <p>b lo</p>
    <p>ck P1</p>
    <p>Data, acks=1</p>
    <p>F w</p>
    <p>d (P</p>
    <p>a cks =</p>
  </div>
  <div class="page">
    <p>Directory with Direct Requests?</p>
    <p>[ 9 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>P0 P1 P2</p>
    <p>Sharers: Owner: P1</p>
    <p>I M I</p>
    <p>Load miss</p>
    <p>G et</p>
    <p>S</p>
    <p>Data O S</p>
    <p>GetS</p>
  </div>
  <div class="page">
    <p>Directory with Direct Requests?</p>
    <p>[ 10 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>P0 P1 P2</p>
    <p>Sharers: Owner: P1</p>
    <p>I M I</p>
    <p>Load miss</p>
    <p>Data O S</p>
    <p>GetS</p>
    <p>Store miss</p>
    <p>G etM</p>
    <p>F w</p>
    <p>d (P</p>
    <p>a ck</p>
    <p>s= 1</p>
    <p>G et</p>
    <p>S</p>
  </div>
  <div class="page">
    <p>Directory with Direct Requests?</p>
    <p>[ 11 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>P0 P1 P2</p>
    <p>Sharers: Owner: P1</p>
    <p>I M I</p>
    <p>Load miss</p>
    <p>Data O S</p>
    <p>GetS</p>
    <p>Store miss</p>
    <p>G etM</p>
    <p>F w</p>
    <p>d (P</p>
    <p>a ck</p>
    <p>s= 1</p>
    <p>Data acks=1</p>
    <p>I</p>
    <p>G et</p>
    <p>S</p>
  </div>
  <div class="page">
    <p>Directory with Direct Requests?</p>
    <p>[ 12 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>P0 P1 P2</p>
    <p>Sharers: Owner: P1</p>
    <p>I M I</p>
    <p>Load miss</p>
    <p>Data O S</p>
    <p>GetS</p>
    <p>Store miss</p>
    <p>G etM</p>
    <p>F w</p>
    <p>d (P</p>
    <p>a ck</p>
    <p>s= 1</p>
    <p>Data acks=1</p>
    <p>M</p>
    <p>Incoherence!!</p>
    <p>G et</p>
    <p>S</p>
    <p>I</p>
    <p>Why? Direct requests break key directory assumption</p>
  </div>
  <div class="page">
    <p>Restoring Coherence</p>
    <p>Coherence invariant: one writer or many readers  Directory: enforces implicitly by distributed algorithm</p>
    <p>Assumes complete state information at the directory</p>
    <p>Alternative: encode permission with token count  Fixed number of tokens per cache block  Need all tokens to write  One or more tokens to read</p>
    <p>Explicitly enforces coherence invariant  Without regard to races, protocol details</p>
    <p>[ 13 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>Token Coherence [ISCA 03]</p>
  </div>
  <div class="page">
    <p>Directory with Direct Requests: Tokens</p>
    <p>[ 14 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>P0 P1 P2</p>
    <p>Sharers: Owner: P1</p>
    <p>Load missGetS</p>
    <p>G et</p>
    <p>S</p>
  </div>
  <div class="page">
    <p>[ 15 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>P0 P1 P2</p>
    <p>Sharers: Owner: P1</p>
    <p>Load missGetS</p>
    <p>G et</p>
    <p>S</p>
    <p>Data</p>
    <p>Directory with Direct Requests: Tokens</p>
  </div>
  <div class="page">
    <p>[ 16 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>P0 P1 P2</p>
    <p>Sharers: Owner: P1</p>
    <p>Load missGetS</p>
    <p>G et</p>
    <p>S</p>
    <p>Data</p>
    <p>Store miss</p>
    <p>G etM</p>
    <p>F w</p>
    <p>d (P</p>
    <p>Directory with Direct Requests: Tokens</p>
  </div>
  <div class="page">
    <p>[ 17 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>P0 P1 P2</p>
    <p>Sharers: Owner: P1</p>
    <p>Load missGetS</p>
    <p>G et</p>
    <p>S</p>
    <p>Data</p>
    <p>Store miss</p>
    <p>G etM</p>
    <p>Data</p>
    <p>Directory with Direct Requests: Tokens</p>
    <p>F w</p>
    <p>d (P</p>
  </div>
  <div class="page">
    <p>[ 18 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>P0 P1 P2</p>
    <p>Sharers: Owner: P1</p>
    <p>Load missGetS</p>
    <p>G et</p>
    <p>S</p>
    <p>Data</p>
    <p>Store miss</p>
    <p>G etM</p>
    <p>Data</p>
    <p>Directory with Direct Requests: Tokens</p>
    <p>F w</p>
    <p>d (P</p>
  </div>
  <div class="page">
    <p>[ 19 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>P0 P1 P2</p>
    <p>Sharers: Owner: P1</p>
    <p>Load missGetS</p>
    <p>G et</p>
    <p>S</p>
    <p>Data</p>
    <p>Store miss</p>
    <p>G etM</p>
    <p>Data</p>
    <p>Directory with Direct Requests: Tokens</p>
    <p>F w</p>
    <p>d (P</p>
  </div>
  <div class="page">
    <p>[ 20 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>P0 P1 P2</p>
    <p>Sharers: Owner: P1</p>
    <p>Load miss</p>
    <p>Store miss</p>
    <p>P0 Starves</p>
    <p>Directory with Direct Requests: Tokens</p>
    <p>G et</p>
    <p>S</p>
  </div>
  <div class="page">
    <p>[ 21 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>P0 P1 P2</p>
    <p>Sharers: Owner: P1</p>
    <p>Load miss</p>
    <p>Store miss</p>
    <p>Token Coherence Solution: Persistent Requests</p>
    <p>G et</p>
    <p>S</p>
    <p>Persistent Request</p>
    <p>Broadcast Table at each processor</p>
    <p>N2 state</p>
  </div>
  <div class="page">
    <p>[ 22 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>P0 P1 P2</p>
    <p>Sharers: Owner: P1</p>
    <p>Load miss</p>
    <p>Store miss</p>
    <p>P0s request reached directory first  Directory declares P0 winner</p>
    <p>Our Solution</p>
    <p>G et</p>
    <p>S W</p>
    <p>inner</p>
    <p>P2 non-winner  Inferred after timeout</p>
    <p>Timeout</p>
    <p>Directory forwards to P0</p>
  </div>
  <div class="page">
    <p>Token Tenure</p>
    <p>[ 23 ]PATCH - Arun Raghavan - MICRO 2008</p>
  </div>
  <div class="page">
    <p>Token Tenure</p>
    <p>Tokens can be tenured or untenured  Tokens by default untenured  Untenured tokens must be sent to the directory   unless tenured within timeout window</p>
    <p>Active (winner) requestors tenure tokens  Directory activates one request at a time  Directory explicitly informs active requestor</p>
    <p>Multiple processors can hold tenured tokens</p>
    <p>Why does this ensure forward progress?</p>
    <p>[ 24 ]PATCH - Arun Raghavan - MICRO 2008</p>
  </div>
  <div class="page">
    <p>Flow of Tokens to Active Requestor</p>
    <p>[ 25 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>Timeout</p>
    <p>Bounce</p>
    <p>Forwarded request</p>
    <p>Racing Request</p>
    <p>Active</p>
    <p>Directory</p>
    <p>Untenured</p>
    <p>Tenured</p>
    <p>Direct request</p>
    <p>Restore directorys ability to</p>
    <p>resolve races</p>
    <p>Implementation: add timeout</p>
  </div>
  <div class="page">
    <p>Token Tenure: Implementation</p>
    <p>No common-case performance impact</p>
    <p>Activation off critical path of miss  Token count still determines permissions</p>
    <p>No additional traffic  Activation piggybacked on forwarded messages</p>
    <p>Set timeout to twice average roundtrip latency  Avoid early timeout.  but minimize slowing down winner in races</p>
    <p>[ 26 ]PATCH - Arun Raghavan - MICRO 2008</p>
  </div>
  <div class="page">
    <p>Using Direct Requests  Direct requests to no, some or all processors</p>
    <p>[ 27 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>Directory PATCH-NoDirect PATCH-Owner Broad.-If-Shared PATCH-Broadcast</p>
    <p>Direct requests improve performance</p>
    <p>But at what cost?</p>
    <p>jbb oltp apache barnes ocean</p>
    <p>n o</p>
    <p>rm a</p>
    <p>li z e</p>
    <p>d r</p>
    <p>u n</p>
    <p>ti m</p>
    <p>e</p>
    <p>Average 14%</p>
    <p>Dest. Set Prediction [ISCA 03]</p>
  </div>
  <div class="page">
    <p>Direct Requests: Runtime and Traffic</p>
    <p>[ 28 ]PATCH - Arun Raghavan - MICRO 2008</p>
    <p>Directory PATCH-NoDirect PATCH-Owner Broad.-If-Shared PATCH-Broadcast</p>
    <p>n o</p>
    <p>rm a</p>
    <p>li z e</p>
    <p>d r</p>
    <p>u n</p>
    <p>ti m</p>
    <p>e</p>
    <p>n o</p>
    <p>rm a</p>
    <p>li z e</p>
    <p>d t</p>
    <p>ra ff</p>
    <p>ic</p>
    <p>jbb oltp apache barnes ocean</p>
    <p>PATCH-NoDirect and Directory have identical traffic</p>
    <p>PATCH-Broadcast has &gt;100% overhead</p>
    <p>Runtime</p>
    <p>Traffic</p>
  </div>
  <div class="page">
    <p>Best-Effort Direct Requests</p>
    <p>Direct requests in PATCH 1. Strictly in addition to directory requests</p>
    <p>direct requests can be dropped arbitrarily  Best-effort delivery</p>
    <p>Lowest priority, deliver strictly on do-no-harm-basis  If queued up too long in switches, controller: drop</p>
    <p>lower-bound: PATCH-NoDirect performance</p>
    <p>Adequate bandwidth? drop no requests  Scarce bandwidth? drop all requests</p>
    <p>Never worse than directory [ 29 ]PATCH - Arun Raghavan - MICRO 2008</p>
  </div>
  <div class="page">
    <p>Best-Effort Direct Requests</p>
    <p>microbenchmark-2B/cycle</p>
    <p>n o</p>
    <p>rm a</p>
    <p>li z e</p>
    <p>d r</p>
    <p>u n</p>
    <p>ti m</p>
    <p>e</p>
    <p>number of processors</p>
    <p>Broadcast performance with plentiful bandwidth</p>
    <p>Converges with directory performance at 512</p>
    <p>Adapt dynamically; one-size-fits-all</p>
    <p>Better than bo</p>
    <p>th</p>
    <p>[ 30 ]PATCH - Arun Raghavan - MICRO 2008</p>
  </div>
  <div class="page">
    <p>Enhancing Directory Scalability</p>
    <p>[ 31 ]PATCH - Arun Raghavan - MICRO 2008</p>
  </div>
  <div class="page">
    <p>Enhancing Directory Scalability</p>
    <p>Req</p>
    <p>I IS S</p>
    <p>Directory</p>
    <p>Forward</p>
    <p>Ack</p>
    <p>Directory</p>
    <p>[ 32 ]PATCH - Arun Raghavan - MICRO 2008</p>
  </div>
  <div class="page">
    <p>Enhancing Directory Scalability</p>
    <p>Coarse directories: 1-bit for k sharers  Fan-out delivery of forwards: worst case O(N) traffic  Requires acks from non-sharers too</p>
    <p>Multiple unicast messages (no ack combining)  Worst case O(NN) on 2D torus interconnect</p>
    <p>Req</p>
    <p>I IS S</p>
    <p>Directory</p>
    <p>Forward</p>
    <p>Ack</p>
    <p>Directory-coarse</p>
    <p>[ 33 ]PATCH - Arun Raghavan - MICRO 2008</p>
  </div>
  <div class="page">
    <p>Enhancing Directory Scalability</p>
    <p>With PATCH only token holders need respond  Avoid unnecessary acknowledgements</p>
    <p>When # of sharers small, prevents ack from dominating</p>
    <p>Even more scalable than directory</p>
    <p>Req</p>
    <p>I IS S</p>
    <p>Directory</p>
    <p>Forward</p>
    <p>Ack Req</p>
    <p>Directory</p>
    <p>Forward</p>
    <p>Directory-coarse PATCH-coarse</p>
    <p>[ 34 ]PATCH - Arun Raghavan - MICRO 2008</p>
  </div>
  <div class="page">
    <p>PATCH has high tolerance to inexactness</p>
    <p>n o</p>
    <p>rm a</p>
    <p>li z e</p>
    <p>d</p>
    <p>tr a</p>
    <p>ff ic</p>
    <p>Directory PATCH</p>
    <p>Runtime comparison, 2B/cycle</p>
    <p>n o</p>
    <p>rm a</p>
    <p>li z e</p>
    <p>d</p>
    <p>ru n</p>
    <p>ti m</p>
    <p>e 142 %</p>
    <p>microbenchmark @ 256 processors</p>
    <p>Coarse Directory: Runtime and Traffic</p>
    <p>[ 35 ]PATCH - Arun Raghavan - MICRO 2008</p>
  </div>
  <div class="page">
    <p>Related Work  Token counting</p>
    <p>Token Coherence [Martin+, ISCA 03]  Priority Requests [Cuesta+, PDP 07]  Virtual Hierarchies [Marty+, ISCA 07]  Ring Order [Marty+, MICRO 06]</p>
    <p>Predictive direct requests  Multicast snooping [Bilir+, ISCA 99]  Owner Prediction [Acacio+, SC 02]  Producer-Consumer sharing [Cheng+, HPCA 07]  Virtual Circuit Tree Multicast [Jerger+, ISCA 08]</p>
    <p>Bandwidth Adaptive Snooping [Martin+, HPCA 02]  Embedded ring snooping</p>
    <p>Uncorq [Strauss+, MICRO 07]</p>
    <p>[ 36 ]PATCH - Arun Raghavan - MICRO 2008</p>
  </div>
  <div class="page">
    <p>Conclusion</p>
    <p>PATCH  Directory protocol foundation  Fast sharing? Direct requests  Safety? Token counting  Forward progress? Token tenure</p>
    <p>Broadcast-free  Retain scaling of directory? Best-effort delivery</p>
    <p>Resulting properties  One-size-fits-all  Opportunistically uses bandwidth for performance  Yet scales no worse than directory</p>
    <p>[ 37 ]PATCH - Arun Raghavan - MICRO 2008</p>
  </div>
  <div class="page"/>
</Presentation>
